<!DOCTYPE html>

<html>
<head>
  <title>can.jquery-all.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="can.construct.proxy.html">
                can.construct.proxy.js
              </a>
            
              
              <a class="source" href="can.construct.super.html">
                can.construct.super.js
              </a>
            
              
              <a class="source" href="can.control.plugin.html">
                can.control.plugin.js
              </a>
            
              
              <a class="source" href="can.dojo.html">
                can.dojo.js
              </a>
            
              
              <a class="source" href="can.fixture.html">
                can.fixture.js
              </a>
            
              
              <a class="source" href="can.jquery-all.html">
                can.jquery-all.js
              </a>
            
              
              <a class="source" href="can.jquery.html">
                can.jquery.js
              </a>
            
              
              <a class="source" href="can.model.queue.html">
                can.model.queue.js
              </a>
            
              
              <a class="source" href="can.mootools.html">
                can.mootools.js
              </a>
            
              
              <a class="source" href="can.observe.attributes.html">
                can.observe.attributes.js
              </a>
            
              
              <a class="source" href="can.observe.backup.html">
                can.observe.backup.js
              </a>
            
              
              <a class="source" href="can.observe.delegate.html">
                can.observe.delegate.js
              </a>
            
              
              <a class="source" href="can.observe.setter.html">
                can.observe.setter.js
              </a>
            
              
              <a class="source" href="can.observe.validations.html">
                can.observe.validations.js
              </a>
            
              
              <a class="source" href="can.view.modifiers.html">
                can.view.modifiers.js
              </a>
            
              
              <a class="source" href="can.view.mustache.html">
                can.view.mustache.js
              </a>
            
              
              <a class="source" href="can.yui.html">
                can.yui.js
              </a>
            
              
              <a class="source" href="can.zepto.html">
                can.zepto.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>can.jquery-all.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/*!
* CanJS - 1.1.5 (2013-03-27)
* http://canjs.us/
* Copyright (c) 2013 Bitovi
* Licensed MIT
*/</span>
module = {
    _orig: window.module,
    _define: window.define
};
module[<span class="string">'jquery'</span>] = jQuery;
module[<span class="string">'jquery/jquery.js'</span>] = jQuery;
define = <span class="function"><span class="keyword">function</span> <span class="params">(id, deps, value)</span> {</span>
    module[id] = value();
};
define.amd = {
    jQuery: <span class="literal">true</span>
};</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2>can/util/can.js</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>module[<span class="string">'can/util/can.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>

    <span class="keyword">var</span> can = window.can || {};
    <span class="keyword">if</span> (<span class="keyword">typeof</span> GLOBALCAN === <span class="string">'undefined'</span> || GLOBALCAN !== <span class="literal">false</span>) {
        window.can = can;
    }

    can.isDeferred = <span class="function"><span class="keyword">function</span> <span class="params">(obj)</span> {</span>
        <span class="keyword">var</span> isFunction = <span class="keyword">this</span>.isFunction;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Returns <code>true</code> if something looks like a deferred.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> obj &amp;&amp; isFunction(obj.then) &amp;&amp; isFunction(obj.pipe);
    };

    <span class="keyword">var</span> cid = <span class="number">0</span>;
    can.cid = <span class="function"><span class="keyword">function</span> <span class="params">(object, name)</span> {</span>
        <span class="keyword">if</span> (object._cid) {
            <span class="keyword">return</span> object._cid
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> object._cid = (name || <span class="string">""</span>) + (++cid)
        }
    }
    <span class="keyword">return</span> can;
})(); <span class="comment">// ## can/util/array/each.js</span>
module[<span class="string">'can/util/array/each.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span>
    can.each = <span class="function"><span class="keyword">function</span> <span class="params">(elements, callback, context)</span> {</span>
        <span class="keyword">var</span> i = <span class="number">0</span>,
            key;
        <span class="keyword">if</span> (elements) {
            <span class="keyword">if</span> (<span class="keyword">typeof</span> elements.length === <span class="string">'number'</span> &amp;&amp; elements.pop) {
                <span class="keyword">if</span> (elements.attr) {
                    elements.attr(<span class="string">'length'</span>);
                }
                <span class="keyword">for</span> (key = elements.length; i &lt; key; i++) {
                    <span class="keyword">if</span> (callback.call(context || elements[i], elements[i], i, elements) === <span class="literal">false</span>) {
                        <span class="keyword">break</span>;
                    }
                }
            } <span class="keyword">else</span> <span class="keyword">if</span> (elements.hasOwnProperty) {
                <span class="keyword">for</span> (key <span class="keyword">in</span> elements) {
                    <span class="keyword">if</span> (elements.hasOwnProperty(key)) {
                        <span class="keyword">if</span> (callback.call(context || elements[key], elements[key], key, elements) === <span class="literal">false</span>) {
                            <span class="keyword">break</span>;
                        }
                    }
                }
            }
        }
        <span class="keyword">return</span> elements;
    };

    <span class="keyword">return</span> can;
})(module[<span class="string">"can/util/can.js"</span>]); <span class="comment">// ## can/util/jquery/jquery.js</span>
module[<span class="string">'can/util/jquery/jquery.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">($, can)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><em>jQuery node list.</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $.extend(can, $, {
        trigger: <span class="function"><span class="keyword">function</span> <span class="params">(obj, event, args)</span> {</span>
            <span class="keyword">if</span> (obj.trigger) {
                obj.trigger(event, args);
            } <span class="keyword">else</span> {
                $.event.trigger(event, args, obj, <span class="literal">true</span>);
            }
        },
        addEvent: <span class="function"><span class="keyword">function</span> <span class="params">(ev, cb)</span> {</span>
            $([<span class="keyword">this</span>]).bind(ev, cb);
            <span class="keyword">return</span> <span class="keyword">this</span>;
        },
        removeEvent: <span class="function"><span class="keyword">function</span> <span class="params">(ev, cb)</span> {</span>
            $([<span class="keyword">this</span>]).unbind(ev, cb);
            <span class="keyword">return</span> <span class="keyword">this</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>jquery caches fragments, we always needs a new one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        buildFragment: <span class="function"><span class="keyword">function</span> <span class="params">(elems, context)</span> {</span>
            <span class="keyword">var</span> oldFragment = $.buildFragment,
                ret;

            elems = [elems];</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Set context per 1.8 logic</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            context = context || document;
            context = !context.nodeType &amp;&amp; context[<span class="number">0</span>] || context;
            context = context.ownerDocument || context;

            ret = oldFragment.call(jQuery, elems, context);

            <span class="keyword">return</span> ret.cacheable ? $.clone(ret.fragment) : ret.fragment || ret;
        },
        $: $,
        each: can.each
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Wrap binding functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $.each([<span class="string">'bind'</span>, <span class="string">'unbind'</span>, <span class="string">'undelegate'</span>, <span class="string">'delegate'</span>], <span class="function"><span class="keyword">function</span> <span class="params">(i, func)</span> {</span>
        can[func] = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">var</span> t = <span class="keyword">this</span>[func] ? <span class="keyword">this</span> : $([<span class="keyword">this</span>]);
            t[func].apply(t, arguments);
            <span class="keyword">return</span> <span class="keyword">this</span>;
        };
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Wrap modifier functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $.each([<span class="string">"append"</span>, <span class="string">"filter"</span>, <span class="string">"addClass"</span>, <span class="string">"remove"</span>, <span class="string">"data"</span>, <span class="string">"get"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(i, name)</span> {</span>
        can[name] = <span class="function"><span class="keyword">function</span> <span class="params">(wrapped)</span> {</span>
            <span class="keyword">return</span> wrapped[name].apply(wrapped, can.makeArray(arguments).slice(<span class="number">1</span>));
        };
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Memory safe destruction.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> oldClean = $.cleanData;

    $.cleanData = <span class="function"><span class="keyword">function</span> <span class="params">(elems)</span> {</span>
        $.each(elems, <span class="function"><span class="keyword">function</span> <span class="params">(i, elem)</span> {</span>
            <span class="keyword">if</span> (elem) {
                can.trigger(elem, <span class="string">"destroyed"</span>, [], <span class="literal">false</span>);
            }
        });
        oldClean(elems);
    };

    <span class="keyword">return</span> can;
})(module[<span class="string">"jquery/jquery.js"</span>], module[<span class="string">"can/util/can.js"</span>], module[<span class="string">"can/util/array/each.js"</span>]); <span class="comment">// ## can/util/string/string.js</span>
module[<span class="string">'can/util/string/string.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2>string.js</h2>
<p><em>Miscellaneous string utility functions.</em><br>Several of the methods in this plugin use code adapated from Prototype
Prototype JavaScript framework, version 1.6.0.1.
Â© 2005-2007 Sam Stephenson</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> strUndHash = <span class="regexp">/_|-/</span>,
        strColons = <span class="regexp">/\=\=/</span>,
        strWords = <span class="regexp">/([A-Z]+)([A-Z][a-z])/g</span>,
        strLowUp = <span class="regexp">/([a-z\d])([A-Z])/g</span>,
        strDash = <span class="regexp">/([a-z\d])([A-Z])/g</span>,
        strReplacer = <span class="regexp">/\{([^\}]+)\}/g</span>,
        strQuote = <span class="regexp">/"/g</span>,
        strSingleQuote = <span class="regexp">/'/g</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Returns the <code>prop</code> property from <code>obj</code>.
If <code>add</code> is true and <code>prop</code> doesn&#39;t exist in <code>obj</code>, create it as an 
empty object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        getNext = <span class="function"><span class="keyword">function</span> <span class="params">(obj, prop, add)</span> {</span>
            <span class="keyword">return</span> prop <span class="keyword">in</span> obj ? obj[prop] : (add &amp;&amp; (obj[prop] = {}));
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Returns <code>true</code> if the object can have properties (no <code>null</code>s).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        isContainer = <span class="function"><span class="keyword">function</span> <span class="params">(current)</span> {</span>
            <span class="keyword">return</span> (<span class="regexp">/^f|^o/</span>).test(<span class="keyword">typeof</span> current);
        };

    can.extend(can, {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Escapes strings for HTML.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        esc: <span class="function"><span class="keyword">function</span> <span class="params">(content)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Convert bad values into empty strings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> isInvalid = content === <span class="literal">null</span> || content === <span class="literal">undefined</span> || (isNaN(content) &amp;&amp; (<span class="string">""</span> + content === <span class="string">'NaN'</span>));
            <span class="keyword">return</span> (<span class="string">""</span> + (isInvalid ? <span class="string">''</span> : content)).replace(<span class="regexp">/&amp;/g</span>, <span class="string">'&amp;amp;'</span>).replace(<span class="regexp">/&lt;/g</span>, <span class="string">'&amp;lt;'</span>).replace(<span class="regexp">/&gt;/g</span>, <span class="string">'&amp;gt;'</span>).replace(strQuote, <span class="string">'&amp;#34;'</span>).replace(strSingleQuote, <span class="string">"&amp;#39;"</span>);
        },


        getObject: <span class="function"><span class="keyword">function</span> <span class="params">(name, roots, add)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>The parts of the name we are looking up<br><code>[&#39;App&#39;,&#39;Models&#39;,&#39;Recipe&#39;]</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> parts = name ? name.split(<span class="string">'.'</span>) : [],
                length = parts.length,
                current, r = <span class="number">0</span>,
                ret, i;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Make sure roots is an <code>array</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            roots = can.isArray(roots) ? roots : [roots || window];

            <span class="keyword">if</span> (!length) {
                <span class="keyword">return</span> roots[<span class="number">0</span>];
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>For each root, mark it as current.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">while</span> (roots[r]) {
                current = roots[r];</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Walk current to the 2nd to last object or until there 
is not a container.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length - <span class="number">1</span> &amp;&amp; isContainer(current); i++) {
                    current = getNext(current, parts[i], add);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>If we can get a property from the 2nd to last object...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (isContainer(current)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Get (and possibly set) the property.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    ret = getNext(current, parts[i], add);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>If there is a value, we exit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (ret !== <span class="literal">undefined</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>If <code>add</code> is <code>false</code>, delete the property</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (add === <span class="literal">false</span>) {
                            <span class="keyword">delete</span> current[parts[i]];
                        }
                        <span class="keyword">return</span> ret;

                    }
                }
                r++;
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Capitalizes a string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        capitalize: <span class="function"><span class="keyword">function</span> <span class="params">(s, cache)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Used to make newId.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> s.charAt(<span class="number">0</span>).toUpperCase() + s.slice(<span class="number">1</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Underscores a string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        underscore: <span class="function"><span class="keyword">function</span> <span class="params">(s)</span> {</span>
            <span class="keyword">return</span> s.replace(strColons, <span class="string">'/'</span>).replace(strWords, <span class="string">'$1_$2'</span>).replace(strLowUp, <span class="string">'$1_$2'</span>).replace(strDash, <span class="string">'_'</span>).toLowerCase();
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Micro-templating.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        sub: <span class="function"><span class="keyword">function</span> <span class="params">(str, data, remove)</span> {</span>
            <span class="keyword">var</span> obs = [];

            obs.push(str.replace(strReplacer, <span class="function"><span class="keyword">function</span> <span class="params">(whole, inside)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Convert inside to type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> ob = can.getObject(inside, data, remove === <span class="literal">undefined</span> ? remove : !remove);

                <span class="keyword">if</span> (ob === <span class="literal">undefined</span>) {
                    obs = <span class="literal">null</span>;
                    <span class="keyword">return</span> <span class="string">""</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>If a container, push into objs (which will return objects found).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (isContainer(ob) &amp;&amp; obs) {
                    obs.push(ob);
                    <span class="keyword">return</span> <span class="string">""</span>;
                }

                <span class="keyword">return</span> <span class="string">""</span> + ob;
            }));

            <span class="keyword">return</span> obs === <span class="literal">null</span> ? obs : (obs.length &lt;= <span class="number">1</span> ? obs[<span class="number">0</span>] : obs);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>These regex&#39;s are used throughout the rest of can, so let&#39;s make
them available.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        replacer: strReplacer,
        undHash: strUndHash
    });
    <span class="keyword">return</span> can;
})(module[<span class="string">"can/util/jquery/jquery.js"</span>]); <span class="comment">// ## can/construct/construct.js</span>
module[<span class="string">'can/construct/construct.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h2>construct.js</h2>
<p><code>can.Construct</code><br><em>This is a modified version of
<a href="http://ejohn.org/blog/simple-javascript-inheritance/">John Resig&#39;s class</a>.<br>It provides class level inheritance and callbacks.</em>
A private flag used to initialize a new class instance without
initializing it&#39;s bindings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> initializing = <span class="number">0</span>;


    can.Construct = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">if</span> (arguments.length) {
            <span class="keyword">return</span> can.Construct.extend.apply(can.Construct, arguments);
        }
    };


    can.extend(can.Construct, {

        newInstance: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Get a raw instance object (<code>init</code> is not called).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> inst = <span class="keyword">this</span>.instance(),
                arg = arguments,
                args;</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Call <code>setup</code> if there is a <code>setup</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (inst.setup) {
                args = inst.setup.apply(inst, arguments);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Call <code>init</code> if there is an <code>init</code><br>If <code>setup</code> returned <code>args</code>, use those as the arguments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (inst.init) {
                inst.init.apply(inst, args || arguments);
            }

            <span class="keyword">return</span> inst;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Overwrites an object with methods. Used in the <code>super</code> plugin.
<code>newProps</code> - New properties to add.<br><code>oldProps</code> - Where the old properties might be (used with <code>super</code>).<br><code>addTo</code> - What we are adding to.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _inherit: <span class="function"><span class="keyword">function</span> <span class="params">(newProps, oldProps, addTo)</span> {</span>
            can.extend(addTo || newProps, newProps || {})
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>used for overwriting a single property.
this should be used for patching other objects
the super plugin overwrites this</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _overwrite: <span class="function"><span class="keyword">function</span> <span class="params">(what, oldProps, propName, val)</span> {</span>
            what[propName] = val;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Set <code>defaults</code> as the merger of the parent <code>defaults</code> and this 
object&#39;s <code>defaults</code>. If you overwrite this method, make sure to
include option merging logic.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        setup: <span class="function"><span class="keyword">function</span> <span class="params">(base, fullName)</span> {</span>
            <span class="keyword">this</span>.defaults = can.extend(<span class="literal">true</span>, {}, base.defaults, <span class="keyword">this</span>.defaults);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Create&#39;s a new <code>class</code> instance without initializing by setting the
<code>initializing</code> flag.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        instance: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Prevents running <code>init</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            initializing = <span class="number">1</span>;

            <span class="keyword">var</span> inst = <span class="keyword">new</span> <span class="keyword">this</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Allow running <code>init</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            initializing = <span class="number">0</span>;

            <span class="keyword">return</span> inst;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Extends classes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        extend: <span class="function"><span class="keyword">function</span> <span class="params">(fullName, klass, proto)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Figure out what was passed and normalize it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="keyword">typeof</span> fullName != <span class="string">'string'</span>) {
                proto = klass;
                klass = fullName;
                fullName = <span class="literal">null</span>;
            }

            <span class="keyword">if</span> (!proto) {
                proto = klass;
                klass = <span class="literal">null</span>;
            }
            proto = proto || {};

            <span class="keyword">var</span> _super_class = <span class="keyword">this</span>,
                _super = <span class="keyword">this</span>.prototype,
                name, shortName, namespace, prototype;</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Instantiate a base class (but only create the instance,
don&#39;t run the init constructor).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            prototype = <span class="keyword">this</span>.instance();</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Copy the properties over onto the new prototype.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            can.Construct._inherit(proto, _super, prototype);</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>The dummy class constructor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="function"><span class="keyword">function</span> <span class="title">Constructor</span><span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>All construction is actually done in the init method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (!initializing) {
                    <span class="keyword">return</span> <span class="keyword">this</span>.constructor !== Constructor &amp;&amp; arguments.length ?</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>We are being called without <code>new</code> or we are extending.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    arguments.callee.extend.apply(arguments.callee, arguments) :</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>We are being called with <code>new</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">this</span>.constructor.newInstance.apply(<span class="keyword">this</span>.constructor, arguments);
                }
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Copy old stuff onto class (can probably be merged w/ inherit)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">for</span> (name <span class="keyword">in</span> _super_class) {
                <span class="keyword">if</span> (_super_class.hasOwnProperty(name)) {
                    Constructor[name] = _super_class[name];
                }
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Copy new static properties on class.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            can.Construct._inherit(klass, _super_class, Constructor);</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Setup namespaces.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (fullName) {

                <span class="keyword">var</span> parts = fullName.split(<span class="string">'.'</span>),
                    shortName = parts.pop(),
                    current = can.getObject(parts.join(<span class="string">'.'</span>), window, <span class="literal">true</span>),
                    namespace = current,
                    _fullName = can.underscore(fullName.replace(<span class="regexp">/\./g</span>, <span class="string">"_"</span>)),
                    _shortName = can.underscore(shortName);



                current[shortName] = Constructor;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Set things that shouldn&#39;t be overwritten.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            can.extend(Constructor, {
                constructor: Constructor,
                prototype: prototype,

                namespace: namespace,

                shortName: shortName,
                _shortName: _shortName,

                fullName: fullName,
                _fullName: _fullName
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Make sure our prototype looks nice.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Constructor.prototype.constructor = Constructor;</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Call the class <code>setup</code> and <code>init</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> t = [_super_class].concat(can.makeArray(arguments)),
                args = Constructor.setup.apply(Constructor, t);

            <span class="keyword">if</span> (Constructor.init) {
                Constructor.init.apply(Constructor, args || t);
            }


            <span class="keyword">return</span> Constructor;

        }

    });
    <span class="keyword">return</span> can.Construct;
})(module[<span class="string">"can/util/string/string.js"</span>]); <span class="comment">// ## can/construct/proxy/proxy.js</span>
module[<span class="string">'can/construct/proxy/proxy.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can, Construct)</span> {</span>
    <span class="keyword">var</span> isFunction = can.isFunction,
        isArray = can.isArray,
        makeArray = can.makeArray,

        proxy = <span class="function"><span class="keyword">function</span> <span class="params">(funcs)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>args that should be curried</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> args = makeArray(arguments),
                self;</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>get the functions to callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            funcs = args.shift();</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>if there is only one function, make funcs into an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (!isArray(funcs)) {
                funcs = [funcs];
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>keep a reference to us in self</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            self = <span class="keyword">this</span>;


            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">class_cb</span><span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>add the arguments after the curried args</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> cur = args.concat(makeArray(arguments)),
                    isString, length = funcs.length,
                    f = <span class="number">0</span>,
                    func;</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>go through each function to call back</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">for</span> (; f &lt; length; f++) {
                    func = funcs[f];
                    <span class="keyword">if</span> (!func) {
                        <span class="keyword">continue</span>;
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>set called with the name of the function on self (this is how this.view works)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    isString = <span class="keyword">typeof</span> func == <span class="string">"string"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>call the function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    cur = (isString ? self[func] : func).apply(self, cur || []);</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>pass the result to the next function (if there is a next function)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (f &lt; length - <span class="number">1</span>) {
                        cur = !isArray(cur) || cur._use_call ? [cur] : cur
                    }
                }
                <span class="keyword">return</span> cur;
            }
        }
        can.Construct.proxy = can.Construct.prototype.proxy = proxy;</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>this corrects the case where can/control loads after can/construct/proxy, so static props don&#39;t have proxy</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> correctedClasses = [can.Observe, can.Control, can.Model],
        i = <span class="number">0</span>;
    <span class="keyword">for</span> (; i &lt; correctedClasses.length; i++) {
        <span class="keyword">if</span> (correctedClasses[i]) {
            correctedClasses[i].proxy = proxy;
        }
    }
    <span class="keyword">return</span> can;
})(module[<span class="string">"can/util/jquery/jquery.js"</span>], module[<span class="string">"can/construct/construct.js"</span>]); <span class="comment">// ## can/construct/super/super.js</span>
module[<span class="string">'can/construct/super/super.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can, Construct)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>tests if we can get super in .toString()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> isFunction = can.isFunction,

        fnTest = <span class="regexp">/xyz/</span>.test(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            xyz;
        }) ? <span class="regexp">/\b_super\b/</span> : <span class="regexp">/.*/</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>overwrites a single property so it can still call super</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    can.Construct._overwrite = <span class="function"><span class="keyword">function</span> <span class="params">(addTo, base, name, val)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Check if we&#39;re overwriting an existing function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        addTo[name] = isFunction(val) &amp;&amp; isFunction(base[name]) &amp;&amp; fnTest.test(val) ? (<span class="function"><span class="keyword">function</span> <span class="params">(name, fn)</span> {</span>
            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                <span class="keyword">var</span> tmp = <span class="keyword">this</span>._super,
                    ret;</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Add a new ._super() method that is the same method
but on the super-class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">this</span>._super = base[name];</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>The method only need to be bound temporarily, so we
remove it when we&#39;re done executing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                ret = fn.apply(<span class="keyword">this</span>, arguments);
                <span class="keyword">this</span>._super = tmp;
                <span class="keyword">return</span> ret;
            };
        })(name, val) : val;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>overwrites an object with methods, sets up _super
  newProps - new properties
  oldProps - where the old properties might be
  addTo - what we are adding to</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    can.Construct._inherit = <span class="function"><span class="keyword">function</span> <span class="params">(newProps, oldProps, addTo)</span> {</span>
        addTo = addTo || newProps
        <span class="keyword">for</span> (<span class="keyword">var</span> name <span class="keyword">in</span> newProps) {
            can.Construct._overwrite(addTo, oldProps, name, newProps[name]);
        }
    }

    <span class="keyword">return</span> can;
})(module[<span class="string">"can/util/jquery/jquery.js"</span>], module[<span class="string">"can/construct/construct.js"</span>]); <span class="comment">// ## can/control/control.js</span>
module[<span class="string">'can/control/control.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <h2>control.js</h2>
<p><code>can.Control</code><br><em>Controller</em>
Binds an element, returns a function that unbinds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> bind = <span class="function"><span class="keyword">function</span> <span class="params">(el, ev, callback)</span> {</span>

        can.bind.call(el, ev, callback);

        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            can.unbind.call(el, ev, callback);
        };
    },
        isFunction = can.isFunction,
        extend = can.extend,
        each = can.each,
        slice = [].slice,
        paramReplacer = <span class="regexp">/\{([^\}]+)\}/g</span>,
        special = can.getObject(<span class="string">"$.event.special"</span>, [can]) || {},</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Binds an element, returns a function that unbinds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        delegate = <span class="function"><span class="keyword">function</span> <span class="params">(el, selector, ev, callback)</span> {</span>
            can.delegate.call(el, selector, ev, callback);
            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                can.undelegate.call(el, selector, ev, callback);
            };
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Calls bind or unbind depending if there is a selector.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        binder = <span class="function"><span class="keyword">function</span> <span class="params">(el, ev, callback, selector)</span> {</span>
            <span class="keyword">return</span> selector ? delegate(el, can.trim(selector), ev, callback) : bind(el, ev, callback);
        },

        basicProcessor;


    <span class="keyword">var</span> Control = can.Control = can.Construct(

    {</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Setup pre-processes which methods are event listeners.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        setup: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Allow contollers to inherit &quot;defaults&quot; from super-classes as it 
done in <code>can.Construct</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            can.Construct.setup.apply(<span class="keyword">this</span>, arguments);</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>If you didn&#39;t provide a name, or are <code>control</code>, don&#39;t do anything.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (can.Control) {</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Cache the underscored names.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> control = <span class="keyword">this</span>,
                    funcName;</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Calculate and cache actions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                control.actions = {};
                <span class="keyword">for</span> (funcName <span class="keyword">in</span> control.prototype) {
                    <span class="keyword">if</span> (control._isAction(funcName)) {
                        control.actions[funcName] = control._action(funcName);
                    }
                }
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Moves <code>this</code> to the first argument, wraps it with <code>jQuery</code> if it&#39;s an element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _shifter: <span class="function"><span class="keyword">function</span> <span class="params">(context, name)</span> {</span>

            <span class="keyword">var</span> method = <span class="keyword">typeof</span> name == <span class="string">"string"</span> ? context[name] : name;

            <span class="keyword">if</span> (!isFunction(method)) {
                method = context[method];
            }

            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                context.called = name;
                <span class="keyword">return</span> method.apply(context, [<span class="keyword">this</span>.nodeName ? can.$(<span class="keyword">this</span>) : <span class="keyword">this</span>].concat(slice.call(arguments, <span class="number">0</span>)));
            };
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Return <code>true</code> if is an action.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _isAction: <span class="function"><span class="keyword">function</span> <span class="params">(methodName)</span> {</span>

            <span class="keyword">var</span> val = <span class="keyword">this</span>.prototype[methodName],
                type = <span class="keyword">typeof</span> val;</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>if not the constructor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> (methodName !== <span class="string">'constructor'</span>) &amp;&amp;</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>and is a function or links to a function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            (type == <span class="string">"function"</span> || (type == <span class="string">"string"</span> &amp;&amp; isFunction(<span class="keyword">this</span>.prototype[val]))) &amp;&amp;</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>and is in special, a processor, or has a funny character</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            !! (special[methodName] || processors[methodName] || <span class="regexp">/[^\w]/</span>.test(methodName));
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Takes a method name and the options passed to a control
and tries to return the data necessary to pass to a processor
(something that binds things).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _action: <span class="function"><span class="keyword">function</span> <span class="params">(methodName, options)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>If we don&#39;t have options (a <code>control</code> instance), we&#39;ll run this 
later.  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            paramReplacer.lastIndex = <span class="number">0</span>;
            <span class="keyword">if</span> (options || !paramReplacer.test(methodName)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>If we have options, run sub to replace templates <code>{}</code> with a
value from the options or the window</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> convertedName = options ? can.sub(methodName, [options, window]) : methodName;
                <span class="keyword">if</span> (!convertedName) {
                    <span class="keyword">return</span> <span class="literal">null</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>If a <code>{}</code> template resolves to an object, <code>convertedName</code> will be
an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> arr = can.isArray(convertedName),</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Get the name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    name = arr ? convertedName[<span class="number">1</span>] : convertedName,</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Grab the event off the end</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    parts = name.split(<span class="regexp">/\s+/g</span>),
                    event = parts.pop();

                <span class="keyword">return</span> {
                    processor: processors[event] || basicProcessor,
                    parts: [name, parts.join(<span class="string">" "</span>), event],
                    delegate: arr ? convertedName[<span class="number">0</span>] : <span class="literal">undefined</span>
                };
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>An object of <code>{eventName : function}</code> pairs that Control uses to 
hook up events auto-magically.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        processors: {},</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>A object of name-value pairs that act as default values for a 
control instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        defaults: {}
    },

    {</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Sets <code>this.element</code>, saves the control in `data, binds event
handlers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        setup: <span class="function"><span class="keyword">function</span> <span class="params">(element, options)</span> {</span>

            <span class="keyword">var</span> cls = <span class="keyword">this</span>.constructor,
                pluginname = cls.pluginName || cls._fullName,
                arr;</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Want the raw element here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.element = can.$(element)

            <span class="keyword">if</span> (pluginname &amp;&amp; pluginname !== <span class="string">'can_control'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Set element and <code>className</code> on element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">this</span>.element.addClass(pluginname);
            }

            (arr = can.data(<span class="keyword">this</span>.element, <span class="string">"controls"</span>)) || can.data(<span class="keyword">this</span>.element, <span class="string">"controls"</span>, arr = []);
            arr.push(<span class="keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Option merging.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.options = extend({}, cls.defaults, options);</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Bind all event handlers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.on();</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Get&#39;s passed into <code>init</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> [<span class="keyword">this</span>.element, <span class="keyword">this</span>.options];
        },

        on: <span class="function"><span class="keyword">function</span> <span class="params">(el, selector, eventName, func)</span> {</span>
            <span class="keyword">if</span> (!el) {</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Adds bindings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">this</span>.off();</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Go through the cached list of actions and use the processor 
to bind</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> cls = <span class="keyword">this</span>.constructor,
                    bindings = <span class="keyword">this</span>._bindings,
                    actions = cls.actions,
                    element = <span class="keyword">this</span>.element,
                    destroyCB = can.Control._shifter(<span class="keyword">this</span>, <span class="string">"destroy"</span>),
                    funcName, ready;

                <span class="keyword">for</span> (funcName <span class="keyword">in</span> actions) {</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Only push if we have the action and no option is <code>undefined</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (actions.hasOwnProperty(funcName) &amp;&amp; (ready = actions[funcName] || cls._action(funcName, <span class="keyword">this</span>.options))) {
                        bindings.push(ready.processor(ready.delegate || element, ready.parts[<span class="number">2</span>], ready.parts[<span class="number">1</span>], funcName, <span class="keyword">this</span>));
                    }
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>Setup to be destroyed...<br>don&#39;t bind because we don&#39;t want to remove it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                can.bind.call(element, <span class="string">"destroyed"</span>, destroyCB);
                bindings.push(<span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
                    can.unbind.call(el, <span class="string">"destroyed"</span>, destroyCB);
                });
                <span class="keyword">return</span> bindings.length;
            }

            <span class="keyword">if</span> (<span class="keyword">typeof</span> el == <span class="string">'string'</span>) {
                func = eventName;
                eventName = selector;
                selector = el;
                el = <span class="keyword">this</span>.element;
            }

            <span class="keyword">if</span> (func === <span class="literal">undefined</span>) {
                func = eventName;
                eventName = selector;
                selector = <span class="literal">null</span>;
            }

            <span class="keyword">if</span> (<span class="keyword">typeof</span> func == <span class="string">'string'</span>) {
                func = can.Control._shifter(<span class="keyword">this</span>, func);
            }

            <span class="keyword">this</span>._bindings.push(binder(el, eventName, func, selector));

            <span class="keyword">return</span> <span class="keyword">this</span>._bindings.length;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Unbinds all event handlers on the controller.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        off: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">var</span> el = <span class="keyword">this</span>.element[<span class="number">0</span>]
            each(<span class="keyword">this</span>._bindings || [], <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
                value(el);
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Adds bindings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>._bindings = [];
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>Prepares a <code>control</code> for garbage collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        destroy: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">var</span> Class = <span class="keyword">this</span>.constructor,
                pluginName = Class.pluginName || Class._fullName,
                controls;</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>Unbind bindings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.off();

            <span class="keyword">if</span> (pluginName &amp;&amp; pluginName !== <span class="string">'can_control'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>Remove the <code>className</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">this</span>.element.removeClass(pluginName);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>Remove from <code>data</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            controls = can.data(<span class="keyword">this</span>.element, <span class="string">"controls"</span>);
            controls.splice(can.inArray(<span class="keyword">this</span>, controls), <span class="number">1</span>);

            can.trigger(<span class="keyword">this</span>, <span class="string">"destroyed"</span>); <span class="comment">// In case we want to know if the `control` is removed.</span>
            <span class="keyword">this</span>.element = <span class="literal">null</span>;
        }
    });

    <span class="keyword">var</span> processors = can.Control.processors,</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>Processors do the binding.
They return a function that unbinds when called.<br>The basic processor that binds events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        basicProcessor = <span class="function"><span class="keyword">function</span> <span class="params">(el, event, selector, methodName, control)</span> {</span>
            <span class="keyword">return</span> binder(el, event, can.Control._shifter(control, methodName), selector);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>Set common events to be processed as a <code>basicProcessor</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    each([<span class="string">"change"</span>, <span class="string">"click"</span>, <span class="string">"contextmenu"</span>, <span class="string">"dblclick"</span>, <span class="string">"keydown"</span>, <span class="string">"keyup"</span>, <span class="string">"keypress"</span>, <span class="string">"mousedown"</span>, <span class="string">"mousemove"</span>, <span class="string">"mouseout"</span>, <span class="string">"mouseover"</span>, <span class="string">"mouseup"</span>, <span class="string">"reset"</span>, <span class="string">"resize"</span>, <span class="string">"scroll"</span>, <span class="string">"select"</span>, <span class="string">"submit"</span>, <span class="string">"focusin"</span>, <span class="string">"focusout"</span>, <span class="string">"mouseenter"</span>, <span class="string">"mouseleave"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <h1>104 - Add touch events as default processors</h1>
<p>TOOD feature detect?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">"touchstart"</span>, <span class="string">"touchmove"</span>, <span class="string">"touchcancel"</span>, <span class="string">"touchend"</span>, <span class="string">"touchleave"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span>
        processors[v] = basicProcessor;
    });

    <span class="keyword">return</span> Control;
})(module[<span class="string">"can/util/jquery/jquery.js"</span>], module[<span class="string">"can/construct/construct.js"</span>]); <span class="comment">// ## can/control/plugin/plugin.js</span>
module[<span class="string">'can/control/plugin/plugin.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">($, can)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>used to determine if a control instance is one of controllers
controllers can be strings or classes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> i, isAControllerOf = <span class="function"><span class="keyword">function</span> <span class="params">(instance, controllers)</span> {</span>
        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; controllers.length; i++) {
            <span class="keyword">if</span> (<span class="keyword">typeof</span> controllers[i] == <span class="string">'string'</span> ? instance.constructor._shortName == controllers[i] : instance <span class="keyword">instanceof</span> controllers[i]) {
                <span class="keyword">return</span> <span class="literal">true</span>;
            }
        }
        <span class="keyword">return</span> <span class="literal">false</span>;
    },
        makeArray = can.makeArray,
        old = can.Control.setup;

    can.Control.setup = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>if you didn&#39;t provide a name, or are control, don&#39;t do anything</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (<span class="keyword">this</span> !== can.Control) {


            <span class="keyword">var</span> pluginName = <span class="keyword">this</span>.pluginName || <span class="keyword">this</span>._fullName;</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>create jQuery plugin</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (pluginName !== <span class="string">'can_control'</span>) {
                <span class="keyword">this</span>.plugin(pluginName);
            }

            old.apply(<span class="keyword">this</span>, arguments);
        }
    };

    $.fn.extend({


        controls: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">var</span> controllerNames = makeArray(arguments),
                instances = [],
                controls, c, cname;</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>check if arguments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>

                controls = can.$(<span class="keyword">this</span>).data(<span class="string">"controls"</span>);
                <span class="keyword">if</span> (!controls) {
                    <span class="keyword">return</span>;
                }
                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; controls.length; i++) {
                    c = controls[i];
                    <span class="keyword">if</span> (!controllerNames.length || isAControllerOf(c, controllerNames)) {
                        instances.push(c);
                    }
                }
            });
            <span class="keyword">return</span> instances;
        },


        control: <span class="function"><span class="keyword">function</span> <span class="params">(control)</span> {</span>
            <span class="keyword">return</span> <span class="keyword">this</span>.controls.apply(<span class="keyword">this</span>, arguments)[<span class="number">0</span>];
        }
    });

    can.Control.plugin = <span class="function"><span class="keyword">function</span> <span class="params">(pluginname)</span> {</span>
        <span class="keyword">var</span> control = <span class="keyword">this</span>;

        <span class="keyword">if</span> (!$.fn[pluginname]) {
            $.fn[pluginname] = <span class="function"><span class="keyword">function</span> <span class="params">(options)</span> {</span>

                <span class="keyword">var</span> args = makeArray(arguments),</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>if the arg is a method on this control</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    isMethod = <span class="keyword">typeof</span> options == <span class="string">"string"</span> &amp;&amp; $.isFunction(control.prototype[options]),
                    meth = args[<span class="number">0</span>],
                    returns;
                <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>check if created</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> plugin = can.$(<span class="keyword">this</span>).control(control);

                    <span class="keyword">if</span> (plugin) {
                        <span class="keyword">if</span> (isMethod) {</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>call a method on the control with the remaining args</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            returns = plugin[meth].apply(plugin, args.slice(<span class="number">1</span>));
                        }
                        <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>call the plugin&#39;s update method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            plugin.update.apply(plugin, args);
                        }
                    }
                    <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>create a new control instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        control.newInstance.apply(control, [<span class="keyword">this</span>].concat(args));
                    }
                });
                <span class="keyword">return</span> returns !== <span class="literal">undefined</span> ? returns : <span class="keyword">this</span>;
            };
        }
    }

    can.Control.prototype.update = <span class="function"><span class="keyword">function</span> <span class="params">(options)</span> {</span>
        can.extend(<span class="keyword">this</span>.options, options);
        <span class="keyword">this</span>.on();
    };

    <span class="keyword">return</span> can;
})(module[<span class="string">"jquery/jquery.js"</span>], module[<span class="string">"can/util/jquery/jquery.js"</span>], module[<span class="string">"can/control/control.js"</span>]); <span class="comment">// ## can/view/view.js</span>
module[<span class="string">'can/view/view.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <h2>view.js</h2>
<p><code>can.view</code><br><em>Templating abstraction.</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> isFunction = can.isFunction,
        makeArray = can.makeArray,</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>Used for hookup <code>id</code>s.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        hookupId = <span class="number">1</span>,

        $view = can.view = <span class="function"><span class="keyword">function</span> <span class="params">(view, data, helpers, callback)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>If helpers is a <code>function</code>, it is actually a callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (isFunction(helpers)) {
                callback = helpers;
                helpers = <span class="literal">undefined</span>;
            }

            <span class="keyword">var</span> pipe = <span class="function"><span class="keyword">function</span> <span class="params">(result)</span> {</span>
                <span class="keyword">return</span> $view.frag(result);
            },</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>In case we got a callback, we need to convert the can.view.render
result to a document fragment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                wrapCallback = isFunction(callback) ?
                <span class="function"><span class="keyword">function</span> <span class="params">(frag)</span> {</span>
                    callback(pipe(frag));
                } : <span class="literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>Get the result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                result = $view.render(view, data, helpers, wrapCallback),
                deferred = can.Deferred();

            <span class="keyword">if</span> (isFunction(result)) {
                <span class="keyword">return</span> result;
            }

            <span class="keyword">if</span> (can.isDeferred(result)) {
                result.then(<span class="function"><span class="keyword">function</span> <span class="params">(result, data)</span> {</span>
                    deferred.resolve.call(deferred, pipe(result), data);
                }, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                    deferred.fail.apply(deferred, arguments);
                });
                <span class="keyword">return</span> deferred;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>Convert it into a dom frag.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> pipe(result);
        };

    can.extend($view, {</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>creates a frag and hooks it up all at once</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        frag: <span class="function"><span class="keyword">function</span> <span class="params">(result, parentNode)</span> {</span>
            <span class="keyword">return</span> $view.hookup($view.fragment(result), parentNode);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>simply creates a frag
this is used internally to create a frag
insert it
then hook it up</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        fragment: <span class="function"><span class="keyword">function</span> <span class="params">(result)</span> {</span>
            <span class="keyword">var</span> frag = can.buildFragment(result, document.body);</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>If we have an empty frag...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (!frag.childNodes.length) {
                frag.appendChild(document.createTextNode(<span class="string">''</span>));
            }
            <span class="keyword">return</span> frag;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>Convert a path like string into something that&#39;s ok for an <code>element</code> ID.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        toId: <span class="function"><span class="keyword">function</span> <span class="params">(src)</span> {</span>
            <span class="keyword">return</span> can.map(src.toString().split(<span class="regexp">/\/|\./g</span>), <span class="function"><span class="keyword">function</span> <span class="params">(part)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>Dont include empty strings in toId functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (part) {
                    <span class="keyword">return</span> part;
                }
            }).join(<span class="string">"_"</span>);
        },

        hookup: <span class="function"><span class="keyword">function</span> <span class="params">(fragment, parentNode)</span> {</span>
            <span class="keyword">var</span> hookupEls = [],
                id, func;</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>Get all <code>childNodes</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            can.each(fragment.childNodes ? can.makeArray(fragment.childNodes) : fragment, <span class="function"><span class="keyword">function</span> <span class="params">(node)</span> {</span>
                <span class="keyword">if</span> (node.nodeType === <span class="number">1</span>) {
                    hookupEls.push(node);
                    hookupEls.push.apply(hookupEls, can.makeArray(node.getElementsByTagName(<span class="string">'*'</span>)));
                }
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>Filter by <code>data-view-id</code> attribute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            can.each(hookupEls, <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
                <span class="keyword">if</span> (el.getAttribute &amp;&amp; (id = el.getAttribute(<span class="string">'data-view-id'</span>)) &amp;&amp; (func = $view.hookups[id])) {
                    func(el, parentNode, id);
                    <span class="keyword">delete</span> $view.hookups[id];
                    el.removeAttribute(<span class="string">'data-view-id'</span>);
                }
            });

            <span class="keyword">return</span> fragment;
        },


        hookups: {},


        hook: <span class="function"><span class="keyword">function</span> <span class="params">(cb)</span> {</span>
            $view.hookups[++hookupId] = cb;
            <span class="keyword">return</span> <span class="string">" data-view-id='"</span> + hookupId + <span class="string">"'"</span>;
        },


        cached: {},

        cachedRenderers: {},


        cache: <span class="literal">true</span>,


        register: <span class="function"><span class="keyword">function</span> <span class="params">(info)</span> {</span>
            <span class="keyword">this</span>.types[<span class="string">"."</span> + info.suffix] = info;
        },

        types: {},


        ext: <span class="string">".ejs"</span>,


        registerScript: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>},


        preload: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>},


        render: <span class="function"><span class="keyword">function</span> <span class="params">(view, data, helpers, callback)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>If helpers is a <code>function</code>, it is actually a callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (isFunction(helpers)) {
                callback = helpers;
                helpers = <span class="literal">undefined</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>See if we got passed any deferreds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> deferreds = getDeferreds(data);

            <span class="keyword">if</span> (deferreds.length) { <span class="comment">// Does data contain any deferreds?</span></pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>The deferred that resolves into the rendered content...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> deferred = <span class="keyword">new</span> can.Deferred(),
                    dataCopy = can.extend({}, data);</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>Add the view request to the list of deferreds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                deferreds.push(get(view, <span class="literal">true</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>Wait for the view and all deferreds to finish...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                can.when.apply(can, deferreds).then(<span class="function"><span class="keyword">function</span> <span class="params">(resolved)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>Get all the resolved deferreds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> objs = makeArray(arguments),</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>Renderer is the last index of the data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        renderer = objs.pop(),</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>The result of the template rendering with data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        result;</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>Make data look like the resolved deferreds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (can.isDeferred(data)) {
                        dataCopy = usefulPart(resolved);
                    }
                    <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>Go through each prop in data again and
replace the defferreds with what they resolved to.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">for</span> (<span class="keyword">var</span> prop <span class="keyword">in</span> data) {
                            <span class="keyword">if</span> (can.isDeferred(data[prop])) {
                                dataCopy[prop] = usefulPart(objs.shift());
                            }
                        }
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p>Get the rendered result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    result = renderer(dataCopy, helpers);</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>Resolve with the rendered view.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    deferred.resolve(result, dataCopy);</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>If there&#39;s a <code>callback</code>, call it back with the result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    callback &amp;&amp; callback(result, dataCopy);
                }, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                    deferred.reject.apply(deferred, arguments)
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>Return the deferred...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">return</span> deferred;
            }
            <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>No deferreds! Render this bad boy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> response,</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>If there&#39;s a <code>callback</code> function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                async = isFunction(callback),</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>Get the <code>view</code> type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    deferred = get(view, async);</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>If we are <code>async</code>...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (async) {</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>Return the deferred</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    response = deferred;</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>And fire callback with the rendered result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    deferred.then(<span class="function"><span class="keyword">function</span> <span class="params">(renderer)</span> {</span>
                        callback(data ? renderer(data, helpers) : renderer);
                    })
                } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>if the deferred is resolved, call the cached renderer instead
this is because it&#39;s possible, with recursive deferreds to
need to render a view while its deferred is <em>resolving</em>.  A <em>resolving</em> deferred
is a deferred that was just resolved and is calling back it&#39;s success callbacks.
If a new success handler is called while resoliving, it does not get fired by
jQuery&#39;s deferred system.  So instead of adding a new callback
we use the cached renderer.
We also add __view_id on the deferred so we can look up it&#39;s cached renderer.
In the future, we might simply store either a deferred or the cached result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (deferred.state() === <span class="string">"resolved"</span> &amp;&amp; deferred.__view_id) {
                        <span class="keyword">var</span> currentRenderer = $view.cachedRenderers[deferred.__view_id];
                        <span class="keyword">return</span> data ? currentRenderer(data, helpers) : currentRenderer;
                    } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>Otherwise, the deferred is complete, so
set response to the result of the rendering.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        deferred.then(<span class="function"><span class="keyword">function</span> <span class="params">(renderer)</span> {</span>
                            response = data ? renderer(data, helpers) : renderer;
                        });
                    }
                }

                <span class="keyword">return</span> response;
            }
        },


        registerView: <span class="function"><span class="keyword">function</span> <span class="params">(id, text, type, def)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>Get the renderer function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> func = (type || $view.types[$view.ext]).renderer(id, text);
            def = def || <span class="keyword">new</span> can.Deferred();</pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>Cache if we are caching.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> ($view.cache) {
                $view.cached[id] = def;
                def.__view_id = id;
                $view.cachedRenderers[id] = func;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>Return the objects for the response&#39;s <code>dataTypes</code>
(in this case view).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> def.resolve(func);
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p>Makes sure there&#39;s a template, if not, have <code>steal</code> provide a warning.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> checkText = <span class="function"><span class="keyword">function</span> <span class="params">(text, url)</span> {</span>
        <span class="keyword">if</span> (!text.length) {

            <span class="keyword">throw</span> <span class="string">"can.view: No template or empty template:"</span> + url;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p><code>Returns a</code>view<code>renderer deferred.</code>url<code>- The url to the template.</code>async` - If the ajax request should be asynchronous.<br>Returns a deferred.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        get = <span class="function"><span class="keyword">function</span> <span class="params">(url, async)</span> {</span>
            <span class="keyword">var</span> suffix = url.match(<span class="regexp">/\.[\w\d]+$/</span>),
                type,</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>If we are reading a script element for the content of the template,
<code>el</code> will be set to that script element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                el,</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>A unique identifier for the view (used for caching).
This is typically derived from the element id or
the url for the template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                id,</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>The ajax request used to retrieve the template content.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                jqXHR;</pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>If the url has a #, we assume we want to use an inline template
from a script element and not current page&#39;s HTML</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (url.match(<span class="regexp">/^#/</span>)) {
                url = url.substr(<span class="number">1</span>);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p>If we have an inline template, derive the suffix from the <code>text/???</code> part.
This only supports <code>&lt;script&gt;</code> tags.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (el = document.getElementById(url)) {
                suffix = <span class="string">"."</span> + el.type.match(<span class="regexp">/\/(x\-)?(.+)/</span>)[<span class="number">2</span>];
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p>If there is no suffix, add one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (!suffix &amp;&amp; !$view.cached[url]) {
                url += (suffix = $view.ext);
            }

            <span class="keyword">if</span> (can.isArray(suffix)) {
                suffix = suffix[<span class="number">0</span>]
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>Convert to a unique and valid id.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            id = $view.toId(url);</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p>If an absolute path, use <code>steal</code> to get it.
You should only be using <code>//</code> if you are using <code>steal</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (url.match(<span class="regexp">/^\/\//</span>)) {
                <span class="keyword">var</span> sub = url.substr(<span class="number">2</span>);
                url = !window.steal ? sub : steal.config().root.mapJoin(sub);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p>Set the template engine type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            type = $view.types[suffix];</pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>If it is cached, </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> ($view.cached[id]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>Return the cached deferred renderer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">return</span> $view.cached[id];</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p>Otherwise if we are getting this from a <code>&lt;script&gt;</code> element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            } <span class="keyword">else</span> <span class="keyword">if</span> (el) {</pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p>Resolve immediately with the element&#39;s <code>innerHTML</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">return</span> $view.registerView(id, el.innerHTML, type);
            } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p>Make an ajax request for text.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> d = <span class="keyword">new</span> can.Deferred();
                can.ajax({
                    async: async,
                    url: url,
                    dataType: <span class="string">"text"</span>,
                    error: <span class="function"><span class="keyword">function</span> <span class="params">(jqXHR)</span> {</span>
                        checkText(<span class="string">""</span>, url);
                        d.reject(jqXHR);
                    },
                    success: <span class="function"><span class="keyword">function</span> <span class="params">(text)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p>Make sure we got some text back.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        checkText(text, url);
                        $view.registerView(id, text, type, d)
                    }
                });
                <span class="keyword">return</span> d;
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <p>Gets an <code>array</code> of deferreds from an <code>object</code>.
This only goes one level deep.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        getDeferreds = <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> {</span>
            <span class="keyword">var</span> deferreds = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <p>pull out deferreds</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (can.isDeferred(data)) {
                <span class="keyword">return</span> [data]
            } <span class="keyword">else</span> {
                <span class="keyword">for</span> (<span class="keyword">var</span> prop <span class="keyword">in</span> data) {
                    <span class="keyword">if</span> (can.isDeferred(data[prop])) {
                        deferreds.push(data[prop]);
                    }
                }
            }
            <span class="keyword">return</span> deferreds;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>Gets the useful part of a resolved deferred.
This is for <code>model</code>s and <code>can.ajax</code> that resolve to an <code>array</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        usefulPart = <span class="function"><span class="keyword">function</span> <span class="params">(resolved)</span> {</span>
            <span class="keyword">return</span> can.isArray(resolved) &amp;&amp; resolved[<span class="number">1</span>] === <span class="string">'success'</span> ? resolved[<span class="number">0</span>] : resolved
        };



    can.extend($view, {
        register: <span class="function"><span class="keyword">function</span> <span class="params">(info)</span> {</span>
            <span class="keyword">this</span>.types[<span class="string">"."</span> + info.suffix] = info;



            $view[info.suffix] = <span class="function"><span class="keyword">function</span> <span class="params">(id, text)</span> {</span>
                <span class="keyword">if</span> (!text) {</pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p>Return a nameless renderer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> renderer = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                        <span class="keyword">return</span> $view.frag(renderer.render.apply(<span class="keyword">this</span>, arguments));
                    }
                    renderer.render = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                        <span class="keyword">var</span> renderer = info.renderer(<span class="literal">null</span>, id);
                        <span class="keyword">return</span> renderer.apply(renderer, arguments);
                    }
                    <span class="keyword">return</span> renderer;
                }

                $view.preload(id, info.renderer(id, text));
                <span class="keyword">return</span> can.view(id);
            }
        },
        registerScript: <span class="function"><span class="keyword">function</span> <span class="params">(type, id, src)</span> {</span>
            <span class="keyword">return</span> <span class="string">"can.view.preload('"</span> + id + <span class="string">"',"</span> + $view.types[<span class="string">"."</span> + type].script(id, src) + <span class="string">");"</span>;
        },
        preload: <span class="function"><span class="keyword">function</span> <span class="params">(id, renderer)</span> {</span>
            $view.cached[id] = <span class="keyword">new</span> can.Deferred().resolve(<span class="function"><span class="keyword">function</span> <span class="params">(data, helpers)</span> {</span>
                <span class="keyword">return</span> renderer.call(data, data, helpers);
            });

            <span class="function"><span class="keyword">function</span> <span class="title">frag</span><span class="params">()</span> {</span>
                <span class="keyword">return</span> $view.frag(renderer.apply(<span class="keyword">this</span>, arguments));
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p>expose the renderer for mustache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            frag.render = renderer;
            <span class="keyword">return</span> frag;
        }

    });

    <span class="keyword">return</span> can;
})(module[<span class="string">"can/util/jquery/jquery.js"</span>]); <span class="comment">// ## can/view/scanner.js</span>
module[<span class="string">'can/view/scanner.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span>

    <span class="keyword">var</span> newLine = <span class="regexp">/(\r|\n)+/g</span>,
        tagToContentPropMap = {
            option: <span class="string">"textContent"</span>,
            textarea: <span class="string">"value"</span>
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p>Escapes characters starting with <code>\</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        clean = <span class="function"><span class="keyword">function</span> <span class="params">(content)</span> {</span>
            <span class="keyword">return</span> content.split(<span class="string">'\\'</span>).join(<span class="string">"\\\\"</span>).split(<span class="string">"\n"</span>).join(<span class="string">"\\n"</span>).split(<span class="string">'"'</span>).join(<span class="string">'\\"'</span>).split(<span class="string">"\t"</span>).join(<span class="string">"\\t"</span>);
        },
        reverseTagMap = {
            tr: <span class="string">"tbody"</span>,
            option: <span class="string">"select"</span>,
            td: <span class="string">"tr"</span>,
            th: <span class="string">"tr"</span>,
            li: <span class="string">"ul"</span>
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <p>Returns a tagName to use as a temporary placeholder for live content
looks forward ... could be slow, but we only do it when necessary</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        getTag = <span class="function"><span class="keyword">function</span> <span class="params">(tagName, tokens, i)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p>if a tagName is provided, use that</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (tagName) {
                <span class="keyword">return</span> tagName;
            } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-182">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <p>otherwise go searching for the next two tokens like &quot;&lt;&quot;,TAG</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">while</span> (i &lt; tokens.length) {
                    <span class="keyword">if</span> (tokens[i] == <span class="string">"&lt;"</span> &amp;&amp; reverseTagMap[tokens[i + <span class="number">1</span>]]) {
                        <span class="keyword">return</span> reverseTagMap[tokens[i + <span class="number">1</span>]];
                    }
                    i++;
                }
            }
            <span class="keyword">return</span> <span class="string">''</span>;
        },
        bracketNum = <span class="function"><span class="keyword">function</span> <span class="params">(content)</span> {</span>
            <span class="keyword">return</span> (--content.split(<span class="string">"{"</span>).length) - (--content.split(<span class="string">"}"</span>).length);
        },
        myEval = <span class="function"><span class="keyword">function</span> <span class="params">(script)</span> {</span>
            eval(script);
        },
        attrReg = <span class="regexp">/([^\s]+)[\s]*=[\s]*$/</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-183">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              <p>Commands for caching.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        startTxt = <span class="string">'var ___v1ew = [];'</span>,
        finishTxt = <span class="string">"return ___v1ew.join('')"</span>,
        put_cmd = <span class="string">"___v1ew.push("</span>,
        insert_cmd = put_cmd,</pre></div></div>
            
        </li>
        
        
        <li id="section-184">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              <p>Global controls (used by other functions to know where we are).
Are we inside a tag?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        htmlTag = <span class="literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-185">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <p>Are we within a quote within a tag?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        quote = <span class="literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-186">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              <p>What was the text before the current quote? (used to get the <code>attr</code> name)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        beforeQuote = <span class="literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-187">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              <p>Whether a rescan is in progress</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        rescan = <span class="literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-188">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              <p>Used to mark where the element is.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        status = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-189">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              <p><code>t</code> - <code>1</code>.
<code>h</code> - <code>0</code>.
<code>q</code> - String <code>beforeQuote</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> quote ? <span class="string">"'"</span> + beforeQuote.match(attrReg)[<span class="number">1</span>] + <span class="string">"'"</span> : (htmlTag ? <span class="number">1</span> : <span class="number">0</span>);
        };

    can.view.Scanner = Scanner = <span class="function"><span class="keyword">function</span> <span class="params">(options)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-190">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              <p>Set options on self</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        can.extend(<span class="keyword">this</span>, {
            text: {},
            tokens: []
        }, options);</pre></div></div>
            
        </li>
        
        
        <li id="section-191">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              <p>Cache a token lookup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.tokenReg = [];
        <span class="keyword">this</span>.tokenSimple = {
            <span class="string">"&lt;"</span>: <span class="string">"&lt;"</span>,
            <span class="string">"&gt;"</span>: <span class="string">"&gt;"</span>,
            <span class="string">'"'</span>: <span class="string">'"'</span>,
            <span class="string">"'"</span>: <span class="string">"'"</span>
        };
        <span class="keyword">this</span>.tokenComplex = [];
        <span class="keyword">this</span>.tokenMap = {};
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, token; token = <span class="keyword">this</span>.tokens[i]; i++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-192">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <p>Save complex mappings (custom regexp)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (token[<span class="number">2</span>]) {
                <span class="keyword">this</span>.tokenReg.push(token[<span class="number">2</span>]);
                <span class="keyword">this</span>.tokenComplex.push({
                    abbr: token[<span class="number">1</span>],
                    re: <span class="keyword">new</span> RegExp(token[<span class="number">2</span>]),
                    rescan: token[<span class="number">3</span>]
                });
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-193">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              <p>Save simple mappings (string only, no regexp)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">else</span> {
                <span class="keyword">this</span>.tokenReg.push(token[<span class="number">1</span>]);
                <span class="keyword">this</span>.tokenSimple[token[<span class="number">1</span>]] = token[<span class="number">0</span>];
            }
            <span class="keyword">this</span>.tokenMap[token[<span class="number">0</span>]] = token[<span class="number">1</span>];
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-194">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <p>Cache the token registry.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.tokenReg = <span class="keyword">new</span> RegExp(<span class="string">"("</span> + <span class="keyword">this</span>.tokenReg.slice(<span class="number">0</span>).concat([<span class="string">"&lt;"</span>, <span class="string">"&gt;"</span>, <span class="string">'"'</span>, <span class="string">"'"</span>]).join(<span class="string">"|"</span>) + <span class="string">")"</span>, <span class="string">"g"</span>);
    };

    Scanner.prototype = {

        helpers: [

        {
            name: <span class="regexp">/\s*\(([\$\w]+)\)\s*-&gt;([^\n]*)/</span>,
            fn: <span class="function"><span class="keyword">function</span> <span class="params">(content)</span> {</span>
                <span class="keyword">var</span> quickFunc = <span class="regexp">/\s*\(([\$\w]+)\)\s*-&gt;([^\n]*)/</span>,
                    parts = content.match(quickFunc);

                <span class="keyword">return</span> <span class="string">"function(__){var "</span> + parts[<span class="number">1</span>] + <span class="string">"=can.$(__);"</span> + parts[<span class="number">2</span>] + <span class="string">"}"</span>;
            }
        }],

        scan: <span class="function"><span class="keyword">function</span> <span class="params">(source, name)</span> {</span>
            <span class="keyword">var</span> tokens = [],
                last = <span class="number">0</span>,
                simple = <span class="keyword">this</span>.tokenSimple,
                complex = <span class="keyword">this</span>.tokenComplex;

            source = source.replace(newLine, <span class="string">"\n"</span>);
            source.replace(<span class="keyword">this</span>.tokenReg, <span class="function"><span class="keyword">function</span> <span class="params">(whole, part)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-195">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <p>offset is the second to last argument</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> offset = arguments[arguments.length - <span class="number">2</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-196">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              <p>if the next token starts after the last token ends
push what&#39;s in between</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (offset &gt; last) {
                    tokens.push(source.substring(last, offset));
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-197">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p>push the simple token (if there is one)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (simple[whole]) {
                    tokens.push(whole);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-198">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p>otherwise lookup complex tokens</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">else</span> {
                    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, token; token = complex[i]; i++) {
                        <span class="keyword">if</span> (token.re.test(whole)) {
                            tokens.push(token.abbr);</pre></div></div>
            
        </li>
        
        
        <li id="section-199">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              <p>Push a rescan function if one exists</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="keyword">if</span> (token.rescan) {
                                tokens.push(token.rescan(part));
                            }
                            <span class="keyword">break</span>;
                        }
                    }
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-200">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-200">&#182;</a>
              </div>
              <p>update the position of the last part of the last token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                last = offset + part.length;
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-201">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-201">&#182;</a>
              </div>
              <p>if there&#39;s something at the end, add it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (last &lt; source.length) {
                tokens.push(source.substr(last));
            }

            <span class="keyword">var</span> content = <span class="string">''</span>,
                buff = [startTxt + (<span class="keyword">this</span>.text.start || <span class="string">''</span>)],</pre></div></div>
            
        </li>
        
        
        <li id="section-202">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-202">&#182;</a>
              </div>
              <p>Helper <code>function</code> for putting stuff in the view concat.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                put = <span class="function"><span class="keyword">function</span> <span class="params">(content, bonus)</span> {</span>
                    buff.push(put_cmd, <span class="string">'"'</span>, clean(content), <span class="string">'"'</span> + (bonus || <span class="string">''</span>) + <span class="string">');'</span>);
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-203">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-203">&#182;</a>
              </div>
              <p>A stack used to keep track of how we should end a bracket
<code>}</code>.<br>Once we have a <code>&lt;%= %&gt;</code> with a <code>leftBracket</code>,
we store how the file should end here (either <code>))</code> or <code>;</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                endStack = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-204">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-204">&#182;</a>
              </div>
              <p>The last token, used to remember which tag we are in.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                lastToken,</pre></div></div>
            
        </li>
        
        
        <li id="section-205">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-205">&#182;</a>
              </div>
              <p>The corresponding magic tag.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                startTag = <span class="literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-206">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-206">&#182;</a>
              </div>
              <p>Was there a magic tag inside an html tag?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                magicInTag = <span class="literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-207">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-207">&#182;</a>
              </div>
              <p>The current tag name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                tagName = <span class="string">''</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-208">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-208">&#182;</a>
              </div>
              <p>stack of tagNames</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                tagNames = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-209">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-209">&#182;</a>
              </div>
              <p>Pop from tagNames?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                popTagName = <span class="literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-210">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-210">&#182;</a>
              </div>
              <p>Declared here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                bracketCount, i = <span class="number">0</span>,
                token, tmap = <span class="keyword">this</span>.tokenMap;</pre></div></div>
            
        </li>
        
        
        <li id="section-211">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-211">&#182;</a>
              </div>
              <p>Reinitialize the tag state goodness.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            htmlTag = quote = beforeQuote = <span class="literal">null</span>;

            <span class="keyword">for</span> (;
            (token = tokens[i++]) !== <span class="literal">undefined</span>;) {
                <span class="keyword">if</span> (startTag === <span class="literal">null</span>) {
                    <span class="keyword">switch</span> (token) {
                    <span class="keyword">case</span> tmap.left:
                    <span class="keyword">case</span> tmap.escapeLeft:
                    <span class="keyword">case</span> tmap.returnLeft:
                        magicInTag = htmlTag &amp;&amp; <span class="number">1</span>;
                    <span class="keyword">case</span> tmap.commentLeft:</pre></div></div>
            
        </li>
        
        
        <li id="section-212">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-212">&#182;</a>
              </div>
              <p>A new line -- just add whatever content within a clean.<br>Reset everything.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        startTag = token;
                        <span class="keyword">if</span> (content.length) {
                            put(content);
                        }
                        content = <span class="string">''</span>;
                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> tmap.escapeFull:</pre></div></div>
            
        </li>
        
        
        <li id="section-213">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-213">&#182;</a>
              </div>
              <p>This is a full line escape (a line that contains only whitespace and escaped logic)
Break it up into escape left and right</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        magicInTag = htmlTag &amp;&amp; <span class="number">1</span>;
                        rescan = <span class="number">1</span>;
                        startTag = tmap.escapeLeft;
                        <span class="keyword">if</span> (content.length) {
                            put(content);
                        }
                        rescan = tokens[i++];
                        content = rescan.content || rescan;
                        <span class="keyword">if</span> (rescan.before) {
                            put(rescan.before);
                        }
                        tokens.splice(i, <span class="number">0</span>, tmap.right);
                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> tmap.commentFull:</pre></div></div>
            
        </li>
        
        
        <li id="section-214">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-214">&#182;</a>
              </div>
              <p>Ignore full line comments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> tmap.templateLeft:
                        content += tmap.left;
                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'&lt;'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-215">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-215">&#182;</a>
              </div>
              <p>Make sure we are not in a comment.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (tokens[i].indexOf(<span class="string">"!--"</span>) !== <span class="number">0</span>) {
                            htmlTag = <span class="number">1</span>;
                            magicInTag = <span class="number">0</span>;
                        }
                        content += token;
                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'&gt;'</span>:
                        htmlTag = <span class="number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-216">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-216">&#182;</a>
              </div>
              <p>content.substr(-1) doesn&#39;t work in IE7/8</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">var</span> emptyElement = content.substr(content.length - <span class="number">1</span>) == <span class="string">"/"</span> || content.substr(content.length - <span class="number">2</span>) == <span class="string">"--"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-217">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-217">&#182;</a>
              </div>
              <p>if there was a magic tag
or it&#39;s an element that has text content between its tags, 
but content is not other tags add a hookup
TODO: we should only add <code>can.EJS.pending()</code> if there&#39;s a magic tag 
within the html tags.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (magicInTag || !popTagName &amp;&amp; tagToContentPropMap[tagNames[tagNames.length - <span class="number">1</span>]]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-218">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-218">&#182;</a>
              </div>
              <p>make sure / of /&gt; is on the left of pending</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="keyword">if</span> (emptyElement) {
                                put(content.substr(<span class="number">0</span>, content.length - <span class="number">1</span>), <span class="string">",can.view.pending(),\"/&gt;\""</span>);
                            } <span class="keyword">else</span> {
                                put(content, <span class="string">",can.view.pending(),\"&gt;\""</span>);
                            }
                            content = <span class="string">''</span>;
                            magicInTag = <span class="number">0</span>;
                        } <span class="keyword">else</span> {
                            content += token;
                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-219">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-219">&#182;</a>
              </div>
              <p>if it&#39;s a tag like <input/></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (emptyElement || popTagName) {</pre></div></div>
            
        </li>
        
        
        <li id="section-220">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-220">&#182;</a>
              </div>
              <p>remove the current tag in the stack</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            tagNames.pop();</pre></div></div>
            
        </li>
        
        
        <li id="section-221">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-221">&#182;</a>
              </div>
              <p>set the current tag to the previous parent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            tagName = tagNames[tagNames.length - <span class="number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-222">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-222">&#182;</a>
              </div>
              <p>Don&#39;t pop next time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            popTagName = <span class="literal">false</span>;
                        }
                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">"'"</span>:
                    <span class="keyword">case</span> <span class="string">'"'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-223">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-223">&#182;</a>
              </div>
              <p>If we are in an html tag, finding matching quotes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (htmlTag) {</pre></div></div>
            
        </li>
        
        
        <li id="section-224">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-224">&#182;</a>
              </div>
              <p>We have a quote and it matches.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="keyword">if</span> (quote &amp;&amp; quote === token) {</pre></div></div>
            
        </li>
        
        
        <li id="section-225">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-225">&#182;</a>
              </div>
              <p>We are exiting the quote.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                quote = <span class="literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-226">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-226">&#182;</a>
              </div>
              <p>Otherwise we are creating a quote.
TODO: does this handle <code>\</code>?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            } <span class="keyword">else</span> <span class="keyword">if</span> (quote === <span class="literal">null</span>) {
                                quote = token;
                                beforeQuote = lastToken;
                            }
                        }
                    <span class="keyword">default</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-227">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-227">&#182;</a>
              </div>
              <p>Track the current tag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (lastToken === <span class="string">'&lt;'</span>) {
                            tagName = token.split(<span class="regexp">/\s/</span>)[<span class="number">0</span>];
                            <span class="keyword">if</span> (tagName.indexOf(<span class="string">"/"</span>) === <span class="number">0</span> &amp;&amp; tagNames[tagNames.length - <span class="number">1</span>] === tagName.substr(<span class="number">1</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-228">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-228">&#182;</a>
              </div>
              <p>set tagName to the last tagName
if there are no more tagNames, we&#39;ll rely on getTag.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                tagName = tagNames[tagNames.length - <span class="number">1</span>];
                                popTagName = <span class="literal">true</span>;
                            } <span class="keyword">else</span> {
                                tagNames.push(tagName);
                            }
                        }
                        content += token;
                        <span class="keyword">break</span>;
                    }
                } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-229">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-229">&#182;</a>
              </div>
              <p>We have a start tag.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">switch</span> (token) {
                    <span class="keyword">case</span> tmap.right:
                    <span class="keyword">case</span> tmap.returnRight:
                        <span class="keyword">switch</span> (startTag) {
                        <span class="keyword">case</span> tmap.left:</pre></div></div>
            
        </li>
        
        
        <li id="section-230">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-230">&#182;</a>
              </div>
              <p>Get the number of <code>{ minus }</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            bracketCount = bracketNum(content);</pre></div></div>
            
        </li>
        
        
        <li id="section-231">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-231">&#182;</a>
              </div>
              <p>We are ending a block.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="keyword">if</span> (bracketCount == <span class="number">1</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-232">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-232">&#182;</a>
              </div>
              <p>We are starting on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                buff.push(insert_cmd, <span class="string">"can.view.txt(0,'"</span> + getTag(tagName, tokens, i) + <span class="string">"',"</span> + status() + <span class="string">",this,function(){"</span>, startTxt, content);

                                endStack.push({
                                    before: <span class="string">""</span>,
                                    after: finishTxt + <span class="string">"}));\n"</span>
                                });
                            }
                            <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-233">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-233">&#182;</a>
              </div>
              <p>How are we ending this statement?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                last = <span class="comment">// If the stack has value and we are ending a block...</span>
                                endStack.length &amp;&amp; bracketCount == -<span class="number">1</span> ? <span class="comment">// Use the last item in the block stack.</span>
                                endStack.pop() : <span class="comment">// Or use the default ending.</span>
                                {
                                    after: <span class="string">";"</span>
                                };</pre></div></div>
            
        </li>
        
        
        <li id="section-234">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-234">&#182;</a>
              </div>
              <p>If we are ending a returning block, 
add the finish text which returns the result of the
block.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="keyword">if</span> (last.before) {
                                    buff.push(last.before);
                                }</pre></div></div>
            
        </li>
        
        
        <li id="section-235">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-235">&#182;</a>
              </div>
              <p>Add the remaining content.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                buff.push(content, <span class="string">";"</span>, last.after);
                            }
                            <span class="keyword">break</span>;
                        <span class="keyword">case</span> tmap.escapeLeft:
                        <span class="keyword">case</span> tmap.returnLeft:</pre></div></div>
            
        </li>
        
        
        <li id="section-236">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-236">&#182;</a>
              </div>
              <p>We have an extra <code>{</code> -&gt; <code>block</code>.
Get the number of <code>{ minus }</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            bracketCount = bracketNum(content);</pre></div></div>
            
        </li>
        
        
        <li id="section-237">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-237">&#182;</a>
              </div>
              <p>If we have more <code>{</code>, it means there is a block.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="keyword">if</span> (bracketCount) {</pre></div></div>
            
        </li>
        
        
        <li id="section-238">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-238">&#182;</a>
              </div>
              <p>When we return to the same # of <code>{</code> vs <code>}</code> end with a <code>doubleParent</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                endStack.push({
                                    before: finishTxt,
                                    after: <span class="string">"}));"</span>
                                });
                            }

                            <span class="keyword">var</span> escaped = startTag === tmap.escapeLeft ? <span class="number">1</span> : <span class="number">0</span>,
                                commands = {
                                    insert: insert_cmd,
                                    tagName: getTag(tagName, tokens, i),
                                    status: status()
                                };

                            <span class="keyword">for</span> (<span class="keyword">var</span> ii = <span class="number">0</span>; ii &lt; <span class="keyword">this</span>.helpers.length; ii++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-239">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-239">&#182;</a>
              </div>
              <p>Match the helper based on helper
regex name value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="keyword">var</span> helper = <span class="keyword">this</span>.helpers[ii];
                                <span class="keyword">if</span> (helper.name.test(content)) {
                                    content = helper.fn(content, commands);</pre></div></div>
            
        </li>
        
        
        <li id="section-240">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-240">&#182;</a>
              </div>
              <p>dont escape partials</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    <span class="keyword">if</span> (helper.name.source == <span class="regexp">/^&gt;[\s]*\w*/</span>.source) {
                                        escaped = <span class="number">0</span>;
                                    }
                                    <span class="keyword">break</span>;
                                }
                            }</pre></div></div>
            
        </li>
        
        
        <li id="section-241">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-241">&#182;</a>
              </div>
              <p>Handle special cases</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="keyword">if</span> (<span class="keyword">typeof</span> content == <span class="string">'object'</span>) {
                                <span class="keyword">if</span> (content.raw) {
                                    buff.push(content.raw);
                                }
                            } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-242">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-242">&#182;</a>
              </div>
              <p>If we have <code>&lt;%== a(function(){ %&gt;</code> then we want
<code>can.EJS.text(0,this, function(){ return a(function(){ var _v1ew = [];</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                buff.push(insert_cmd, <span class="string">"can.view.txt("</span> + escaped + <span class="string">",'"</span> + tagName + <span class="string">"',"</span> + status() + <span class="string">",this,function(){ "</span> + (<span class="keyword">this</span>.text.escape || <span class="string">''</span>) + <span class="string">"return "</span>, content,</pre></div></div>
            
        </li>
        
        
        <li id="section-243">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-243">&#182;</a>
              </div>
              <p>If we have a block.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                bracketCount ?</pre></div></div>
            
        </li>
        
        
        <li id="section-244">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-244">&#182;</a>
              </div>
              <p>Start with startTxt <code>&quot;var _v1ew = [];&quot;</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                startTxt :</pre></div></div>
            
        </li>
        
        
        <li id="section-245">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-245">&#182;</a>
              </div>
              <p>If not, add <code>doubleParent</code> to close push and text.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="string">"}));"</span>);
                            }

                            <span class="keyword">if</span> (rescan &amp;&amp; rescan.after &amp;&amp; rescan.after.length) {
                                put(rescan.after.length);
                                rescan = <span class="literal">null</span>;
                            }
                            <span class="keyword">break</span>;
                        }
                        startTag = <span class="literal">null</span>;
                        content = <span class="string">''</span>;
                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> tmap.templateLeft:
                        content += tmap.left;
                        <span class="keyword">break</span>;
                    <span class="keyword">default</span>:
                        content += token;
                        <span class="keyword">break</span>;
                    }
                }
                lastToken = token;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-246">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-246">&#182;</a>
              </div>
              <p>Put it together...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (content.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-247">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-247">&#182;</a>
              </div>
              <p>Should be <code>content.dump</code> in Ruby.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                put(content);
            }
            buff.push(<span class="string">";"</span>);

            <span class="keyword">var</span> template = buff.join(<span class="string">''</span>),
                out = {
                    out: <span class="string">'with(_VIEW) { with (_CONTEXT) {'</span> + template + <span class="string">" "</span> + finishTxt + <span class="string">"}}"</span>
                };</pre></div></div>
            
        </li>
        
        
        <li id="section-248">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-248">&#182;</a>
              </div>
              <p>Use <code>eval</code> instead of creating a function, because it is easier to debug.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            myEval.call(out, <span class="string">'this.fn = (function(_CONTEXT,_VIEW){'</span> + out.out + <span class="string">'});\r\n//@ sourceURL='</span> + name + <span class="string">".js"</span>);

            <span class="keyword">return</span> out;
        }
    };

    <span class="keyword">return</span> Scanner;
})(module[<span class="string">"can/view/view.js"</span>]); <span class="comment">// ## can/observe/compute/compute.js</span>
module[<span class="string">'can/observe/compute/compute.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-249">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-249">&#182;</a>
              </div>
              <p>returns the
- observes and attr methods are called by func
- the value returned by func
ex: <code>{value: 100, observed: [{obs: o, attr: &quot;completed&quot;}]}</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> getValueAndObserved = <span class="function"><span class="keyword">function</span> <span class="params">(func, self)</span> {</span>

        <span class="keyword">var</span> oldReading;
        <span class="keyword">if</span> (can.Observe) {</pre></div></div>
            
        </li>
        
        
        <li id="section-250">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-250">&#182;</a>
              </div>
              <p>Set a callback on can.Observe to know
when an attr is read.
Keep a reference to the old reader
if there is one.  This is used
for nested live binding.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            oldReading = can.Observe.__reading;
            can.Observe.__reading = <span class="function"><span class="keyword">function</span> <span class="params">(obj, attr)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-251">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-251">&#182;</a>
              </div>
              <p>Add the observe and attr that was read
to <code>observed</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                observed.push({
                    obj: obj,
                    attr: attr
                });
            };
        }

        <span class="keyword">var</span> observed = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-252">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-252">&#182;</a>
              </div>
              <p>Call the &quot;wrapping&quot; function to get the value. <code>observed</code>
will have the observe/attribute pairs that were read.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            value = func.call(self);</pre></div></div>
            
        </li>
        
        
        <li id="section-253">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-253">&#182;</a>
              </div>
              <p>Set back so we are no longer reading.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (can.Observe) {
            can.Observe.__reading = oldReading;
        }
        <span class="keyword">return</span> {
            value: value,
            observed: observed
        };
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-254">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-254">&#182;</a>
              </div>
              <p>Calls <code>callback(newVal, oldVal)</code> everytime an observed property
called within <code>getterSetter</code> is changed and creates a new result of <code>getterSetter</code>.
Also returns an object that can teardown all event handlers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        computeBinder = <span class="function"><span class="keyword">function</span> <span class="params">(getterSetter, context, callback, computeState)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-255">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-255">&#182;</a>
              </div>
              <p>track what we are observing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> observing = {},</pre></div></div>
            
        </li>
        
        
        <li id="section-256">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-256">&#182;</a>
              </div>
              <p>a flag indicating if this observe/attr pair is already bound</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                matched = <span class="literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-257">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-257">&#182;</a>
              </div>
              <p>the data to return </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                data = {</pre></div></div>
            
        </li>
        
        
        <li id="section-258">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-258">&#182;</a>
              </div>
              <p>we will maintain the value while live-binding is taking place</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    value: <span class="literal">undefined</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-259">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-259">&#182;</a>
              </div>
              <p>a teardown method that stops listening</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    teardown: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                        <span class="keyword">for</span> (<span class="keyword">var</span> name <span class="keyword">in</span> observing) {
                            <span class="keyword">var</span> ob = observing[name];
                            ob.observe.obj.unbind(ob.observe.attr, onchanged);
                            <span class="keyword">delete</span> observing[name];
                        }
                    }
                },
                batchNum;</pre></div></div>
            
        </li>
        
        
        <li id="section-260">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-260">&#182;</a>
              </div>
              <p>when a property value is changed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> onchanged = <span class="function"><span class="keyword">function</span> <span class="params">(ev)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-261">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-261">&#182;</a>
              </div>
              <p>If the compute is no longer bound (because the same change event led to an unbind)
then do not call getValueAndBind, or we will leak bindings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (computeState &amp;&amp; !computeState.bound) {
                    <span class="keyword">return</span>;
                }
                <span class="keyword">if</span> (ev.batchNum === <span class="literal">undefined</span> || ev.batchNum !== batchNum) {</pre></div></div>
            
        </li>
        
        
        <li id="section-262">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-262">&#182;</a>
              </div>
              <p>store the old value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> oldValue = data.value,</pre></div></div>
            
        </li>
        
        
        <li id="section-263">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-263">&#182;</a>
              </div>
              <p>get the new value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        newvalue = getValueAndBind();</pre></div></div>
            
        </li>
        
        
        <li id="section-264">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-264">&#182;</a>
              </div>
              <p>update the value reference (in case someone reads)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    data.value = newvalue;</pre></div></div>
            
        </li>
        
        
        <li id="section-265">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-265">&#182;</a>
              </div>
              <p>if a change happened</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (newvalue !== oldValue) {
                        callback(newvalue, oldValue);
                    }
                    batchNum = batchNum = ev.batchNum;
                }


            };</pre></div></div>
            
        </li>
        
        
        <li id="section-266">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-266">&#182;</a>
              </div>
              <p>gets the value returned by <code>getterSetter</code> and also binds to any attributes
read by the call</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> getValueAndBind = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                <span class="keyword">var</span> info = getValueAndObserved(getterSetter, context),
                    newObserveSet = info.observed;

                <span class="keyword">var</span> value = info.value;
                matched = !matched;</pre></div></div>
            
        </li>
        
        
        <li id="section-267">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-267">&#182;</a>
              </div>
              <p>go through every attribute read by this observe</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                can.each(newObserveSet, <span class="function"><span class="keyword">function</span> <span class="params">(ob)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-268">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-268">&#182;</a>
              </div>
              <p>if the observe/attribute pair is being observed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (observing[ob.obj._cid + <span class="string">"|"</span> + ob.attr]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-269">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-269">&#182;</a>
              </div>
              <p>mark at as observed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        observing[ob.obj._cid + <span class="string">"|"</span> + ob.attr].matched = matched;
                    } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-270">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-270">&#182;</a>
              </div>
              <p>otherwise, set the observe/attribute on oldObserved, marking it as being observed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        observing[ob.obj._cid + <span class="string">"|"</span> + ob.attr] = {
                            matched: matched,
                            observe: ob
                        };
                        ob.obj.bind(ob.attr, onchanged);
                    }
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-271">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-271">&#182;</a>
              </div>
              <p>Iterate through oldObserved, looking for observe/attributes
that are no longer being bound and unbind them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">for</span> (<span class="keyword">var</span> name <span class="keyword">in</span> observing) {
                    <span class="keyword">var</span> ob = observing[name];
                    <span class="keyword">if</span> (ob.matched !== matched) {
                        ob.observe.obj.unbind(ob.observe.attr, onchanged);
                        <span class="keyword">delete</span> observing[name];
                    }
                }
                <span class="keyword">return</span> value;
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-272">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-272">&#182;</a>
              </div>
              <p>set the initial value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            data.value = getValueAndBind();
            data.isListening = !can.isEmptyObject(observing);
            <span class="keyword">return</span> data;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-273">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-273">&#182;</a>
              </div>
              <p>if no one is listening ... we can not calculate every time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        can.compute = <span class="function"><span class="keyword">function</span> <span class="params">(getterSetter, context)</span> {</span>
            <span class="keyword">if</span> (getterSetter &amp;&amp; getterSetter.isComputed) {
                <span class="keyword">return</span> getterSetter;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-274">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-274">&#182;</a>
              </div>
              <p>get the value right away
TODO: eventually we can defer this until a bind or a read</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> computedData, bindings = <span class="number">0</span>,
                computed, canbind = <span class="literal">true</span>;
            <span class="keyword">if</span> (<span class="keyword">typeof</span> getterSetter === <span class="string">"function"</span>) {
                computed = <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
                    <span class="keyword">if</span> (value === <span class="literal">undefined</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-275">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-275">&#182;</a>
              </div>
              <p>we are reading</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (computedData) {</pre></div></div>
            
        </li>
        
        
        <li id="section-276">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-276">&#182;</a>
              </div>
              <p>If another compute is calling this compute for the value,
it needs to bind to this compute&#39;s change so it will re-compute
and re-bind when this compute changes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="keyword">if</span> (bindings &amp;&amp; can.Observe.__reading) {
                                can.Observe.__reading(computed, <span class="string">'change'</span>);
                            }
                            <span class="keyword">return</span> computedData.value;
                        } <span class="keyword">else</span> {
                            <span class="keyword">return</span> getterSetter.call(context || <span class="keyword">this</span>)
                        }
                    } <span class="keyword">else</span> {
                        <span class="keyword">return</span> getterSetter.apply(context || <span class="keyword">this</span>, arguments)
                    }
                }

            } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-277">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-277">&#182;</a>
              </div>
              <p>we just gave it a value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                computed = <span class="function"><span class="keyword">function</span> <span class="params">(val)</span> {</span>
                    <span class="keyword">if</span> (val === <span class="literal">undefined</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-278">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-278">&#182;</a>
              </div>
              <p>If observing, record that the value is being read.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (can.Observe.__reading) {
                            can.Observe.__reading(computed, <span class="string">'change'</span>);
                        }
                        <span class="keyword">return</span> getterSetter;
                    } <span class="keyword">else</span> {
                        <span class="keyword">var</span> old = getterSetter;
                        getterSetter = val;
                        <span class="keyword">if</span> (old !== val) {
                            can.Observe.triggerBatch(computed, <span class="string">"change"</span>, [val, old]);
                        }

                        <span class="keyword">return</span> val;
                    }

                }
                canbind = <span class="literal">false</span>;
            }

            computed.isComputed = <span class="literal">true</span>;

            can.cid(computed, <span class="string">"compute"</span>)
            <span class="keyword">var</span> computeState = {
                bound: <span class="literal">false</span>
            };

            computed.bind = <span class="function"><span class="keyword">function</span> <span class="params">(ev, handler)</span> {</span>
                can.addEvent.apply(computed, arguments);
                <span class="keyword">if</span> (bindings === <span class="number">0</span> &amp;&amp; canbind) {
                    computeState.bound = <span class="literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-279">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-279">&#182;</a>
              </div>
              <p>setup live-binding</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    computedData = computeBinder(getterSetter, context || <span class="keyword">this</span>, <span class="function"><span class="keyword">function</span> <span class="params">(newValue, oldValue)</span> {</span>
                        can.Observe.triggerBatch(computed, <span class="string">"change"</span>, [newValue, oldValue])
                    }, computeState);
                }
                bindings++;
            }

            computed.unbind = <span class="function"><span class="keyword">function</span> <span class="params">(ev, handler)</span> {</span>
                can.removeEvent.apply(computed, arguments);
                bindings--;
                <span class="keyword">if</span> (bindings === <span class="number">0</span> &amp;&amp; canbind) {
                    computedData.teardown();
                    computeState.bound = <span class="literal">false</span>;
                }

            };
            <span class="keyword">return</span> computed;
        };
    can.compute.binder = computeBinder;
    <span class="keyword">return</span> can.compute;
})(module[<span class="string">"can/util/jquery/jquery.js"</span>]); <span class="comment">// ## can/view/render.js</span>
module[<span class="string">'can/view/render.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-280">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-280">&#182;</a>
              </div>
              <p>text node expando test</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> canExpando = <span class="literal">true</span>;
    <span class="keyword">try</span> {
        document.createTextNode(<span class="string">''</span>)._ = <span class="number">0</span>;
    } <span class="keyword">catch</span> (ex) {
        canExpando = <span class="literal">false</span>;
    }

    <span class="keyword">var</span> attrMap = {
        <span class="string">"class"</span>: <span class="string">"className"</span>,
        <span class="string">"value"</span>: <span class="string">"value"</span>,
        <span class="string">"innerText"</span>: <span class="string">"innerText"</span>,
        <span class="string">"textContent"</span>: <span class="string">"textContent"</span>
    },
        tagMap = {
            <span class="string">""</span>: <span class="string">"span"</span>,
            table: <span class="string">"tbody"</span>,
            tr: <span class="string">"td"</span>,
            ol: <span class="string">"li"</span>,
            ul: <span class="string">"li"</span>,
            tbody: <span class="string">"tr"</span>,
            thead: <span class="string">"tr"</span>,
            tfoot: <span class="string">"tr"</span>,
            select: <span class="string">"option"</span>,
            optgroup: <span class="string">"option"</span>
        },
        attributePlaceholder = <span class="string">'__!!__'</span>,
        attributeReplace = <span class="regexp">/__!!__/g</span>,
        tagToContentPropMap = {
            option: <span class="string">"textContent"</span> <span class="keyword">in</span> document.createElement(<span class="string">"option"</span>) ? <span class="string">"textContent"</span> : <span class="string">"innerText"</span>,
            textarea: <span class="string">"value"</span>
        },
        bool = can.each([<span class="string">"checked"</span>, <span class="string">"disabled"</span>, <span class="string">"readonly"</span>, <span class="string">"required"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(n)</span> {</span>
            attrMap[n] = n;
        }),</pre></div></div>
            
        </li>
        
        
        <li id="section-281">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-281">&#182;</a>
              </div>
              <p>a helper to get the parentNode for a given element el
if el is in a documentFragment, it will return defaultParentNode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        getParentNode = <span class="function"><span class="keyword">function</span> <span class="params">(el, defaultParentNode)</span> {</span>
            <span class="keyword">return</span> defaultParentNode &amp;&amp; el.parentNode.nodeType === <span class="number">11</span> ? defaultParentNode : el.parentNode;
        },
        setAttr = <span class="function"><span class="keyword">function</span> <span class="params">(el, attrName, val)</span> {</span>
            <span class="keyword">var</span> tagName = el.nodeName.toString().toLowerCase(),
                prop = attrMap[attrName];</pre></div></div>
            
        </li>
        
        
        <li id="section-282">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-282">&#182;</a>
              </div>
              <p>if this is a special property</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (prop) {</pre></div></div>
            
        </li>
        
        
        <li id="section-283">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-283">&#182;</a>
              </div>
              <p>set the value as true / false</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                el[prop] = can.inArray(attrName, bool) &gt; -<span class="number">1</span> ? <span class="literal">true</span> : val;
                <span class="keyword">if</span> (prop === <span class="string">"value"</span> &amp;&amp; (tagName === <span class="string">"input"</span> || tagName === <span class="string">"textarea"</span>)) {
                    el.defaultValue = val;
                }
            } <span class="keyword">else</span> {
                el.setAttribute(attrName, val);
            }
        },
        getAttr = <span class="function"><span class="keyword">function</span> <span class="params">(el, attrName)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-284">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-284">&#182;</a>
              </div>
              <p>Default to a blank string for IE7/8</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> (attrMap[attrName] &amp;&amp; el[attrMap[attrName]] ? el[attrMap[attrName]] : el.getAttribute(attrName)) || <span class="string">''</span>;
        },
        removeAttr = <span class="function"><span class="keyword">function</span> <span class="params">(el, attrName)</span> {</span>
            <span class="keyword">if</span> (can.inArray(attrName, bool) &gt; -<span class="number">1</span>) {
                el[attrName] = <span class="literal">false</span>;
            } <span class="keyword">else</span> {
                el.removeAttribute(attrName);
            }
        },
        pendingHookups = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-285">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-285">&#182;</a>
              </div>
              <p>Returns text content for anything other than a live-binding </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        contentText = <span class="function"><span class="keyword">function</span> <span class="params">(input)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-286">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-286">&#182;</a>
              </div>
              <p>If it&#39;s a string, return.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="keyword">typeof</span> input == <span class="string">'string'</span>) {
                <span class="keyword">return</span> input;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-287">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-287">&#182;</a>
              </div>
              <p>If has no value, return an empty string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (!input &amp;&amp; input !== <span class="number">0</span>) {
                <span class="keyword">return</span> <span class="string">''</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-288">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-288">&#182;</a>
              </div>
              <p>If it&#39;s an object, and it has a hookup method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> hook = (input.hookup &amp;&amp;</pre></div></div>
            
        </li>
        
        
        <li id="section-289">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-289">&#182;</a>
              </div>
              <p>Make a function call the hookup method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="function"><span class="keyword">function</span> <span class="params">(el, id)</span> {</span>
                input.hookup.call(input, el, id);
            }) ||</pre></div></div>
            
        </li>
        
        
        <li id="section-290">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-290">&#182;</a>
              </div>
              <p>Or if it&#39;s a <code>function</code>, just use the input.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            (<span class="keyword">typeof</span> input == <span class="string">'function'</span> &amp;&amp; input);</pre></div></div>
            
        </li>
        
        
        <li id="section-291">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-291">&#182;</a>
              </div>
              <p>Finally, if there is a <code>function</code> to hookup on some dom,
add it to pending hookups.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (hook) {
                pendingHookups.push(hook);
                <span class="keyword">return</span> <span class="string">''</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-292">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-292">&#182;</a>
              </div>
              <p>Finally, if all else is <code>false</code>, <code>toString()</code> it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> <span class="string">""</span> + input;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-293">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-293">&#182;</a>
              </div>
              <p>Returns escaped/sanatized content for anything other than a live-binding</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        contentEscape = <span class="function"><span class="keyword">function</span> <span class="params">(txt)</span> {</span>
            <span class="keyword">return</span> (<span class="keyword">typeof</span> txt == <span class="string">'string'</span> || <span class="keyword">typeof</span> txt == <span class="string">'number'</span>) ? can.esc(txt) : contentText(txt);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-294">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-294">&#182;</a>
              </div>
              <p>a mapping of element ids to nodeList ids</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        nodeMap = {},</pre></div></div>
            
        </li>
        
        
        <li id="section-295">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-295">&#182;</a>
              </div>
              <p>a mapping of ids to text nodes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        textNodeMap = {},</pre></div></div>
            
        </li>
        
        
        <li id="section-296">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-296">&#182;</a>
              </div>
              <p>a mapping of nodeList ids to nodeList</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        nodeListMap = {},
        expando = <span class="string">"ejs_"</span> + Math.random(),
        _id = <span class="number">0</span>,
        id = <span class="function"><span class="keyword">function</span> <span class="params">(node)</span> {</span>
            <span class="keyword">if</span> (canExpando || node.nodeType !== <span class="number">3</span>) {
                <span class="keyword">if</span> (node[expando]) {
                    <span class="keyword">return</span> node[expando];
                }
                <span class="keyword">else</span> {
                    <span class="keyword">return</span> node[expando] = (node.nodeName ? <span class="string">"element_"</span> : <span class="string">"obj_"</span>) + (++_id);
                }
            }
            <span class="keyword">else</span> {
                <span class="keyword">for</span> (<span class="keyword">var</span> textNodeID <span class="keyword">in</span> textNodeMap) {
                    <span class="keyword">if</span> (textNodeMap[textNodeID] === node) {
                        <span class="keyword">return</span> textNodeID;
                    }
                }

                textNodeMap[<span class="string">"text_"</span> + (++_id)] = node;
                <span class="keyword">return</span> <span class="string">"text_"</span> + _id;
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-297">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-297">&#182;</a>
              </div>
              <p>removes a nodeListId from a node&#39;s nodeListIds</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        removeNodeListId = <span class="function"><span class="keyword">function</span> <span class="params">(node, nodeListId)</span> {</span>
            <span class="keyword">var</span> nodeListIds = nodeMap[id(node)];
            <span class="keyword">if</span> (nodeListIds) {
                <span class="keyword">var</span> index = can.inArray(nodeListId, nodeListIds);

                <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) {
                    nodeListIds.splice(index, <span class="number">1</span>);
                }
                <span class="keyword">if</span> (!nodeListIds.length) {
                    <span class="keyword">delete</span> nodeMap[id(node)];
                }
            }
        },
        addNodeListId = <span class="function"><span class="keyword">function</span> <span class="params">(node, nodeListId)</span> {</span>
            <span class="keyword">var</span> nodeListIds = nodeMap[id(node)];
            <span class="keyword">if</span> (!nodeListIds) {
                nodeListIds = nodeMap[id(node)] = [];
            }
            nodeListIds.push(nodeListId);
        },
        tagChildren = <span class="function"><span class="keyword">function</span> <span class="params">(tagName)</span> {</span>
            <span class="keyword">var</span> newTag = tagMap[tagName] || <span class="string">"span"</span>;
            <span class="keyword">if</span> (newTag === <span class="string">"span"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-298">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-298">&#182;</a>
              </div>
              <p>innerHTML in IE doesn&#39;t honor leading whitespace after empty elements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">return</span> <span class="string">"@@!!@@"</span>;
            }
            <span class="keyword">return</span> <span class="string">"&lt;"</span> + newTag + <span class="string">"&gt;"</span> + tagChildren(newTag) + <span class="string">"&lt;/"</span> + newTag + <span class="string">"&gt;"</span>;
        };

    can.extend(can.view, {

        pending: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-299">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-299">&#182;</a>
              </div>
              <p>TODO, make this only run for the right tagName</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> hooks = pendingHookups.slice(<span class="number">0</span>);
            lastHookups = hooks;
            pendingHookups = [];
            <span class="keyword">return</span> can.view.hook(<span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
                can.each(hooks, <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
                    fn(el);
                });
            });
        },

        registerNode: <span class="function"><span class="keyword">function</span> <span class="params">(nodeList)</span> {</span>
            <span class="keyword">var</span> nLId = id(nodeList);
            nodeListMap[nLId] = nodeList;

            can.each(nodeList, <span class="function"><span class="keyword">function</span> <span class="params">(node)</span> {</span>
                addNodeListId(node, nLId);
            });
        },

        unregisterNode: <span class="function"><span class="keyword">function</span> <span class="params">(nodeList)</span> {</span>
            <span class="keyword">var</span> nLId = id(nodeList);
            can.each(nodeList, <span class="function"><span class="keyword">function</span> <span class="params">(node)</span> {</span>
                removeNodeListId(node, nLId);
            });
            <span class="keyword">delete</span> nodeListMap[nLId];
        },


        txt: <span class="function"><span class="keyword">function</span> <span class="params">(escape, tagName, status, self, func)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-300">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-300">&#182;</a>
              </div>
              <p>call the &quot;wrapping&quot; function and get the binding information</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> binding = can.compute.binder(func, self, <span class="function"><span class="keyword">function</span> <span class="params">(newVal, oldVal)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-301">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-301">&#182;</a>
              </div>
              <p>call the update method we will define for each
type of attribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                update(newVal, oldVal);
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-302">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-302">&#182;</a>
              </div>
              <p>If we had no observes just return the value returned by func.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (!binding.isListening) {
                <span class="keyword">return</span> (escape || status !== <span class="number">0</span> ? contentEscape : contentText)(binding.value);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-303">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-303">&#182;</a>
              </div>
              <p>The following are helper methods or varaibles that will
be defined by one of the various live-updating schemes.
The parent element we are listening to for teardown</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> parentElement, nodeList, teardown = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                binding.teardown();
                <span class="keyword">if</span> (nodeList) {
                    can.view.unregisterNode(nodeList);
                }
            },</pre></div></div>
            
        </li>
        
        
        <li id="section-304">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-304">&#182;</a>
              </div>
              <p>if the parent element is removed, teardown the binding</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                setupTeardownOnDestroy = <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
                    can.bind.call(el, <span class="string">'destroyed'</span>, teardown);
                    parentElement = el;
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-305">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-305">&#182;</a>
              </div>
              <p>if there is no parent, undo bindings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                teardownCheck = <span class="function"><span class="keyword">function</span> <span class="params">(parent)</span> {</span>
                    <span class="keyword">if</span> (!parent) {
                        teardown();
                        can.unbind.call(parentElement, <span class="string">'destroyed'</span>, teardown);
                    }
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-306">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-306">&#182;</a>
              </div>
              <p>the tag type to insert</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                tag = (tagMap[tagName] || <span class="string">"span"</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-307">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-307">&#182;</a>
              </div>
              <p>this will be filled in if binding.isListening</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                update,</pre></div></div>
            
        </li>
        
        
        <li id="section-308">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-308">&#182;</a>
              </div>
              <p>the property (instead of innerHTML elements) to adjust. For
example options should use textContent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                contentProp = tagToContentPropMap[tagName];</pre></div></div>
            
        </li>
        
        
        <li id="section-309">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-309">&#182;</a>
              </div>
              <p>The magic tag is outside or between tags.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (status === <span class="number">0</span> &amp;&amp; !contentProp) {</pre></div></div>
            
        </li>
        
        
        <li id="section-310">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-310">&#182;</a>
              </div>
              <p>Return an element tag with a hookup in place of the content</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">return</span> <span class="string">"&lt;"</span> + tag + can.view.hook(
                escape ?</pre></div></div>
            
        </li>
        
        
        <li id="section-311">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-311">&#182;</a>
              </div>
              <p>If we are escaping, replace the parentNode with 
a text node who&#39;s value is <code>func</code>&#39;s return value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="function"><span class="keyword">function</span> <span class="params">(el, parentNode)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-312">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-312">&#182;</a>
              </div>
              <p>updates the text of the text node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    update = <span class="function"><span class="keyword">function</span> <span class="params">(newVal)</span> {</span>
                        node.nodeValue = <span class="string">""</span> + newVal;
                        teardownCheck(node.parentNode);
                    };

                    <span class="keyword">var</span> parent = getParentNode(el, parentNode),
                        node = document.createTextNode(binding.value);</pre></div></div>
            
        </li>
        
        
        <li id="section-313">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-313">&#182;</a>
              </div>
              <p>When iterating through an Observe.List with no DOM
elements containing the individual items, the parent 
is sometimes incorrect not the true parent of the 
source element. (#153)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (el.parentNode !== parent) {
                        parent = el.parentNode;
                        parent.insertBefore(node, el);
                        parent.removeChild(el);
                    } <span class="keyword">else</span> {
                        parent.insertBefore(node, el);
                        parent.removeChild(el);
                    }
                    setupTeardownOnDestroy(parent);
                } :</pre></div></div>
            
        </li>
        
        
        <li id="section-314">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-314">&#182;</a>
              </div>
              <p>If we are not escaping, replace the parentNode with a
documentFragment created as with <code>func</code>&#39;s return value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="function"><span class="keyword">function</span> <span class="params">(span, parentNode)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-315">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-315">&#182;</a>
              </div>
              <p>updates the elements with the new content</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    update = <span class="function"><span class="keyword">function</span> <span class="params">(newVal)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-316">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-316">&#182;</a>
              </div>
              <p>is this still part of the DOM?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">var</span> attached = nodes[<span class="number">0</span>].parentNode;</pre></div></div>
            
        </li>
        
        
        <li id="section-317">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-317">&#182;</a>
              </div>
              <p>update the nodes in the DOM with the new rendered value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (attached) {
                            makeAndPut(newVal);
                        }
                        teardownCheck(nodes[<span class="number">0</span>].parentNode);
                    };</pre></div></div>
            
        </li>
        
        
        <li id="section-318">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-318">&#182;</a>
              </div>
              <p>make sure we have a valid parentNode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    parentNode = getParentNode(span, parentNode);</pre></div></div>
            
        </li>
        
        
        <li id="section-319">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-319">&#182;</a>
              </div>
              <p>A helper function to manage inserting the contents
and removing the old contents</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> nodes, makeAndPut = <span class="function"><span class="keyword">function</span> <span class="params">(val)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-320">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-320">&#182;</a>
              </div>
              <p>create the fragment, but don&#39;t hook it up
we need to insert it into the document first</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">var</span> frag = can.view.frag(val, parentNode),</pre></div></div>
            
        </li>
        
        
        <li id="section-321">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-321">&#182;</a>
              </div>
              <p>keep a reference to each node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            newNodes = can.makeArray(frag.childNodes),
                            last = nodes ? nodes[nodes.length - <span class="number">1</span>] : span;</pre></div></div>
            
        </li>
        
        
        <li id="section-322">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-322">&#182;</a>
              </div>
              <p>Insert it in the <code>document</code> or <code>documentFragment</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (last.nextSibling) {
                            last.parentNode.insertBefore(frag, last.nextSibling);
                        } <span class="keyword">else</span> {
                            last.parentNode.appendChild(frag);
                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-323">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-323">&#182;</a>
              </div>
              <p>nodes hasn&#39;t been set yet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (!nodes) {
                            can.remove(can.$(span));
                            nodes = newNodes;</pre></div></div>
            
        </li>
        
        
        <li id="section-324">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-324">&#182;</a>
              </div>
              <p>set the teardown nodeList</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            nodeList = nodes;
                            can.view.registerNode(nodes);
                        } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-325">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-325">&#182;</a>
              </div>
              <p>Update node Array&#39;s to point to new nodes
and then remove the old nodes.
It has to be in this order for Mootools
and IE because somehow, after an element
is removed from the DOM, it loses its
expando values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="keyword">var</span> nodesToRemove = can.makeArray(nodes);
                            can.view.replace(nodes, newNodes);
                            can.remove(can.$(nodesToRemove));
                        }
                    };</pre></div></div>
            
        </li>
        
        
        <li id="section-326">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-326">&#182;</a>
              </div>
              <p>nodes are the nodes that any updates will replace
at this point, these nodes could be part of a documentFragment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    makeAndPut(binding.value, [span]);

                    setupTeardownOnDestroy(parentNode);</pre></div></div>
            
        </li>
        
        
        <li id="section-327">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-327">&#182;</a>
              </div>
              <p>children have to be properly nested HTML for buildFragment to work properly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                }) + <span class="string">"&gt;"</span> + tagChildren(tag) + <span class="string">"&lt;/"</span> + tag + <span class="string">"&gt;"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-328">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-328">&#182;</a>
              </div>
              <p>In a tag, but not in an attribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            } <span class="keyword">else</span> <span class="keyword">if</span> (status === <span class="number">1</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-329">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-329">&#182;</a>
              </div>
              <p>remember the old attr name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> attrName = binding.value.replace(<span class="regexp">/['"]/g</span>, <span class="string">''</span>).split(<span class="string">'='</span>)[<span class="number">0</span>];
                pendingHookups.push(<span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
                    update = <span class="function"><span class="keyword">function</span> <span class="params">(newVal)</span> {</span>
                        <span class="keyword">var</span> parts = (newVal || <span class="string">""</span>).replace(<span class="regexp">/['"]/g</span>, <span class="string">''</span>).split(<span class="string">'='</span>),
                            newAttrName = parts[<span class="number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-330">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-330">&#182;</a>
              </div>
              <p>Remove if we have a change and used to have an <code>attrName</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> ((newAttrName != attrName) &amp;&amp; attrName) {
                            removeAttr(el, attrName);
                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-331">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-331">&#182;</a>
              </div>
              <p>Set if we have a new <code>attrName</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (newAttrName) {
                            setAttr(el, newAttrName, parts[<span class="number">1</span>]);
                            attrName = newAttrName;
                        }
                    };
                    setupTeardownOnDestroy(el);
                });

                <span class="keyword">return</span> binding.value;
            } <span class="keyword">else</span> { <span class="comment">// In an attribute...</span>
                <span class="keyword">var</span> attributeName = status === <span class="number">0</span> ? contentProp : status;</pre></div></div>
            
        </li>
        
        
        <li id="section-332">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-332">&#182;</a>
              </div>
              <p>if the magic tag is inside the element, like <code>&lt;option&gt;&lt;% TAG %&gt;&lt;/option&gt;</code>,
we add this hookup to the last element (ex: <code>option</code>&#39;s) hookups.
Otherwise, the magic tag is in an attribute, just add to the current element&#39;s
hookups.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                (status === <span class="number">0</span> ? lastHookups : pendingHookups).push(<span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-333">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-333">&#182;</a>
              </div>
              <p>update will call this attribute&#39;s render method
and set the attribute accordingly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    update = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                        setAttr(el, attributeName, hook.render(), contentProp);
                    };

                    <span class="keyword">var</span> wrapped = can.$(el),
                        hooks;</pre></div></div>
            
        </li>
        
        
        <li id="section-334">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-334">&#182;</a>
              </div>
              <p>Get the list of hookups or create one for this element.
Hooks is a map of attribute names to hookup <code>data</code>s.
Each hookup data has:
<code>render</code> - A <code>function</code> to render the value of the attribute.
<code>funcs</code> - A list of hookup <code>function</code>s on that attribute.
<code>batchNum</code> - The last event <code>batchNum</code>, used for performance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    hooks = can.data(wrapped, <span class="string">'hooks'</span>);
                    <span class="keyword">if</span> (!hooks) {
                        can.data(wrapped, <span class="string">'hooks'</span>, hooks = {});
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-335">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-335">&#182;</a>
              </div>
              <p>Get the attribute value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> attr = getAttr(el, attributeName, contentProp),</pre></div></div>
            
        </li>
        
        
        <li id="section-336">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-336">&#182;</a>
              </div>
              <p>Split the attribute value by the template.
Only split out the first <strong>!!</strong> so if we have multiple hookups in the same attribute, 
they will be put in the right spot on first render</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        parts = attr.split(attributePlaceholder),
                        goodParts = [],
                        hook;
                    goodParts.push(parts.shift(), parts.join(attributePlaceholder));</pre></div></div>
            
        </li>
        
        
        <li id="section-337">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-337">&#182;</a>
              </div>
              <p>If we already had a hookup for this attribute...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (hooks[attributeName]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-338">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-338">&#182;</a>
              </div>
              <p>Just add to that attribute&#39;s list of <code>function</code>s.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        hooks[attributeName].bindings.push(binding);
                    } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-339">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-339">&#182;</a>
              </div>
              <p>Create the hookup data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        hooks[attributeName] = {
                            render: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                                <span class="keyword">var</span> i = <span class="number">0</span>,
                                    newAttr = attr.replace(attributeReplace, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                                        <span class="keyword">return</span> contentText(hook.bindings[i++].value);
                                    });
                                <span class="keyword">return</span> newAttr;
                            },
                            bindings: [binding],
                            batchNum: <span class="literal">undefined</span>
                        };
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-340">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-340">&#182;</a>
              </div>
              <p>Save the hook for slightly faster performance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    hook = hooks[attributeName];</pre></div></div>
            
        </li>
        
        
        <li id="section-341">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-341">&#182;</a>
              </div>
              <p>Insert the value in parts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    goodParts.splice(<span class="number">1</span>, <span class="number">0</span>, binding.value);</pre></div></div>
            
        </li>
        
        
        <li id="section-342">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-342">&#182;</a>
              </div>
              <p>Set the attribute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    setAttr(el, attributeName, goodParts.join(<span class="string">""</span>), contentProp);</pre></div></div>
            
        </li>
        
        
        <li id="section-343">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-343">&#182;</a>
              </div>
              <p>Bind on change.
liveBind(observed, el, binder,oldObserved);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    setupTeardownOnDestroy(el);
                });
                <span class="keyword">return</span> attributePlaceholder;
            }
        },

        replace: <span class="function"><span class="keyword">function</span> <span class="params">(oldNodeList, newNodes)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-344">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-344">&#182;</a>
              </div>
              <p>for each node in the node list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            oldNodeList = can.makeArray(oldNodeList);

            can.each(oldNodeList, <span class="function"><span class="keyword">function</span> <span class="params">(node)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-345">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-345">&#182;</a>
              </div>
              <p>for each nodeList the node is in</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                can.each(can.makeArray(nodeMap[id(node)]), <span class="function"><span class="keyword">function</span> <span class="params">(nodeListId)</span> {</span>
                    <span class="keyword">var</span> nodeList = nodeListMap[nodeListId],
                        startIndex = can.inArray(node, nodeList),
                        endIndex = can.inArray(oldNodeList[oldNodeList.length - <span class="number">1</span>], nodeList);</pre></div></div>
            
        </li>
        
        
        <li id="section-346">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-346">&#182;</a>
              </div>
              <p>remove this nodeListId from each node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (startIndex &gt;= <span class="number">0</span> &amp;&amp; endIndex &gt;= <span class="number">0</span>) {
                        <span class="keyword">for</span> (<span class="keyword">var</span> i = startIndex; i &lt;= endIndex; i++) {
                            <span class="keyword">var</span> n = nodeList[i];
                            removeNodeListId(n, nodeListId);
                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-347">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-347">&#182;</a>
              </div>
              <p>swap in new nodes into the nodeLIst</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        nodeList.splice.apply(nodeList, [startIndex, endIndex - startIndex + <span class="number">1</span>].concat(newNodes));</pre></div></div>
            
        </li>
        
        
        <li id="section-348">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-348">&#182;</a>
              </div>
              <p>tell these new nodes they belong to the nodeList</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        can.each(newNodes, <span class="function"><span class="keyword">function</span> <span class="params">(node)</span> {</span>
                            addNodeListId(node, nodeListId);
                        });
                    } <span class="keyword">else</span> {
                        can.view.unregisterNode(nodeList);
                    }
                });
            });
        },

        canExpando: canExpando,</pre></div></div>
            
        </li>
        
        
        <li id="section-349">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-349">&#182;</a>
              </div>
              <p>Node mappings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        textNodeMap: textNodeMap,
        nodeMap: nodeMap,
        nodeListMap: nodeListMap
    });

    <span class="keyword">return</span> can;
})(module[<span class="string">"can/view/view.js"</span>], module[<span class="string">"can/util/string/string.js"</span>]); <span class="comment">// ## can/view/mustache/mustache.js</span>
module[<span class="string">'can/view/mustache/mustache.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-350">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-350">&#182;</a>
              </div>
              <h1>mustache.js</h1>
<p><code>can.Mustache</code>: The Mustache templating engine.
See the <a href="#section-29">Transformation</a> section within <em>Scanning Helpers</em> for a detailed explanation 
of the runtime render code design. The majority of the Mustache engine implementation 
occurs within the <em>Transformation</em> scanning helper.</p>
<h2>Initialization</h2>
<p>Define the view extension.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    can.view.ext = <span class="string">".mustache"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-351">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-351">&#182;</a>
              </div>
              <h3>Setup internal helper variables and functions.</h3>
<p>An alias for the context variable used for tracking a stack of contexts.
This is also used for passing to helper functions to maintain proper context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> CONTEXT = <span class="string">'___c0nt3xt'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-352">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-352">&#182;</a>
              </div>
              <p>An alias for the variable used for the hash object that can be passed
to helpers via <code>options.hash</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        HASH = <span class="string">'___h4sh'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-353">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-353">&#182;</a>
              </div>
              <p>An alias for the function that adds a new context to the context stack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        STACK = <span class="string">'___st4ck'</span>,
        STACKED = <span class="string">'___st4ck3d'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-354">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-354">&#182;</a>
              </div>
              <p>An alias for the most used context stacking call.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        CONTEXT_STACK = STACK + <span class="string">'('</span> + CONTEXT + <span class="string">',this)'</span>,
        CONTEXT_OBJ = <span class="string">'{context:'</span> + CONTEXT_STACK + <span class="string">',options:options}'</span>,


        isObserve = <span class="function"><span class="keyword">function</span> <span class="params">(obj)</span> {</span>
            <span class="keyword">return</span> obj !== <span class="literal">null</span> &amp;&amp; can.isFunction(obj.attr) &amp;&amp; obj.constructor &amp;&amp; !! obj.constructor.canMakeObserve;
        },


        isArrayLike = <span class="function"><span class="keyword">function</span> <span class="params">(obj)</span> {</span>
            <span class="keyword">return</span> obj &amp;&amp; obj.splice &amp;&amp; <span class="keyword">typeof</span> obj.length == <span class="string">'number'</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-355">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-355">&#182;</a>
              </div>
              <h2>Mustache</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Mustache = <span class="function"><span class="keyword">function</span> <span class="params">(options, helpers)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-356">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-356">&#182;</a>
              </div>
              <p>Support calling Mustache without the constructor.
This returns a function that renders the template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="keyword">this</span>.constructor != Mustache) {
                <span class="keyword">var</span> mustache = <span class="keyword">new</span> Mustache(options);
                <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(data, options)</span> {</span>
                    <span class="keyword">return</span> mustache.render(data, options);
                };
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-357">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-357">&#182;</a>
              </div>
              <p>If we get a <code>function</code> directly, it probably is coming from
a <code>steal</code>-packaged view.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) {
                <span class="keyword">this</span>.template = {
                    fn: options
                };
                <span class="keyword">return</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-358">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-358">&#182;</a>
              </div>
              <p>Set options on self.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            can.extend(<span class="keyword">this</span>, options);
            <span class="keyword">this</span>.template = <span class="keyword">this</span>.scanner.scan(<span class="keyword">this</span>.text, <span class="keyword">this</span>.name);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-359">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-359">&#182;</a>
              </div>
              <p>Put Mustache on the <code>can</code> object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    can.Mustache = window.Mustache = Mustache;


    Mustache.prototype.

    render = <span class="function"><span class="keyword">function</span> <span class="params">(object, options)</span> {</span>
        object = object || {};
        options = options || {};
        <span class="keyword">if</span> (!options.helpers &amp;&amp; !options.partials) {
            options.helpers = options;
        }
        <span class="keyword">return</span> <span class="keyword">this</span>.template.fn.call(object, object, {
            _data: object,
            options: options
        });
    };

    can.extend(Mustache.prototype, {</pre></div></div>
            
        </li>
        
        
        <li id="section-360">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-360">&#182;</a>
              </div>
              <p>Share a singleton scanner for parsing templates.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        scanner: <span class="keyword">new</span> can.view.Scanner({</pre></div></div>
            
        </li>
        
        
        <li id="section-361">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-361">&#182;</a>
              </div>
              <p>A hash of strings for the scanner to inject at certain points.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            text: {</pre></div></div>
            
        </li>
        
        
        <li id="section-362">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-362">&#182;</a>
              </div>
              <p>This is the logic to inject at the beginning of a rendered template. 
This includes initializing the <code>context</code> stack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                start: <span class="string">'var '</span> + CONTEXT + <span class="string">' = this &amp;&amp; this.'</span> + STACKED + <span class="string">' ? this : [];'</span> + CONTEXT + <span class="string">'.'</span> + STACKED + <span class="string">' = true;'</span> + <span class="string">'var '</span> + STACK + <span class="string">' = function(context, self) {'</span> + <span class="string">'var s;'</span> + <span class="string">'if (arguments.length == 1 &amp;&amp; context) {'</span> + <span class="string">'s = !context.'</span> + STACKED + <span class="string">' ? [context] : context;'</span> +</pre></div></div>
            
        </li>
        
        
        <li id="section-363">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-363">&#182;</a>
              </div>
              <p>Handle helpers with custom contexts (#228)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="string">'} else if (!context.'</span> + STACKED + <span class="string">') {'</span> + <span class="string">'s = [self, context];'</span> + <span class="string">'} else if (context &amp;&amp; context === self &amp;&amp; context.'</span> + STACKED + <span class="string">') {'</span> + <span class="string">'s = context.slice(0);'</span> + <span class="string">'} else {'</span> + <span class="string">'s = context &amp;&amp; context.'</span> + STACKED + <span class="string">' ? context.concat([self]) : '</span> + STACK + <span class="string">'(context).concat([self]);'</span> + <span class="string">'}'</span> + <span class="string">'return (s.'</span> + STACKED + <span class="string">' = true) &amp;&amp; s;'</span> + <span class="string">'};'</span>
            },</pre></div></div>
            
        </li>
        
        
        <li id="section-364">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-364">&#182;</a>
              </div>
              <p>An ordered token registry for the scanner.
This needs to be ordered by priority to prevent token parsing errors.
Each token follows the following structure:
    [
        // Which key in the token map to match.
        &quot;tokenMapName&quot;,
        // A simple token to match, like &quot;{{&quot;.
        &quot;token&quot;,
        // Optional. A complex (regexp) token to match that 
        // overrides the simple token.
        &quot;[\s\t]*{{&quot;,
        // Optional. A function that executes advanced 
        // manipulation of the matched content. This is 
        // rarely used.
        function(content){<br>            return content;
        }
    ]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            tokens: [</pre></div></div>
            
        </li>
        
        
        <li id="section-365">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-365">&#182;</a>
              </div>
              <p>Return unescaped</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            [<span class="string">"returnLeft"</span>, <span class="string">"{{{"</span>, <span class="string">"{{[{&amp;]"</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-366">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-366">&#182;</a>
              </div>
              <p>Full line comments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            [<span class="string">"commentFull"</span>, <span class="string">"{{!}}"</span>, <span class="string">"^[\\s\\t]*{{!.+?}}\\n"</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-367">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-367">&#182;</a>
              </div>
              <p>Inline comments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            [<span class="string">"commentLeft"</span>, <span class="string">"{{!"</span>, <span class="string">"(\\n[\\s\\t]*{{!|{{!)"</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-368">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-368">&#182;</a>
              </div>
              <p>Full line escapes
This is used for detecting lines with only whitespace and an escaped tag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            [<span class="string">"escapeFull"</span>, <span class="string">"{{}}"</span>, <span class="string">"(^[\\s\\t]*{{[#/^][^}]+?}}\\n|\\n[\\s\\t]*{{[#/^][^}]+?}}\\n|\\n[\\s\\t]*{{[#/^][^}]+?}}$)"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(content)</span> {</span>
                <span class="keyword">return</span> {
                    before: <span class="regexp">/^\n.+?\n$/</span>.test(content) ? <span class="string">'\n'</span> : <span class="string">''</span>,
                    content: content.match(<span class="regexp">/\{\{(.+?)\}\}/</span>)[<span class="number">1</span>] || <span class="string">''</span>
                };
            }],</pre></div></div>
            
        </li>
        
        
        <li id="section-369">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-369">&#182;</a>
              </div>
              <p>Return escaped</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            [<span class="string">"escapeLeft"</span>, <span class="string">"{{"</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-370">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-370">&#182;</a>
              </div>
              <p>Close return unescaped</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            [<span class="string">"returnRight"</span>, <span class="string">"}}}"</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-371">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-371">&#182;</a>
              </div>
              <p>Close tag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            [<span class="string">"right"</span>, <span class="string">"}}"</span>]],</pre></div></div>
            
        </li>
        
        
        <li id="section-372">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-372">&#182;</a>
              </div>
              <h2>Scanning Helpers</h2>
<p>This is an array of helpers that transform content that is within escaped tags like <code>{{token}}</code>. These helpers are solely for the scanning phase; they are unrelated to Mustache/Handlebars helpers which execute at render time. Each helper has a definition like the following:
    {
        // The content pattern to match in order to execute.
        // Only the first matching helper is executed.
        name: /pattern to match/,
        // The function to transform the content with.
        // @param {String} content   The content to transform.
        // @param {Object} cmd       Scanner helper data.
        //                           {
        //                             insert: &quot;insert command&quot;,
        //                             tagName: &quot;div&quot;,
        //                             status: 0
        //                           }
        fn: function(content, cmd) {
            return &#39;for text injection&#39; || 
                { raw: &#39;to bypass text injection&#39; };
        }
    }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            helpers: [</pre></div></div>
            
        </li>
        
        
        <li id="section-373">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-373">&#182;</a>
              </div>
              <h3>Partials</h3>
<p>Partials begin with a greater than sign, like {{&gt; box}}.
Partials are rendered at runtime (as opposed to compile time), 
so recursive partials are possible. Just avoid infinite loops.
For example, this template and partial:
        base.mustache:
            <h2>Names</h2>
            {{#names}}
                {{&gt; user}}
            {{/names}}
        user.mustache:
            <strong>{{name}}</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            {
                name: <span class="regexp">/^&gt;[\s]*\w*/</span>,
                fn: <span class="function"><span class="keyword">function</span> <span class="params">(content, cmd)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-374">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-374">&#182;</a>
              </div>
              <p>Get the template name and call back into the render method,
passing the name and the current context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> templateName = can.trim(content.replace(<span class="regexp">/^&gt;\s?/</span>, <span class="string">''</span>)).replace(<span class="regexp">/["|']/g</span>, <span class="string">""</span>);
                    <span class="keyword">return</span> <span class="string">"options.partials &amp;&amp; options.partials['"</span> + templateName + <span class="string">"'] ? can.Mustache.renderPartial(options.partials['"</span> + templateName + <span class="string">"'],"</span> + CONTEXT_STACK + <span class="string">".pop(),options) : can.Mustache.render('"</span> + templateName + <span class="string">"', "</span> + CONTEXT_STACK + <span class="string">")"</span>;
                }
            },</pre></div></div>
            
        </li>
        
        
        <li id="section-375">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-375">&#182;</a>
              </div>
              <h3>Data Hookup</h3>
<p>This will attach the data property of <code>this</code> to the element
its found on using the first argument as the data attribute
key.
For example:
    <li id="nameli" {{ data 'name' }}></li>
then later you can access it like:
    can.$(&#39;#nameli&#39;).data(&#39;name&#39;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            {
                name: <span class="regexp">/^\s*data\s/</span>,
                fn: <span class="function"><span class="keyword">function</span> <span class="params">(content, cmd)</span> {</span>
                    <span class="keyword">var</span> attr = content.match(<span class="regexp">/["|'](.*)["|']/</span>)[<span class="number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-376">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-376">&#182;</a>
              </div>
              <p>return a function which calls <code>can.data</code> on the element
with the attribute name with the current context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">return</span> <span class="string">"can.proxy(function(__){"</span> +</pre></div></div>
            
        </li>
        
        
        <li id="section-377">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-377">&#182;</a>
              </div>
              <p>&quot;var context = this[this.length-1];&quot; +
&quot;context = context.&quot; + STACKED + &quot; ? context[context.length-2] : context; console.warn(this, context);&quot; +</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="string">"can.data(can.$(__),'"</span> + attr + <span class="string">"', this.pop()); }, "</span> + CONTEXT_STACK + <span class="string">")"</span>;
                }
            },</pre></div></div>
            
        </li>
        
        
        <li id="section-378">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-378">&#182;</a>
              </div>
              <h3>Transformation (default)</h3>
<p>This transforms all content to its interpolated equivalent,
including calls to the corresponding helpers as applicable. 
This outputs the render code for almost all cases.</p>
<h4>Definitions</h4>
<ul>
<li><code>context</code> - This is the object that the current rendering context operates within. 
  Each nested template adds a new <code>context</code> to the context stack.</li>
<li><code>stack</code> - Mustache supports nested sections, 
  each of which add their own context to a stack of contexts.
  Whenever a token gets interpolated, it will check for a match against the 
  last context in the stack, then iterate through the rest of the stack checking for matches.
  The first match is the one that gets returned.</li>
<li><code>Mustache.txt</code> - This serializes a collection of logic, optionally contained within a section.
  If this is a simple interpolation, only the interpolation lookup will be passed.
  If this is a section, then an <code>options</code> object populated by the truthy (<code>options.fn</code>) and 
  falsey (<code>options.inverse</code>) encapsulated functions will also be passed. This section handling 
  exists to support the runtime context nesting that Mustache supports.</li>
<li><code>Mustache.get</code> - This resolves an interpolation reference given a stack of contexts.</li>
<li><code>options</code> - An object containing methods for executing the inner contents of sections or helpers.<br>  <code>options.fn</code> - Contains the inner template logic for a truthy section.<br>  <code>options.inverse</code> - Contains the inner template logic for a falsey section.<br>  <code>options.hash</code> - Contains the merged hash object argument for custom helpers.<h4>Design</h4>
This covers the design of the render code that the transformation helper generates.<h5>Pseudocode</h5>
A detailed explanation is provided in the following sections, but here is some brief pseudocode
that gives a high level overview of what the generated render code does (with a template similar to<br><code>&quot;{{#a}}{{b.c.d.e.name}}{{/a}}&quot; == &quot;Phil&quot;</code>).
<em>Initialize the render code.</em><pre><code>  view = []
  context = []
  stack = fn { context.concat([this]) }</code></pre>
<em>Render the root section.</em><pre><code>  view.push( &quot;string&quot; )
  view.push( can.view.txt(</code></pre>
<em>Render the nested section with <code>can.Mustache.txt</code>.</em><pre><code>      txt( </code></pre>
<em>Add the current context to the stack.</em><pre><code>          stack(), </code></pre>
<em>Flag this for truthy section mode.</em><pre><code>          &quot;#&quot;,</code></pre>
<em>Interpolate and check the <code>a</code> variable for truthyness using the stack with <code>can.Mustache.get</code>.</em><pre><code>          get( &quot;a&quot;, stack() ),</code></pre>
<em>Include the nested section&#39;s inner logic.
The stack argument is usually the parent section&#39;s copy of the stack, 
but it can be an override context that was passed by a custom helper.
Sections can nest <code>0..n</code> times -- <strong>NESTCEPTION</strong>.</em><pre><code>          { fn: fn(stack) {</code></pre>
<em>Render the nested section (everything between the <code>{{#a}}</code> and <code>{{/a}}</code> tokens).</em><pre><code>              view = []
              view.push( &quot;string&quot; )
              view.push(</code></pre>
<em>Add the current context to the stack.</em><pre><code>                  stack(),</code></pre>
<em>Flag this as interpolation-only mode.</em><pre><code>                  null,</code></pre>
<em>Interpolate the <code>b.c.d.e.name</code> variable using the stack.</em><pre><code>                  get( &quot;b.c.d.e.name&quot;, stack() ),
              )
              view.push( &quot;string&quot; )</code></pre>
<em>Return the result for the nested section.</em><pre><code>              return view.join()
          }}
      )
  ))
  view.push( &quot;string&quot; )</code></pre>
<em>Return the result for the root section, which includes all nested sections.</em><pre><code>  return view.join()</code></pre>
<h5>Initialization</h5>
Each rendered template is started with the following initialization code:<pre><code>  var ___v1ew = [];
  var ___c0nt3xt = [];
  ___c0nt3xt.___st4ck = true;
  var ___st4ck = function(context, self) {
      var s;
      if (arguments.length == 1 &amp;&amp; context) {
          s = !context.___st4ck ? [context] : context;
      } else {
          s = context &amp;&amp; context.___st4ck 
          ? context.concat([self]) 
          : ___st4ck(context).concat([self]);
      }
      return (s.___st4ck = true) &amp;&amp; s;
  };</code></pre>
The <code>___v1ew</code> is the the array used to serialize the view.
The <code>___c0nt3xt</code> is a stacking array of contexts that slices and expands with each nested section.
The <code>___st4ck</code> function is used to more easily update the context stack in certain situations.
Usually, the stack function simply adds a new context (<code>self</code>/<code>this</code>) to a context stack. 
However, custom helpers will occasionally pass override contexts that need their own context stack.<h5>Sections</h5>
Each section, <code>{{#section}} content {{/section}}</code>, within a Mustache template generates a section 
context in the resulting render code. The template itself is treated like a root section, with the 
same execution logic as any others. Each section can have <code>0..n</code> nested sections within it.
Here&#39;s an example of a template without any descendent sections.<br>Given the template: <code>&quot;{{a.b.c.d.e.name}}&quot; == &quot;Phil&quot;</code><br>Would output the following render code:
  <strong><em>v1ew.push(&quot;\&quot;&quot;);
  </em></strong>v1ew.push(can.view.txt(1, &#39;&#39;, 0, this, function() {<pre><code>      return can.Mustache.txt(___st4ck(___c0nt3xt, this), null, 
      can.Mustache.get(&quot;a.b.c.d.e.name&quot;, 
          ___st4ck(___c0nt3xt, this))
  );</code></pre>
  }));
  <strong><em>v1ew.push(&quot;\&quot; == \&quot;Phil\&quot;&quot;);
The simple strings will get appended to the view. Any interpolated references (like <code>{{a.b.c.d.e.name}}</code>) 
will be pushed onto the view via <code>can.view.txt</code> in order to support live binding.
The function passed to <code>can.view.txt</code> will call <code>can.Mustache.txt</code>, which serializes the object data by doing 
a context lookup with <code>can.Mustache.get</code>.
<code>can.Mustache.txt</code>&#39;s first argument is a copy of the context stack with the local context <code>this</code> added to it.
This stack will grow larger as sections nest.
The second argument is for the section type. This will be <code>&quot;#&quot;</code> for truthy sections, <code>&quot;^&quot;</code> for falsey, 
or <code>null</code> if it is an interpolation instead of a section.
The third argument is the interpolated value retrieved with <code>can.Mustache.get</code>, which will perform the 
context lookup and return the approriate string or object.
Any additional arguments, if they exist, are used for passing arguments to custom helpers.
For nested sections, the last argument is an <code>options</code> object that contains the nested section&#39;s logic.
Here&#39;s an example of a template with a single nested section.<br>Given the template: <code>&quot;{{#a}}{{b.c.d.e.name}}{{/a}}&quot; == &quot;Phil&quot;</code><br>Would output the following render code:
  </em></strong>v1ew.push(&quot;\&quot;&quot;);<pre><code>  ___v1ew.push(can.view.txt(0, &#39;&#39;, 0, this, function() {
      return can.Mustache.txt(___st4ck(___c0nt3xt, this), &quot;#&quot;, 
      can.Mustache.get(&quot;a&quot;, ___st4ck(___c0nt3xt, this)), 
          [{
              _: function() {
                  return ___v1ew.join(&quot;&quot;);
              }
          }, {
              fn: function(___c0nt3xt) {
                  var ___v1ew = [];
                  ___v1ew.push(can.view.txt(1, &#39;&#39;, 0, this, 
                      function() {
                           return can.Mustache.txt(
                              ___st4ck(___c0nt3xt, this), 
                              null, 
                              can.Mustache.get(&quot;b.c.d.e.name&quot;, 
                                  ___st4ck(___c0nt3xt, this))
                          );
                      }
                  ));
                  return ___v1ew.join(&quot;&quot;);
              }
          }]
  )
  }));</code></pre>
  <strong><em>v1ew.push(&quot;\&quot; == \&quot;Phil\&quot;&quot;);
This is specified as a truthy section via the <code>&quot;#&quot;</code> argument. The last argument includes an array of helper methods used with <code>options</code>.
These act similarly to custom helpers: <code>options.fn</code> will be called for truthy sections, <code>options.inverse</code> will be called for falsey sections.
The `options.</em><code>function only exists as a dummy function to make generating the section nesting easier (a section may have a</code>fn<code>,</code>inverse<code>,
or both, but there isn&#39;t any way to determine that at compilation time).
Within the</code>fn<code>function is the section&#39;s render context, which in this case will render anything between the</code>{{#a}}<code>and</code>{{/a}}<code>tokens.
This function has</code>_</strong>c0nt3xt<code>as an argument because custom helpers can pass their own override contexts. For any case where custom helpers
aren&#39;t used,</code><strong><em>c0nt3xt<code>will be equivalent to the</code></em></strong>st4ck(<strong><em>c0nt3xt, this)<code>stack created by its parent section. The</code>inverse<code>function
works similarly, except that it is added when</code>{{^a}}<code>and</code>{{else}}<code>are used.</code>var </em></strong>v1ew = []<code>is specified in</code>fn<code>and</code>inverse<code>to 
ensure that live binding in nested sections works properly.
All of these nested sections will combine to return a compiled string that functions similar to EJS in its uses of</code>can.view.txt`.<h4>Implementation</h4>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            {
                name: <span class="regexp">/^.*$/</span>,
                fn: <span class="function"><span class="keyword">function</span> <span class="params">(content, cmd)</span> {</span>
                    <span class="keyword">var</span> mode = <span class="literal">false</span>,
                        result = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-379">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-379">&#182;</a>
              </div>
              <p>Trim the content so we don&#39;t have any trailing whitespace.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    content = can.trim(content);</pre></div></div>
            
        </li>
        
        
        <li id="section-380">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-380">&#182;</a>
              </div>
              <p>Determine what the active mode is.
<em> <code>#</code> - Truthy section
</em> <code>^</code> - Falsey section
<em> <code>/</code> - Close the prior section
</em> <code>else</code> - Inverted section (only exists within a truthy/falsey section)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (content.length &amp;&amp; (mode = content.match(<span class="regexp">/^([#^/</span>]|<span class="keyword">else</span>$)/))) {
                        mode = mode[<span class="number">0</span>];
                        <span class="keyword">switch</span> (mode) {</pre></div></div>
            
        </li>
        
        
        <li id="section-381">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-381">&#182;</a>
              </div>
              <p>Open a new section.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">case</span> <span class="string">'#'</span>:
                        <span class="keyword">case</span> <span class="string">'^'</span>:
                            result.push(cmd.insert + <span class="string">'can.view.txt(0,\''</span> + cmd.tagName + <span class="string">'\','</span> + cmd.status + <span class="string">',this,function(){ return '</span>);
                            <span class="keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-382">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-382">&#182;</a>
              </div>
              <p>Close the prior section.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">case</span> <span class="string">'/'</span>:
                            <span class="keyword">return</span> {
                                raw: <span class="string">'return ___v1ew.join("");}}])}));'</span>
                            };
                            <span class="keyword">break</span>;
                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-383">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-383">&#182;</a>
              </div>
              <p>Trim the mode off of the content.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        content = content.substring(<span class="number">1</span>);
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-384">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-384">&#182;</a>
              </div>
              <p><code>else</code> helpers are special and should be skipped since they don&#39;t 
have any logic aside from kicking off an <code>inverse</code> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (mode != <span class="string">'else'</span>) {
                        <span class="keyword">var</span> args = [],
                            i = <span class="number">0</span>,
                            hashing = <span class="literal">false</span>,
                            arg, split, m;</pre></div></div>
            
        </li>
        
        
        <li id="section-385">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-385">&#182;</a>
              </div>
              <p>Parse the helper arguments.
This needs uses this method instead of a split(/\s/) so that 
strings with spaces can be correctly parsed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        (can.trim(content) + <span class="string">' '</span>).replace(<span class="regexp">/((([^\s]+?=)?('.*?'|".*?"))|.*?)\s/g</span>, <span class="function"><span class="keyword">function</span> <span class="params">(whole, part)</span> {</span>
                            args.push(part);
                        });</pre></div></div>
            
        </li>
        
        
        <li id="section-386">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-386">&#182;</a>
              </div>
              <p>Start the content render block.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        result.push(<span class="string">'can.Mustache.txt('</span> + CONTEXT_OBJ + <span class="string">','</span> + (mode ? <span class="string">'"'</span> + mode + <span class="string">'"'</span> : <span class="string">'null'</span>) + <span class="string">','</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-387">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-387">&#182;</a>
              </div>
              <p>Iterate through the helper arguments, if there are any.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">for</span> (; arg = args[i]; i++) {
                            i &amp;&amp; result.push(<span class="string">','</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-388">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-388">&#182;</a>
              </div>
              <p>Check for special helper arguments (string/number/boolean/hashes).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="keyword">if</span> (i &amp;&amp; (m = arg.match(<span class="regexp">/^(('.*?'|".*?"|[0-9.]+|true|false)|((.+?)=(('.*?'|".*?"|[0-9.]+|true|false)|(.+))))$/</span>))) {</pre></div></div>
            
        </li>
        
        
        <li id="section-389">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-389">&#182;</a>
              </div>
              <p>Found a native type like string/number/boolean.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="keyword">if</span> (m[<span class="number">2</span>]) {
                                    result.push(m[<span class="number">0</span>]);
                                }</pre></div></div>
            
        </li>
        
        
        <li id="section-390">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-390">&#182;</a>
              </div>
              <p>Found a hash object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-391">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-391">&#182;</a>
              </div>
              <p>Open the hash object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    <span class="keyword">if</span> (!hashing) {
                                        hashing = <span class="literal">true</span>;
                                        result.push(<span class="string">'{'</span> + HASH + <span class="string">':{'</span>);
                                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-392">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-392">&#182;</a>
              </div>
              <p>Add the key/value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    result.push(m[<span class="number">4</span>], <span class="string">':'</span>, m[<span class="number">6</span>] ? m[<span class="number">6</span>] : <span class="string">'can.Mustache.get("'</span> + m[<span class="number">5</span>].replace(<span class="regexp">/"/g</span>, <span class="string">'\\"'</span>) + <span class="string">'",'</span> + CONTEXT_OBJ + <span class="string">')'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-393">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-393">&#182;</a>
              </div>
              <p>Close the hash if this was the last argument.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    <span class="keyword">if</span> (i == args.length - <span class="number">1</span>) {
                                        result.push(<span class="string">'}}'</span>);
                                    }
                                }
                            }</pre></div></div>
            
        </li>
        
        
        <li id="section-394">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-394">&#182;</a>
              </div>
              <p>Otherwise output a normal interpolation reference.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="keyword">else</span> {
                                result.push(<span class="string">'can.Mustache.get("'</span> +</pre></div></div>
            
        </li>
        
        
        <li id="section-395">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-395">&#182;</a>
              </div>
              <p>Include the reference name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                arg.replace(<span class="regexp">/"/g</span>, <span class="string">'\\"'</span>) + <span class="string">'",'</span> +</pre></div></div>
            
        </li>
        
        
        <li id="section-396">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-396">&#182;</a>
              </div>
              <p>Then the stack of context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                CONTEXT_OBJ +</pre></div></div>
            
        </li>
        
        
        <li id="section-397">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-397">&#182;</a>
              </div>
              <p>Flag as a helper method to aid performance, 
if it is a known helper (anything with &gt; 0 arguments).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                (i == <span class="number">0</span> &amp;&amp; args.length &gt; <span class="number">1</span> ? <span class="string">',true'</span> : <span class="string">',false'</span>) + (i &gt; <span class="number">0</span> ? <span class="string">',true'</span> : <span class="string">',false'</span>) + <span class="string">')'</span>);
                            }
                        }
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-398">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-398">&#182;</a>
              </div>
              <p>Create an option object for sections of code.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    mode &amp;&amp; mode != <span class="string">'else'</span> &amp;&amp; result.push(<span class="string">',[{_:function(){'</span>);
                    <span class="keyword">switch</span> (mode) {</pre></div></div>
            
        </li>
        
        
        <li id="section-399">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-399">&#182;</a>
              </div>
              <p>Truthy section</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">'#'</span>:
                        result.push(<span class="string">'return ___v1ew.join("");}},{fn:function('</span> + CONTEXT + <span class="string">'){var ___v1ew = [];'</span>);
                        <span class="keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-400">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-400">&#182;</a>
              </div>
              <p>If/else section
Falsey section</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">'else'</span>:
                    <span class="keyword">case</span> <span class="string">'^'</span>:
                        result.push(<span class="string">'return ___v1ew.join("");}},{inverse:function('</span> + CONTEXT + <span class="string">'){var ___v1ew = [];'</span>);
                        <span class="keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-401">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-401">&#182;</a>
              </div>
              <p>Not a section</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">default</span>:
                        result.push(<span class="string">');'</span>);
                        <span class="keyword">break</span>;
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-402">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-402">&#182;</a>
              </div>
              <p>Return a raw result if there was a section, otherwise return the default string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    result = result.join(<span class="string">''</span>);
                    <span class="keyword">return</span> mode ? {
                        raw: result
                    } : result;
                }
            }]
        })
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-403">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-403">&#182;</a>
              </div>
              <p>Add in default scanner helpers first.
We could probably do this differently if we didn&#39;t &#39;break&#39; on every match.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> helpers = can.view.Scanner.prototype.helpers;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; helpers.length; i++) {
        Mustache.prototype.scanner.helpers.unshift(helpers[i]);
    };


    Mustache.txt = <span class="function"><span class="keyword">function</span> <span class="params">(context, mode, name)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-404">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-404">&#182;</a>
              </div>
              <p>Grab the extra arguments to pass to helpers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> args = Array.prototype.slice.call(arguments, <span class="number">3</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-405">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-405">&#182;</a>
              </div>
              <p>Create a default <code>options</code> object to pass to the helper.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            options = can.extend.apply(can, [{
                fn: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>},
                inverse: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>}
            }].concat(mode ? args.pop() : []));


        <span class="keyword">var</span> extra = {};
        <span class="keyword">if</span> (context.context) {
            extra = context.options;
            context = context.context;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-406">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-406">&#182;</a>
              </div>
              <p>Check for a registered helper or a helper-like function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (helper = (Mustache.getHelper(name, extra) || (can.isFunction(name) &amp;&amp; !name.isComputed &amp;&amp; {
            fn: name
        }))) {</pre></div></div>
            
        </li>
        
        
        <li id="section-407">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-407">&#182;</a>
              </div>
              <p>Use the most recent context as <code>this</code> for the helper.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> stack = context[STACKED] &amp;&amp; context,
                context = (stack &amp;&amp; context[context.length - <span class="number">1</span>]) || context,</pre></div></div>
            
        </li>
        
        
        <li id="section-408">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-408">&#182;</a>
              </div>
              <p>Update the options with a function/inverse (the inner templates of a section).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                opts = {
                    fn: can.proxy(options.fn, context),
                    inverse: can.proxy(options.inverse, context)
                },
                lastArg = args[args.length - <span class="number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-409">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-409">&#182;</a>
              </div>
              <p>Store the context stack in the options if one exists</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (stack) {
                opts.contexts = stack;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-410">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-410">&#182;</a>
              </div>
              <p>Add the hash to <code>options</code> if one exists</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (lastArg &amp;&amp; lastArg[HASH]) {
                opts.hash = args.pop()[HASH];
            }
            args.push(opts);</pre></div></div>
            
        </li>
        
        
        <li id="section-411">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-411">&#182;</a>
              </div>
              <p>Call the helper.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> helper.fn.apply(context, args) || <span class="string">''</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-412">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-412">&#182;</a>
              </div>
              <p>if a compute, get the value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (can.isFunction(name) &amp;&amp; name.isComputed) {
            name = name();
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-413">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-413">&#182;</a>
              </div>
              <p>An array of arguments to check for truthyness when evaluating sections.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> validArgs = args.length ? args : [name],</pre></div></div>
            
        </li>
        
        
        <li id="section-414">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-414">&#182;</a>
              </div>
              <p>Whether the arguments meet the condition of the section.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            valid = <span class="literal">true</span>,
            result = [],
            i, helper, argIsObserve, arg;</pre></div></div>
            
        </li>
        
        
        <li id="section-415">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-415">&#182;</a>
              </div>
              <p>Validate the arguments based on the section mode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (mode) {
            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; validArgs.length; i++) {
                arg = validArgs[i];
                argIsObserve = <span class="keyword">typeof</span> arg !== <span class="string">'undefined'</span> &amp;&amp; isObserve(arg);</pre></div></div>
            
        </li>
        
        
        <li id="section-416">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-416">&#182;</a>
              </div>
              <p>Array-like objects are falsey if their length = 0.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (isArrayLike(arg)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-417">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-417">&#182;</a>
              </div>
              <p>Use .attr to trigger binding on empty lists returned from function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (mode == <span class="string">'#'</span>) {
                        valid = valid &amp;&amp; !! (argIsObserve ? arg.attr(<span class="string">'length'</span>) : arg.length);
                    } <span class="keyword">else</span> <span class="keyword">if</span> (mode == <span class="string">'^'</span>) {
                        valid = valid &amp;&amp; !(argIsObserve ? arg.attr(<span class="string">'length'</span>) : arg.length);
                    }
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-418">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-418">&#182;</a>
              </div>
              <p>Otherwise just check if it is truthy or not.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">else</span> {
                    valid = mode == <span class="string">'#'</span> ? valid &amp;&amp; !! arg : mode == <span class="string">'^'</span> ? valid &amp;&amp; !arg : valid;
                }
            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-419">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-419">&#182;</a>
              </div>
              <p>Otherwise interpolate like normal.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (valid) {
            <span class="keyword">switch</span> (mode) {</pre></div></div>
            
        </li>
        
        
        <li id="section-420">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-420">&#182;</a>
              </div>
              <p>Truthy section.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">case</span> <span class="string">'#'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-421">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-421">&#182;</a>
              </div>
              <p>Iterate over arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (isArrayLike(name)) {
                    <span class="keyword">var</span> isObserveList = isObserve(name);</pre></div></div>
            
        </li>
        
        
        <li id="section-422">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-422">&#182;</a>
              </div>
              <p>Add the reference to the list in the contexts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; name.length; i++) {
                        result.push(options.fn.call(name[i], context) || <span class="string">''</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-423">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-423">&#182;</a>
              </div>
              <p>Ensure that live update works on observable lists</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        isObserveList &amp;&amp; name.attr(<span class="string">''</span> + i);
                    }
                    <span class="keyword">return</span> result.join(<span class="string">''</span>);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-424">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-424">&#182;</a>
              </div>
              <p>Normal case.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">else</span> {
                    <span class="keyword">return</span> options.fn.call(name || {}, context) || <span class="string">''</span>;
                }
                <span class="keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-425">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-425">&#182;</a>
              </div>
              <p>Falsey section.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">case</span> <span class="string">'^'</span>:
                <span class="keyword">return</span> options.inverse.call(name || {}, context) || <span class="string">''</span>;
                <span class="keyword">break</span>;
            <span class="keyword">default</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-426">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-426">&#182;</a>
              </div>
              <p>Add + &#39;&#39; to convert things like numbers to strings.
This can cause issues if you are trying to
eval on the length but this is the more
common case.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">return</span> <span class="string">''</span> + (name !== <span class="literal">undefined</span> ? name : <span class="string">''</span>);
                <span class="keyword">break</span>;
            }
        }

        <span class="keyword">return</span> <span class="string">''</span>;
    };


    Mustache.get = <span class="function"><span class="keyword">function</span> <span class="params">(ref, contexts, isHelper, isArgument)</span> {</span>
        <span class="keyword">var</span> options = contexts.options || {};
        contexts = contexts.context || contexts;</pre></div></div>
            
        </li>
        
        
        <li id="section-427">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-427">&#182;</a>
              </div>
              <p>Assume the local object is the last context in the stack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> obj = contexts[contexts.length - <span class="number">1</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-428">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-428">&#182;</a>
              </div>
              <p>Assume the parent context is the second to last context in the stack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            context = contexts[contexts.length - <span class="number">2</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-429">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-429">&#182;</a>
              </div>
              <p>Split the reference (like <code>a.b.c</code>) into an array of key names.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            names = ref.split(<span class="string">'.'</span>),
            namesLength = names.length,
            value, lastValue, name, i, j,</pre></div></div>
            
        </li>
        
        
        <li id="section-430">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-430">&#182;</a>
              </div>
              <p>if we walk up and don&#39;t find a property, we default
to listening on an undefined property of the first
context that is an observe</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            defaultObserve, defaultObserveName;</pre></div></div>
            
        </li>
        
        
        <li id="section-431">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-431">&#182;</a>
              </div>
              <p>Handle <code>this</code> references for list iteration: {{.}} or {{this}}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (<span class="regexp">/^\.|this$/</span>.test(ref)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-432">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-432">&#182;</a>
              </div>
              <p>If context isn&#39;t an object, then it was a value passed by a helper so use it as an override.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (!<span class="regexp">/^object|undefined$/</span>.test(<span class="keyword">typeof</span> context)) {
                <span class="keyword">return</span> context || <span class="string">''</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-433">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-433">&#182;</a>
              </div>
              <p>Otherwise just return the closest object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">else</span> {
                <span class="keyword">while</span> (value = contexts.pop()) {
                    <span class="keyword">if</span> (<span class="keyword">typeof</span> value !== <span class="string">'undefined'</span>) {
                        <span class="keyword">return</span> value;
                    }
                }
                <span class="keyword">return</span> <span class="string">''</span>;
            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-434">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-434">&#182;</a>
              </div>
              <p>Handle object resolution (like <code>a.b.c</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">else</span> <span class="keyword">if</span> (!isHelper) {</pre></div></div>
            
        </li>
        
        
        <li id="section-435">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-435">&#182;</a>
              </div>
              <p>Reverse iterate through the contexts (last in, first out).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">for</span> (i = contexts.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {</pre></div></div>
            
        </li>
        
        
        <li id="section-436">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-436">&#182;</a>
              </div>
              <p>Check the context for the reference</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                value = contexts[i];</pre></div></div>
            
        </li>
        
        
        <li id="section-437">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-437">&#182;</a>
              </div>
              <p>Is the value a compute?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (can.isFunction(value) &amp;&amp; value.isComputed) {
                    value = value();
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-438">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-438">&#182;</a>
              </div>
              <p>Make sure the context isn&#39;t a failed object before diving into it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (<span class="keyword">typeof</span> value !== <span class="string">'undefined'</span> &amp;&amp; value !== <span class="literal">null</span>) {
                    <span class="keyword">var</span> isHelper = Mustache.getHelper(ref, options);
                    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; namesLength; j++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-439">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-439">&#182;</a>
              </div>
              <p>Keep running up the tree while there are matches.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (<span class="keyword">typeof</span> value[names[j]] !== <span class="string">'undefined'</span> &amp;&amp; value[names[j]] !== <span class="literal">null</span>) {
                            lastValue = value;
                            value = value[name = names[j]];
                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-440">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-440">&#182;</a>
              </div>
              <p>if there&#39;s a name conflict between property and helper
property wins</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">else</span> <span class="keyword">if</span> (isHelper) {
                            <span class="keyword">return</span> ref;
                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-441">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-441">&#182;</a>
              </div>
              <p>If it&#39;s undefined, still match if the parent is an Observe.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">else</span> <span class="keyword">if</span> (isObserve(value)) {
                            defaultObserve = value;
                            defaultObserveName = names[j];
                            lastValue = value = <span class="literal">undefined</span>;
                            <span class="keyword">break</span>;
                        }
                        <span class="keyword">else</span> {
                            lastValue = value = <span class="literal">undefined</span>;
                            <span class="keyword">break</span>;
                        }
                    }
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-442">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-442">&#182;</a>
              </div>
              <p>Found a matched reference.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (value !== <span class="literal">undefined</span>) {
                    <span class="keyword">return</span> Mustache.resolve(value, lastValue, name, isArgument);
                }
            }
        }

        <span class="keyword">if</span> (defaultObserve &amp;&amp;</pre></div></div>
            
        </li>
        
        
        <li id="section-443">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-443">&#182;</a>
              </div>
              <p>if there&#39;s not a helper by this name and no attribute with this name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        !(Mustache.getHelper(ref) &amp;&amp; can.inArray(defaultObserveName, can.Observe.keys(defaultObserve)) === -<span class="number">1</span>)) {
            <span class="keyword">return</span> defaultObserve.compute(defaultObserveName);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-444">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-444">&#182;</a>
              </div>
              <p>Support helpers without arguments, but only if there wasn&#39;t a matching data reference.
Helpers have priority over local function, see <a href="https://github.com/bitovi/canjs/issues/258">https://github.com/bitovi/canjs/issues/258</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (value = Mustache.getHelper(ref, options)) {
            <span class="keyword">return</span> ref;
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">'undefined'</span> &amp;&amp; obj !== <span class="literal">null</span> &amp;&amp; can.isFunction(obj[ref])) {</pre></div></div>
            
        </li>
        
        
        <li id="section-445">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-445">&#182;</a>
              </div>
              <p>Support helper-like functions as anonymous helpers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> obj[ref];
        }

        <span class="keyword">return</span> <span class="string">''</span>;
    };


    Mustache.resolve = <span class="function"><span class="keyword">function</span> <span class="params">(value, lastValue, name, isArgument)</span> {</span>
        <span class="keyword">if</span> (lastValue &amp;&amp; can.isFunction(lastValue[name]) &amp;&amp; isArgument) {
            <span class="keyword">if</span> (lastValue[name].isComputed) {
                <span class="keyword">return</span> lastValue[name];
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-446">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-446">&#182;</a>
              </div>
              <p>Don&#39;t execute functions if they are parameters for a helper and are not a can.compute
Need to bind it to the original context so that that information doesn&#39;t get lost by the helper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                <span class="keyword">return</span> lastValue[name].apply(lastValue, arguments);
            };
        } <span class="keyword">else</span> <span class="keyword">if</span> (lastValue &amp;&amp; can.isFunction(lastValue[name])) {</pre></div></div>
            
        </li>
        
        
        <li id="section-447">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-447">&#182;</a>
              </div>
              <p>Support functions stored in objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> lastValue[name]();
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-448">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-448">&#182;</a>
              </div>
              <p>Invoke the length to ensure that Observe.List events fire.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">else</span> <span class="keyword">if</span> (isObserve(value) &amp;&amp; isArrayLike(value) &amp;&amp; value.attr(<span class="string">'length'</span>)) {
            <span class="keyword">return</span> value;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-449">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-449">&#182;</a>
              </div>
              <p>Add support for observes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">else</span> <span class="keyword">if</span> (lastValue &amp;&amp; isObserve(lastValue)) {
            <span class="keyword">return</span> lastValue.compute(name);
        }
        <span class="keyword">else</span> <span class="keyword">if</span> (can.isFunction(value)) {
            <span class="keyword">return</span> value();
        }
        <span class="keyword">else</span> {
            <span class="keyword">return</span> value;
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-450">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-450">&#182;</a>
              </div>
              <h2>Helpers</h2>
<p>Helpers are functions that can be called from within a template.
These helpers differ from the scanner helpers in that they execute
at runtime instead of during compilation.
Custom helpers can be added via <code>can.Mustache.registerHelper</code>,
but there are also some built-in helpers included by default.
Most of the built-in helpers are little more than aliases to actions 
that the base version of Mustache simply implies based on the 
passed in object.
Built-in helpers:
<em> <code>data</code> - <code>data</code> is a special helper that is implemented via scanning helpers. 
    It hooks up the active element to the active data object: <code>&lt;div {{data &quot;key&quot;}} /&gt;</code>
</em> <code>if</code> - Renders a truthy section: <code>{{#if var}} render {{/if}}</code>
<em> <code>unless</code> - Renders a falsey section: <code>{{#unless var}} render {{/unless}}</code>
</em> <code>each</code> - Renders an array: <code>{{#each array}} render {{this}} {{/each}}</code>
* <code>with</code> - Opens a context section: <code>{{#with var}} render {{/with}}</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Mustache._helpers = {};

    Mustache.registerHelper = <span class="function"><span class="keyword">function</span> <span class="params">(name, fn)</span> {</span>
        <span class="keyword">this</span>._helpers[name] = {
            name: name,
            fn: fn
        };
    };


    Mustache.getHelper = <span class="function"><span class="keyword">function</span> <span class="params">(name, options)</span> {</span>
        <span class="keyword">return</span> options &amp;&amp; options.helpers &amp;&amp; options.helpers[name] &amp;&amp; {
            fn: options.helpers[name]
        } || <span class="keyword">this</span>._helpers[name]
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, helper; helper = [i]; i++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-451">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-451">&#182;</a>
              </div>
              <p>Find the correct helper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (helper.name == name) {
                <span class="keyword">return</span> helper;
            }
        }
        <span class="keyword">return</span> <span class="literal">null</span>;
    };


    Mustache.render = <span class="function"><span class="keyword">function</span> <span class="params">(partial, context)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-452">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-452">&#182;</a>
              </div>
              <p>Make sure the partial being passed in
isn&#39;t a variable like { partial: &quot;foo.mustache&quot; }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (!can.view.cached[partial] &amp;&amp; context[partial]) {
            partial = context[partial];
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-453">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-453">&#182;</a>
              </div>
              <p>Call into <code>can.view.render</code> passing the
partial and context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> can.view.render(partial, context);
    };

    Mustache.renderPartial = <span class="function"><span class="keyword">function</span> <span class="params">(partial, context, options)</span> {</span>
        <span class="keyword">return</span> partial.render ? partial.render(context, options) : partial(context, options);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-454">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-454">&#182;</a>
              </div>
              <p>The built-in Mustache helpers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    can.each({</pre></div></div>
            
        </li>
        
        
        <li id="section-455">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-455">&#182;</a>
              </div>
              <p>Implements the <code>if</code> built-in helper.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="string">'if'</span>: <span class="function"><span class="keyword">function</span> <span class="params">(expr, options)</span> {</span>
            <span class="keyword">if</span> ( !! Mustache.resolve(expr)) {
                <span class="keyword">return</span> options.fn(options.contexts || <span class="keyword">this</span>);
            }
            <span class="keyword">else</span> {
                <span class="keyword">return</span> options.inverse(options.contexts || <span class="keyword">this</span>);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-456">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-456">&#182;</a>
              </div>
              <p>Implements the <code>unless</code> built-in helper.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="string">'unless'</span>: <span class="function"><span class="keyword">function</span> <span class="params">(expr, options)</span> {</span>
            <span class="keyword">if</span> (!Mustache.resolve(expr)) {
                <span class="keyword">return</span> options.fn(options.contexts || <span class="keyword">this</span>);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-457">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-457">&#182;</a>
              </div>
              <p>Implements the <code>each</code> built-in helper.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="string">'each'</span>: <span class="function"><span class="keyword">function</span> <span class="params">(expr, options)</span> {</span>
            expr = Mustache.resolve(expr);
            <span class="keyword">if</span> ( !! expr &amp;&amp; expr.length) {
                <span class="keyword">var</span> result = [];
                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; expr.length; i++) {
                    result.push(options.fn(expr[i]));
                }
                <span class="keyword">return</span> result.join(<span class="string">''</span>);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-458">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-458">&#182;</a>
              </div>
              <p>Implements the <code>with</code> built-in helper.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="string">'with'</span>: <span class="function"><span class="keyword">function</span> <span class="params">(expr, options)</span> {</span>
            <span class="keyword">var</span> ctx = expr;
            expr = Mustache.resolve(expr);
            <span class="keyword">if</span> ( !! expr) {
                <span class="keyword">return</span> options.fn(ctx);
            }
        }

    }, <span class="function"><span class="keyword">function</span> <span class="params">(fn, name)</span> {</span>
        Mustache.registerHelper(name, fn);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-459">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-459">&#182;</a>
              </div>
              <h2>Registration</h2>
<p>Registers Mustache with can.view.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    can.view.register({
        suffix: <span class="string">"mustache"</span>,

        contentType: <span class="string">"x-mustache-template"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-460">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-460">&#182;</a>
              </div>
              <p>Returns a <code>function</code> that renders the view.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        script: <span class="function"><span class="keyword">function</span> <span class="params">(id, src)</span> {</span>
            <span class="keyword">return</span> <span class="string">"can.Mustache(function(_CONTEXT,_VIEW) { "</span> + <span class="keyword">new</span> Mustache({
                text: src,
                name: id
            }).template.out + <span class="string">" })"</span>;
        },

        renderer: <span class="function"><span class="keyword">function</span> <span class="params">(id, text)</span> {</span>
            <span class="keyword">return</span> Mustache({
                text: text,
                name: id
            });
        }
    });

    <span class="keyword">return</span> can;
})(module[<span class="string">"can/util/jquery/jquery.js"</span>], module[<span class="string">"can/view/view.js"</span>], module[<span class="string">"can/view/scanner.js"</span>], module[<span class="string">"can/observe/compute/compute.js"</span>], module[<span class="string">"can/view/render.js"</span>]); <span class="comment">// ## can/view/modifiers/modifiers.js</span>
module[<span class="string">'can/view/modifiers/modifiers.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">($, can)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-461">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-461">&#182;</a>
              </div>
              <p>---- ADD jQUERY HELPERS -----
converts jquery functions to use views    </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> convert, modify, isTemplate, isHTML, isDOM, getCallback,</pre></div></div>
            
        </li>
        
        
        <li id="section-462">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-462">&#182;</a>
              </div>
              <p>text and val cannot produce an element, so don&#39;t run hookups on them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    noHookup = {
        <span class="string">'val'</span>: <span class="literal">true</span>,
        <span class="string">'text'</span>: <span class="literal">true</span>
    };

    convert = <span class="function"><span class="keyword">function</span> <span class="params">(func_name)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-463">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-463">&#182;</a>
              </div>
              <p>save the old jQuery helper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> old = $.fn[func_name];</pre></div></div>
            
        </li>
        
        
        <li id="section-464">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-464">&#182;</a>
              </div>
              <p>replace it with our new helper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        $.fn[func_name] = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>

            <span class="keyword">var</span> args = can.makeArray(arguments),
                callbackNum, callback, self = <span class="keyword">this</span>,
                result;</pre></div></div>
            
        </li>
        
        
        <li id="section-465">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-465">&#182;</a>
              </div>
              <p>if the first arg is a deferred
wait until it finishes, and call
modify with the result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (can.isDeferred(args[<span class="number">0</span>])) {
                args[<span class="number">0</span>].done(<span class="function"><span class="keyword">function</span> <span class="params">(res)</span> {</span>
                    modify.call(self, [res], old);
                })
                <span class="keyword">return</span> <span class="keyword">this</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-466">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-466">&#182;</a>
              </div>
              <p>check if a template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">else</span> <span class="keyword">if</span> (isTemplate(args)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-467">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-467">&#182;</a>
              </div>
              <p>if we should operate async</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> ((callbackNum = getCallback(args))) {
                    callback = args[callbackNum];
                    args[callbackNum] = <span class="function"><span class="keyword">function</span> <span class="params">(result)</span> {</span>
                        modify.call(self, [result], old);
                        callback.call(self, result);
                    };
                    can.view.apply(can.view, args);
                    <span class="keyword">return</span> <span class="keyword">this</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-468">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-468">&#182;</a>
              </div>
              <p>call view with args (there might be deferreds)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                result = can.view.apply(can.view, args);</pre></div></div>
            
        </li>
        
        
        <li id="section-469">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-469">&#182;</a>
              </div>
              <p>if we got a string back</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (!can.isDeferred(result)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-470">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-470">&#182;</a>
              </div>
              <p>we are going to call the old method with that string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    args = [result];
                } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-471">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-471">&#182;</a>
              </div>
              <p>if there is a deferred, wait until it is done before calling modify</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    result.done(<span class="function"><span class="keyword">function</span> <span class="params">(res)</span> {</span>
                        modify.call(self, [res], old);
                    })
                    <span class="keyword">return</span> <span class="keyword">this</span>;
                }
            }
            <span class="keyword">return</span> noHookup[func_name] ? old.apply(<span class="keyword">this</span>, args) : modify.call(<span class="keyword">this</span>, args, old);
        };
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-472">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-472">&#182;</a>
              </div>
              <p>modifies the content of the element
but also will run any hookup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    modify = <span class="function"><span class="keyword">function</span> <span class="params">(args, old)</span> {</span>
        <span class="keyword">var</span> res, stub, hooks;</pre></div></div>
            
        </li>
        
        
        <li id="section-473">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-473">&#182;</a>
              </div>
              <p>check if there are new hookups</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">for</span> (<span class="keyword">var</span> hasHookups <span class="keyword">in</span> can.view.hookups) {
            <span class="keyword">break</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-474">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-474">&#182;</a>
              </div>
              <p>if there are hookups, turn into a frag
and insert that
by using a frag, the element can be recursively hooked up
before insterion</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (hasHookups &amp;&amp; args[<span class="number">0</span>] &amp;&amp; isHTML(args[<span class="number">0</span>])) {
            args[<span class="number">0</span>] = can.view.frag(args[<span class="number">0</span>]).childNodes;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-475">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-475">&#182;</a>
              </div>
              <p>then insert into DOM</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res = old.apply(<span class="keyword">this</span>, args);

        <span class="keyword">return</span> res;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-476">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-476">&#182;</a>
              </div>
              <p>returns true or false if the args indicate a template is being used
$(&#39;#foo&#39;).html(&#39;/path/to/template.ejs&#39;,{data})
in general, we want to make sure the first arg is a string
and the second arg is data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    isTemplate = <span class="function"><span class="keyword">function</span> <span class="params">(args)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-477">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-477">&#182;</a>
              </div>
              <p>save the second arg type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> secArgType = <span class="keyword">typeof</span> args[<span class="number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-478">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-478">&#182;</a>
              </div>
              <p>the first arg is a string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> <span class="keyword">typeof</span> args[<span class="number">0</span>] == <span class="string">"string"</span> &amp;&amp;</pre></div></div>
            
        </li>
        
        
        <li id="section-479">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-479">&#182;</a>
              </div>
              <p>the second arg is an object or function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        (secArgType == <span class="string">'object'</span> || secArgType == <span class="string">'function'</span>) &amp;&amp;</pre></div></div>
            
        </li>
        
        
        <li id="section-480">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-480">&#182;</a>
              </div>
              <p>but it is not a dom element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        !isDOM(args[<span class="number">1</span>]);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-481">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-481">&#182;</a>
              </div>
              <p>returns true if the arg is a jQuery object or HTMLElement</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    isDOM = <span class="function"><span class="keyword">function</span> <span class="params">(arg)</span> {</span>
        <span class="keyword">return</span> arg.nodeType || (arg[<span class="number">0</span>] &amp;&amp; arg[<span class="number">0</span>].nodeType)
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-482">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-482">&#182;</a>
              </div>
              <p>returns whether the argument is some sort of HTML data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    isHTML = <span class="function"><span class="keyword">function</span> <span class="params">(arg)</span> {</span>
        <span class="keyword">if</span> (isDOM(arg)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-483">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-483">&#182;</a>
              </div>
              <p>if jQuery object or DOM node we&#39;re good</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> <span class="literal">true</span>;
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> arg === <span class="string">"string"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-484">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-484">&#182;</a>
              </div>
              <p>if string, do a quick sanity check that we&#39;re HTML</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            arg = can.trim(arg);
            <span class="keyword">return</span> arg.substr(<span class="number">0</span>, <span class="number">1</span>) === <span class="string">"&lt;"</span> &amp;&amp; arg.substr(arg.length - <span class="number">1</span>, <span class="number">1</span>) === <span class="string">"&gt;"</span> &amp;&amp; arg.length &gt;= <span class="number">3</span>;
        } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-485">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-485">&#182;</a>
              </div>
              <p>don&#39;t know what you are</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> <span class="literal">false</span>;
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-486">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-486">&#182;</a>
              </div>
              <p>returns the callback arg number if there is one (for async view use)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    getCallback = <span class="function"><span class="keyword">function</span> <span class="params">(args)</span> {</span>
        <span class="keyword">return</span> <span class="keyword">typeof</span> args[<span class="number">3</span>] === <span class="string">'function'</span> ? <span class="number">3</span> : <span class="keyword">typeof</span> args[<span class="number">2</span>] === <span class="string">'function'</span> &amp;&amp; <span class="number">2</span>;
    };


    $.fn.hookup = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        can.view.frag(<span class="keyword">this</span>);
        <span class="keyword">return</span> <span class="keyword">this</span>;
    };


    can.each([

    <span class="string">"prepend"</span>,

    <span class="string">"append"</span>,

    <span class="string">"after"</span>,

    <span class="string">"before"</span>,

    <span class="string">"text"</span>,

    <span class="string">"html"</span>,

    <span class="string">"replaceWith"</span>, <span class="string">"val"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(func)</span> {</span>
        convert(func);
    });

    <span class="keyword">return</span> can;
})(module[<span class="string">"jquery/jquery.js"</span>], module[<span class="string">"can/view/view.js"</span>]); <span class="comment">// ## can/observe/observe.js</span>
module[<span class="string">'can/observe/observe.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-487">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-487">&#182;</a>
              </div>
              <h2>observe.js</h2>
<p><code>can.Observe</code><br><em>Provides the observable pattern for JavaScript Objects.</em><br>Returns <code>true</code> if something is an object with properties of its own.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> canMakeObserve = <span class="function"><span class="keyword">function</span> <span class="params">(obj)</span> {</span>
        <span class="keyword">return</span> obj &amp;&amp; (can.isArray(obj) || can.isPlainObject(obj) || (obj <span class="keyword">instanceof</span> can.Observe));
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-488">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-488">&#182;</a>
              </div>
              <p>Removes all listeners.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        unhookup = <span class="function"><span class="keyword">function</span> <span class="params">(items, namespace)</span> {</span>
            <span class="keyword">return</span> can.each(items, <span class="function"><span class="keyword">function</span> <span class="params">(item)</span> {</span>
                <span class="keyword">if</span> (item &amp;&amp; item.unbind) {
                    item.unbind(<span class="string">"change"</span> + namespace);
                }
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-489">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-489">&#182;</a>
              </div>
              <p>Listens to changes on <code>val</code> and &quot;bubbles&quot; the event up.<br><code>val</code> - The object to listen for changes on.<br><code>prop</code> - The property name is at on.<br><code>parent</code> - The parent object of prop.
<code>ob</code> - (optional) The Observe object constructor
<code>list</code> - (optional) The observable list constructor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        hookupBubble = <span class="function"><span class="keyword">function</span> <span class="params">(val, prop, parent, Ob, List)</span> {</span>
            Ob = Ob || Observe;
            List = List || Observe.List;</pre></div></div>
            
        </li>
        
        
        <li id="section-490">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-490">&#182;</a>
              </div>
              <p>If it&#39;s an <code>array</code> make a list, otherwise a val.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (val <span class="keyword">instanceof</span> Observe) {</pre></div></div>
            
        </li>
        
        
        <li id="section-491">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-491">&#182;</a>
              </div>
              <p>We have an <code>observe</code> already...
Make sure it is not listening to this already</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                unhookup([val], parent._cid);
            } <span class="keyword">else</span> <span class="keyword">if</span> (can.isArray(val)) {
                val = <span class="keyword">new</span> List(val);
            } <span class="keyword">else</span> {
                val = <span class="keyword">new</span> Ob(val);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-492">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-492">&#182;</a>
              </div>
              <p>Listen to all changes and <code>batchTrigger</code> upwards.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            val.bind(<span class="string">"change"</span> + parent._cid, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-493">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-493">&#182;</a>
              </div>
              <p><code>batchTrigger</code> the type on this...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> args = can.makeArray(arguments),
                    ev = args.shift();
                args[<span class="number">0</span>] = (prop === <span class="string">"*"</span> ? [parent.indexOf(val), args[<span class="number">0</span>]] : [prop, args[<span class="number">0</span>]]).join(<span class="string">"."</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-494">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-494">&#182;</a>
              </div>
              <p>track objects dispatched on this observe        </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                ev.triggeredNS = ev.triggeredNS || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-495">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-495">&#182;</a>
              </div>
              <p>if it has already been dispatched exit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (ev.triggeredNS[parent._cid]) {
                    <span class="keyword">return</span>;
                }

                ev.triggeredNS[parent._cid] = <span class="literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-496">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-496">&#182;</a>
              </div>
              <p>send change event with modified attr to parent    </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                can.trigger(parent, ev, args);</pre></div></div>
            
        </li>
        
        
        <li id="section-497">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-497">&#182;</a>
              </div>
              <p>send modified attr event to parent
can.trigger(parent, args[0], args);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            });

            <span class="keyword">return</span> val;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-498">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-498">&#182;</a>
              </div>
              <p>An <code>id</code> to track events for a given observe.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        observeId = <span class="number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-499">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-499">&#182;</a>
              </div>
              <p>A helper used to serialize an <code>Observe</code> or <code>Observe.List</code>.<br><code>observe</code> - The observable.<br><code>how</code> - To serialize with <code>attr</code> or <code>serialize</code>.<br><code>where</code> - To put properties, in an <code>{}</code> or <code>[]</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        serialize = <span class="function"><span class="keyword">function</span> <span class="params">(observe, how, where)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-500">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-500">&#182;</a>
              </div>
              <p>Go through each property.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            observe.each(<span class="function"><span class="keyword">function</span> <span class="params">(val, name)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-501">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-501">&#182;</a>
              </div>
              <p>If the value is an <code>object</code>, and has an <code>attrs</code> or <code>serialize</code> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                where[name] = canMakeObserve(val) &amp;&amp; can.isFunction(val[how]) ?</pre></div></div>
            
        </li>
        
        
        <li id="section-502">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-502">&#182;</a>
              </div>
              <p>Call <code>attrs</code> or <code>serialize</code> to get the original data back.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                val[how]() :</pre></div></div>
            
        </li>
        
        
        <li id="section-503">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-503">&#182;</a>
              </div>
              <p>Otherwise return the value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                val;
            });
            <span class="keyword">return</span> where;
        },
        $method = <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> {</span>
            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                <span class="keyword">return</span> can[name].apply(<span class="keyword">this</span>, arguments);
            };
        },
        bind = $method(<span class="string">'addEvent'</span>),
        unbind = $method(<span class="string">'removeEvent'</span>),
        attrParts = <span class="function"><span class="keyword">function</span> <span class="params">(attr, keepKey)</span> {</span>
            <span class="keyword">if</span> (keepKey) {
                <span class="keyword">return</span> [attr];
            }
            <span class="keyword">return</span> can.isArray(attr) ? attr : (<span class="string">""</span> + attr).split(<span class="string">"."</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-504">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-504">&#182;</a>
              </div>
              <p>Which batch of events this is for -- might not want to send multiple
messages on the same batch.  This is mostly for event delegation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        batchNum = <span class="number">1</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-505">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-505">&#182;</a>
              </div>
              <p>how many times has start been called without a stop</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        transactions = <span class="number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-506">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-506">&#182;</a>
              </div>
              <p>an array of events within a transaction</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        batchEvents = [],
        stopCallbacks = [];




    <span class="keyword">var</span> Observe = can.Observe = can.Construct({</pre></div></div>
            
        </li>
        
        
        <li id="section-507">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-507">&#182;</a>
              </div>
              <p>keep so it can be overwritten</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        bind: bind,
        unbind: unbind,
        id: <span class="string">"id"</span>,
        canMakeObserve: canMakeObserve,</pre></div></div>
            
        </li>
        
        
        <li id="section-508">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-508">&#182;</a>
              </div>
              <p>starts collecting events
takes a callback for after they are updated
how could you hook into after ejs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        startBatch: <span class="function"><span class="keyword">function</span> <span class="params">(batchStopHandler)</span> {</span>
            transactions++;
            batchStopHandler &amp;&amp; stopCallbacks.push(batchStopHandler);
        },

        stopBatch: <span class="function"><span class="keyword">function</span> <span class="params">(force, callStart)</span> {</span>
            <span class="keyword">if</span> (force) {
                transactions = <span class="number">0</span>;
            } <span class="keyword">else</span> {
                transactions--;
            }

            <span class="keyword">if</span> (transactions == <span class="number">0</span>) {
                <span class="keyword">var</span> items = batchEvents.slice(<span class="number">0</span>),
                    callbacks = stopCallbacks.slice(<span class="number">0</span>);
                batchEvents = [];
                stopCallbacks = [];
                batchNum++;
                callStart &amp;&amp; <span class="keyword">this</span>.startBatch();
                can.each(items, <span class="function"><span class="keyword">function</span> <span class="params">(args)</span> {</span>
                    can.trigger.apply(can, args);
                });
                can.each(callbacks, <span class="function"><span class="keyword">function</span> <span class="params">(cb)</span> {</span>
                    cb();
                });
            }
        },

        triggerBatch: <span class="function"><span class="keyword">function</span> <span class="params">(item, event, args)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-509">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-509">&#182;</a>
              </div>
              <p>Don&#39;t send events if initalizing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (!item._init) {
                <span class="keyword">if</span> (transactions == <span class="number">0</span>) {
                    <span class="keyword">return</span> can.trigger(item, event, args);
                } <span class="keyword">else</span> {
                    event = <span class="keyword">typeof</span> event === <span class="string">"string"</span> ? {
                        type: event
                    } : event;
                    event.batchNum = batchNum;
                    batchEvents.push([
                    item, event, args]);
                }
            }
        },

        keys: <span class="function"><span class="keyword">function</span> <span class="params">(observe)</span> {</span>
            <span class="keyword">var</span> keys = [];
            Observe.__reading &amp;&amp; Observe.__reading(observe, <span class="string">'__keys'</span>);
            <span class="keyword">for</span> (<span class="keyword">var</span> keyName <span class="keyword">in</span> observe._data) {
                keys.push(keyName);
            }
            <span class="keyword">return</span> keys;
        }
    },

    {
        setup: <span class="function"><span class="keyword">function</span> <span class="params">(obj)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-510">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-510">&#182;</a>
              </div>
              <p><code>_data</code> is where we keep the properties.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>._data = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-511">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-511">&#182;</a>
              </div>
              <p>The namespace this <code>object</code> uses to listen to events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            can.cid(<span class="keyword">this</span>, <span class="string">".observe"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-512">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-512">&#182;</a>
              </div>
              <p>Sets all <code>attrs</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>._init = <span class="number">1</span>;
            <span class="keyword">this</span>.attr(obj);
            <span class="keyword">this</span>.bind(<span class="string">'change'</span> + <span class="keyword">this</span>._cid, can.proxy(<span class="keyword">this</span>._changes, <span class="keyword">this</span>));
            <span class="keyword">delete</span> <span class="keyword">this</span>._init;
        },
        _changes: <span class="function"><span class="keyword">function</span> <span class="params">(ev, attr, how, newVal, oldVal)</span> {</span>
            Observe.triggerBatch(<span class="keyword">this</span>, {
                type: attr,
                batchNum: ev.batchNum
            }, [newVal, oldVal]);
        },
        _triggerChange: <span class="function"><span class="keyword">function</span> <span class="params">(attr, how, newVal, oldVal)</span> {</span>
            Observe.triggerBatch(<span class="keyword">this</span>, <span class="string">"change"</span>, can.makeArray(arguments))
        },

        attr: <span class="function"><span class="keyword">function</span> <span class="params">(attr, val)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-513">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-513">&#182;</a>
              </div>
              <p>This is super obfuscated for space -- basically, we&#39;re checking
if the type of the attribute is not a <code>number</code> or a <code>string</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> type = <span class="keyword">typeof</span> attr;
            <span class="keyword">if</span> (type !== <span class="string">"string"</span> &amp;&amp; type !== <span class="string">"number"</span>) {
                <span class="keyword">return</span> <span class="keyword">this</span>._attrs(attr, val)
            } <span class="keyword">else</span> <span class="keyword">if</span> (val === <span class="literal">undefined</span>) { <span class="comment">// If we are getting a value.</span></pre></div></div>
            
        </li>
        
        
        <li id="section-514">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-514">&#182;</a>
              </div>
              <p>Let people know we are reading.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                Observe.__reading &amp;&amp; Observe.__reading(<span class="keyword">this</span>, attr)
                <span class="keyword">return</span> <span class="keyword">this</span>._get(attr)
            } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-515">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-515">&#182;</a>
              </div>
              <p>Otherwise we are setting.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">this</span>._set(attr, val);
                <span class="keyword">return</span> <span class="keyword">this</span>;
            }
        },

        each: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            Observe.__reading &amp;&amp; Observe.__reading(<span class="keyword">this</span>, <span class="string">'__keys'</span>);
            <span class="keyword">return</span> can.each.apply(<span class="literal">undefined</span>, [<span class="keyword">this</span>.__get()].concat(can.makeArray(arguments)))
        },

        removeAttr: <span class="function"><span class="keyword">function</span> <span class="params">(attr)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-516">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-516">&#182;</a>
              </div>
              <p>Info if this is List or not</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> isList = <span class="keyword">this</span> <span class="keyword">instanceof</span> can.Observe.List,</pre></div></div>
            
        </li>
        
        
        <li id="section-517">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-517">&#182;</a>
              </div>
              <p>Convert the <code>attr</code> into parts (if nested).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                parts = attrParts(attr),</pre></div></div>
            
        </li>
        
        
        <li id="section-518">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-518">&#182;</a>
              </div>
              <p>The actual property to remove.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                prop = parts.shift(),</pre></div></div>
            
        </li>
        
        
        <li id="section-519">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-519">&#182;</a>
              </div>
              <p>The current value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                current = isList ? <span class="keyword">this</span>[prop] : <span class="keyword">this</span>._data[prop];</pre></div></div>
            
        </li>
        
        
        <li id="section-520">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-520">&#182;</a>
              </div>
              <p>If we have more parts, call <code>removeAttr</code> on that part.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (parts.length) {
                <span class="keyword">return</span> current.removeAttr(parts)
            } <span class="keyword">else</span> {
                <span class="keyword">if</span> (isList) {
                    <span class="keyword">this</span>.splice(prop, <span class="number">1</span>)
                } <span class="keyword">else</span> <span class="keyword">if</span> (prop <span class="keyword">in</span> <span class="keyword">this</span>._data) {</pre></div></div>
            
        </li>
        
        
        <li id="section-521">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-521">&#182;</a>
              </div>
              <p>Otherwise, <code>delete</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">delete</span> <span class="keyword">this</span>._data[prop];</pre></div></div>
            
        </li>
        
        
        <li id="section-522">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-522">&#182;</a>
              </div>
              <p>Create the event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (!(prop <span class="keyword">in</span> <span class="keyword">this</span>.constructor.prototype)) {
                        <span class="keyword">delete</span> <span class="keyword">this</span>[prop]
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-523">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-523">&#182;</a>
              </div>
              <p>Let others know the number of keys have changed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    Observe.triggerBatch(<span class="keyword">this</span>, <span class="string">"__keys"</span>);
                    <span class="keyword">this</span>._triggerChange(prop, <span class="string">"remove"</span>, <span class="literal">undefined</span>, current);

                }
                <span class="keyword">return</span> current;
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-524">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-524">&#182;</a>
              </div>
              <p>Reads a property from the <code>object</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _get: <span class="function"><span class="keyword">function</span> <span class="params">(attr)</span> {</span>
            <span class="keyword">var</span> value = <span class="keyword">typeof</span> attr === <span class="string">'string'</span> &amp;&amp; !! ~attr.indexOf(<span class="string">'.'</span>) &amp;&amp; <span class="keyword">this</span>.__get(attr);
            <span class="keyword">if</span> (value) {
                <span class="keyword">return</span> value;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-525">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-525">&#182;</a>
              </div>
              <p>break up the attr (<code>&quot;foo.bar&quot;</code>) into <code>[&quot;foo&quot;,&quot;bar&quot;]</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> parts = attrParts(attr),</pre></div></div>
            
        </li>
        
        
        <li id="section-526">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-526">&#182;</a>
              </div>
              <p>get the value of the first attr name (<code>&quot;foo&quot;</code>)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                current = <span class="keyword">this</span>.__get(parts.shift());</pre></div></div>
            
        </li>
        
        
        <li id="section-527">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-527">&#182;</a>
              </div>
              <p>if there are other attributes to read</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> parts.length ?</pre></div></div>
            
        </li>
        
        
        <li id="section-528">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-528">&#182;</a>
              </div>
              <p>and current has a value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            current ?</pre></div></div>
            
        </li>
        
        
        <li id="section-529">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-529">&#182;</a>
              </div>
              <p>lookup the remaining attrs on current</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            current._get(parts) :</pre></div></div>
            
        </li>
        
        
        <li id="section-530">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-530">&#182;</a>
              </div>
              <p>or if there&#39;s no current, return undefined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="literal">undefined</span> :</pre></div></div>
            
        </li>
        
        
        <li id="section-531">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-531">&#182;</a>
              </div>
              <p>if there are no more parts, return current</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            current;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-532">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-532">&#182;</a>
              </div>
              <p>Reads a property directly if an <code>attr</code> is provided, otherwise
returns the &quot;real&quot; data object itself.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        __get: <span class="function"><span class="keyword">function</span> <span class="params">(attr)</span> {</span>
            <span class="keyword">return</span> attr ? <span class="keyword">this</span>._data[attr] : <span class="keyword">this</span>._data;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-533">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-533">&#182;</a>
              </div>
              <p>Sets <code>attr</code> prop as value on this object where.
<code>attr</code> - Is a string of properties or an array  of property values.
<code>value</code> - The raw value to set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _set: <span class="function"><span class="keyword">function</span> <span class="params">(attr, value, keepKey)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-534">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-534">&#182;</a>
              </div>
              <p>Convert <code>attr</code> to attr parts (if it isn&#39;t already).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> parts = attrParts(attr, keepKey),</pre></div></div>
            
        </li>
        
        
        <li id="section-535">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-535">&#182;</a>
              </div>
              <p>The immediate prop we are setting.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                prop = parts.shift(),</pre></div></div>
            
        </li>
        
        
        <li id="section-536">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-536">&#182;</a>
              </div>
              <p>The current value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                current = <span class="keyword">this</span>.__get(prop);</pre></div></div>
            
        </li>
        
        
        <li id="section-537">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-537">&#182;</a>
              </div>
              <p>If we have an <code>object</code> and remaining parts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (canMakeObserve(current) &amp;&amp; parts.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-538">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-538">&#182;</a>
              </div>
              <p>That <code>object</code> should set it (this might need to call attr).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                current._set(parts, value)
            } <span class="keyword">else</span> <span class="keyword">if</span> (!parts.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-539">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-539">&#182;</a>
              </div>
              <p>We&#39;re in &quot;real&quot; set territory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (<span class="keyword">this</span>.__convert) {
                    value = <span class="keyword">this</span>.__convert(prop, value)
                }
                <span class="keyword">this</span>.__set(prop, value, current)
            } <span class="keyword">else</span> {
                <span class="keyword">throw</span> <span class="string">"can.Observe: Object does not exist"</span>
            }
        },
        __set: <span class="function"><span class="keyword">function</span> <span class="params">(prop, value, current)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-540">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-540">&#182;</a>
              </div>
              <p>Otherwise, we are setting it on this <code>object</code>.
TODO: Check if value is object and transform
are we changing the value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (value !== current) {</pre></div></div>
            
        </li>
        
        
        <li id="section-541">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-541">&#182;</a>
              </div>
              <p>Check if we are adding this for the first time --
if we are, we need to create an <code>add</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> changeType = <span class="keyword">this</span>.__get().hasOwnProperty(prop) ? <span class="string">"set"</span> : <span class="string">"add"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-542">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-542">&#182;</a>
              </div>
              <p>Set the value on data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">this</span>.___set(prop,</pre></div></div>
            
        </li>
        
        
        <li id="section-543">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-543">&#182;</a>
              </div>
              <p>If we are getting an object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                canMakeObserve(value) ?</pre></div></div>
            
        </li>
        
        
        <li id="section-544">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-544">&#182;</a>
              </div>
              <p>Hook it up to send event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                hookupBubble(value, prop, <span class="keyword">this</span>) :</pre></div></div>
            
        </li>
        
        
        <li id="section-545">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-545">&#182;</a>
              </div>
              <p>Value is normal.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                value);

                <span class="keyword">if</span> (changeType == <span class="string">"add"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-546">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-546">&#182;</a>
              </div>
              <p>If there is no current value, let others know that
the the number of keys have changed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    Observe.triggerBatch(<span class="keyword">this</span>, <span class="string">"__keys"</span>, <span class="literal">undefined</span>);

                }</pre></div></div>
            
        </li>
        
        
        <li id="section-547">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-547">&#182;</a>
              </div>
              <p><code>batchTrigger</code> the change event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">this</span>._triggerChange(prop, changeType, value, current);</pre></div></div>
            
        </li>
        
        
        <li id="section-548">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-548">&#182;</a>
              </div>
              <p>Observe.triggerBatch(this, prop, [value, current]);
If we can stop listening to our old value, do it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                current &amp;&amp; unhookup([current], <span class="keyword">this</span>._cid);
            }

        },</pre></div></div>
            
        </li>
        
        
        <li id="section-549">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-549">&#182;</a>
              </div>
              <p>Directly sets a property on this <code>object</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ___set: <span class="function"><span class="keyword">function</span> <span class="params">(prop, val)</span> {</span>
            <span class="keyword">this</span>._data[prop] = val;</pre></div></div>
            
        </li>
        
        
        <li id="section-550">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-550">&#182;</a>
              </div>
              <p>Add property directly for easy writing.
Check if its on the <code>prototype</code> so we don&#39;t overwrite methods like <code>attrs</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (!(prop <span class="keyword">in</span> <span class="keyword">this</span>.constructor.prototype)) {
                <span class="keyword">this</span>[prop] = val
            }
        },


        bind: bind,

        unbind: unbind,

        serialize: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">return</span> serialize(<span class="keyword">this</span>, <span class="string">'serialize'</span>, {});
        },

        _attrs: <span class="function"><span class="keyword">function</span> <span class="params">(props, remove)</span> {</span>

            <span class="keyword">if</span> (props === <span class="literal">undefined</span>) {
                <span class="keyword">return</span> serialize(<span class="keyword">this</span>, <span class="string">'attr'</span>, {})
            }

            props = can.extend({}, props);
            <span class="keyword">var</span> prop, self = <span class="keyword">this</span>,
                newVal;
            Observe.startBatch();
            <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span> <span class="params">(curVal, prop)</span> {</span>
                newVal = props[prop];</pre></div></div>
            
        </li>
        
        
        <li id="section-551">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-551">&#182;</a>
              </div>
              <p>If we are merging...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (newVal === <span class="literal">undefined</span>) {
                    remove &amp;&amp; self.removeAttr(prop);
                    <span class="keyword">return</span>;
                }

                <span class="keyword">if</span> (self.__convert) {
                    newVal = self.__convert(prop, newVal)
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-552">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-552">&#182;</a>
              </div>
              <p>if we&#39;re dealing with models, want to call _set to let converter run</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (newVal <span class="keyword">instanceof</span> can.Observe) {
                    self.__set(prop, newVal, curVal)</pre></div></div>
            
        </li>
        
        
        <li id="section-553">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-553">&#182;</a>
              </div>
              <p>if its an object, let attr merge</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                } <span class="keyword">else</span> <span class="keyword">if</span> (canMakeObserve(curVal) &amp;&amp; canMakeObserve(newVal) &amp;&amp; curVal.attr) {
                    curVal.attr(newVal, remove)</pre></div></div>
            
        </li>
        
        
        <li id="section-554">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-554">&#182;</a>
              </div>
              <p>otherwise just set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                } <span class="keyword">else</span> <span class="keyword">if</span> (curVal != newVal) {
                    self.__set(prop, newVal, curVal)
                }

                <span class="keyword">delete</span> props[prop];
            })</pre></div></div>
            
        </li>
        
        
        <li id="section-555">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-555">&#182;</a>
              </div>
              <p>Add remaining props.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">for</span> (<span class="keyword">var</span> prop <span class="keyword">in</span> props) {
                newVal = props[prop];
                <span class="keyword">this</span>._set(prop, newVal, <span class="literal">true</span>)
            }
            Observe.stopBatch()
            <span class="keyword">return</span> <span class="keyword">this</span>;
        },


        compute: <span class="function"><span class="keyword">function</span> <span class="params">(prop)</span> {</span>
            <span class="keyword">var</span> self = <span class="keyword">this</span>,
                computer = <span class="function"><span class="keyword">function</span> <span class="params">(val)</span> {</span>
                    <span class="keyword">return</span> self.attr(prop, val);
                };

            <span class="keyword">return</span> can.compute ? can.compute(computer) : computer;
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-556">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-556">&#182;</a>
              </div>
              <p>Helpers for <code>observable</code> lists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> splice = [].splice,
        list = Observe(

        {
            setup: <span class="function"><span class="keyword">function</span> <span class="params">(instances, options)</span> {</span>
                <span class="keyword">this</span>.length = <span class="number">0</span>;
                can.cid(<span class="keyword">this</span>, <span class="string">".observe"</span>)
                <span class="keyword">this</span>._init = <span class="number">1</span>;
                <span class="keyword">if</span> (can.isDeferred(instances)) {
                    <span class="keyword">this</span>.replace(instances)
                } <span class="keyword">else</span> {
                    <span class="keyword">this</span>.push.apply(<span class="keyword">this</span>, can.makeArray(instances || []));
                }
                <span class="keyword">this</span>.bind(<span class="string">'change'</span> + <span class="keyword">this</span>._cid, can.proxy(<span class="keyword">this</span>._changes, <span class="keyword">this</span>));
                can.extend(<span class="keyword">this</span>, options);
                <span class="keyword">delete</span> <span class="keyword">this</span>._init;
            },
            _triggerChange: <span class="function"><span class="keyword">function</span> <span class="params">(attr, how, newVal, oldVal)</span> {</span>

                Observe.prototype._triggerChange.apply(<span class="keyword">this</span>, arguments)</pre></div></div>
            
        </li>
        
        
        <li id="section-557">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-557">&#182;</a>
              </div>
              <p><code>batchTrigger</code> direct add and remove events...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (!~attr.indexOf(<span class="string">'.'</span>)) {

                    <span class="keyword">if</span> (how === <span class="string">'add'</span>) {
                        Observe.triggerBatch(<span class="keyword">this</span>, how, [newVal, +attr]);
                        Observe.triggerBatch(<span class="keyword">this</span>, <span class="string">'length'</span>, [<span class="keyword">this</span>.length]);
                    } <span class="keyword">else</span> <span class="keyword">if</span> (how === <span class="string">'remove'</span>) {
                        Observe.triggerBatch(<span class="keyword">this</span>, how, [oldVal, +attr]);
                        Observe.triggerBatch(<span class="keyword">this</span>, <span class="string">'length'</span>, [<span class="keyword">this</span>.length]);
                    } <span class="keyword">else</span> {
                        Observe.triggerBatch(<span class="keyword">this</span>, how, [newVal, +attr])
                    }

                }

            },
            __get: <span class="function"><span class="keyword">function</span> <span class="params">(attr)</span> {</span>
                <span class="keyword">return</span> attr ? <span class="keyword">this</span>[attr] : <span class="keyword">this</span>;
            },
            ___set: <span class="function"><span class="keyword">function</span> <span class="params">(attr, val)</span> {</span>
                <span class="keyword">this</span>[attr] = val;
                <span class="keyword">if</span> (+attr &gt;= <span class="keyword">this</span>.length) {
                    <span class="keyword">this</span>.length = (+attr + <span class="number">1</span>)
                }
            },</pre></div></div>
            
        </li>
        
        
        <li id="section-558">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-558">&#182;</a>
              </div>
              <p>Returns the serialized form of this list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            serialize: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                <span class="keyword">return</span> serialize(<span class="keyword">this</span>, <span class="string">'serialize'</span>, []);
            },

            splice: <span class="function"><span class="keyword">function</span> <span class="params">(index, howMany)</span> {</span>
                <span class="keyword">var</span> args = can.makeArray(arguments),
                    i;

                <span class="keyword">for</span> (i = <span class="number">2</span>; i &lt; args.length; i++) {
                    <span class="keyword">var</span> val = args[i];
                    <span class="keyword">if</span> (canMakeObserve(val)) {
                        args[i] = hookupBubble(val, <span class="string">"*"</span>, <span class="keyword">this</span>, <span class="keyword">this</span>.constructor.Observe, <span class="keyword">this</span>.constructor)
                    }
                }
                <span class="keyword">if</span> (howMany === <span class="literal">undefined</span>) {
                    howMany = args[<span class="number">1</span>] = <span class="keyword">this</span>.length - index;
                }
                <span class="keyword">var</span> removed = splice.apply(<span class="keyword">this</span>, args);
                can.Observe.startBatch();
                <span class="keyword">if</span> (howMany &gt; <span class="number">0</span>) {
                    <span class="keyword">this</span>._triggerChange(<span class="string">""</span> + index, <span class="string">"remove"</span>, <span class="literal">undefined</span>, removed);
                    unhookup(removed, <span class="keyword">this</span>._cid);
                }
                <span class="keyword">if</span> (args.length &gt; <span class="number">2</span>) {
                    <span class="keyword">this</span>._triggerChange(<span class="string">""</span> + index, <span class="string">"add"</span>, args.slice(<span class="number">2</span>), removed);
                }
                can.Observe.stopBatch();
                <span class="keyword">return</span> removed;
            },

            _attrs: <span class="function"><span class="keyword">function</span> <span class="params">(items, remove)</span> {</span>
                <span class="keyword">if</span> (items === <span class="literal">undefined</span>) {
                    <span class="keyword">return</span> serialize(<span class="keyword">this</span>, <span class="string">'attr'</span>, []);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-559">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-559">&#182;</a>
              </div>
              <p>Create a copy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                items = can.makeArray(items);

                Observe.startBatch();
                <span class="keyword">this</span>._updateAttrs(items, remove);
                Observe.stopBatch()
            },

            _updateAttrs: <span class="function"><span class="keyword">function</span> <span class="params">(items, remove)</span> {</span>
                <span class="keyword">var</span> len = Math.min(items.length, <span class="keyword">this</span>.length);

                <span class="keyword">for</span> (<span class="keyword">var</span> prop = <span class="number">0</span>; prop &lt; len; prop++) {
                    <span class="keyword">var</span> curVal = <span class="keyword">this</span>[prop],
                        newVal = items[prop];

                    <span class="keyword">if</span> (canMakeObserve(curVal) &amp;&amp; canMakeObserve(newVal)) {
                        curVal.attr(newVal, remove)
                    } <span class="keyword">else</span> <span class="keyword">if</span> (curVal != newVal) {
                        <span class="keyword">this</span>._set(prop, newVal)
                    } <span class="keyword">else</span> {

                    }
                }
                <span class="keyword">if</span> (items.length &gt; <span class="keyword">this</span>.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-560">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-560">&#182;</a>
              </div>
              <p>Add in the remaining props.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">this</span>.push.apply(<span class="keyword">this</span>, items.slice(<span class="keyword">this</span>.length));
                } <span class="keyword">else</span> <span class="keyword">if</span> (items.length &lt; <span class="keyword">this</span>.length &amp;&amp; remove) {
                    <span class="keyword">this</span>.splice(items.length)
                }
            }
        }),</pre></div></div>
            
        </li>
        
        
        <li id="section-561">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-561">&#182;</a>
              </div>
              <p>Converts to an <code>array</code> of arguments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        getArgs = <span class="function"><span class="keyword">function</span> <span class="params">(args)</span> {</span>
            <span class="keyword">return</span> args[<span class="number">0</span>] &amp;&amp; can.isArray(args[<span class="number">0</span>]) ? args[<span class="number">0</span>] : can.makeArray(args);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-562">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-562">&#182;</a>
              </div>
              <p>Create <code>push</code>, <code>pop</code>, <code>shift</code>, and <code>unshift</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    can.each({

        push: <span class="string">"length"</span>,

        unshift: <span class="number">0</span>
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-563">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-563">&#182;</a>
              </div>
              <p>Adds a method
<code>name</code> - The method name.
<code>where</code> - Where items in the <code>array</code> should be added.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="keyword">function</span> <span class="params">(where, name)</span> {</span>
        <span class="keyword">var</span> orig = [][name]
        list.prototype[name] = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-564">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-564">&#182;</a>
              </div>
              <p>Get the items being added.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> args = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-565">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-565">&#182;</a>
              </div>
              <p>Where we are going to add items.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                len = where ? <span class="keyword">this</span>.length : <span class="number">0</span>,
                i = arguments.length,
                res, val, constructor = <span class="keyword">this</span>.constructor;</pre></div></div>
            
        </li>
        
        
        <li id="section-566">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-566">&#182;</a>
              </div>
              <p>Go through and convert anything to an <code>observe</code> that needs to be converted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">while</span> (i--) {
                val = arguments[i];
                args[i] = canMakeObserve(val) ? hookupBubble(val, <span class="string">"*"</span>, <span class="keyword">this</span>, <span class="keyword">this</span>.constructor.Observe, <span class="keyword">this</span>.constructor) : val;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-567">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-567">&#182;</a>
              </div>
              <p>Call the original method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            res = orig.apply(<span class="keyword">this</span>, args);

            <span class="keyword">if</span> (!<span class="keyword">this</span>.comparator || args.length) {

                <span class="keyword">this</span>._triggerChange(<span class="string">""</span> + len, <span class="string">"add"</span>, args, <span class="literal">undefined</span>);
            }

            <span class="keyword">return</span> res;
        }
    });

    can.each({

        pop: <span class="string">"length"</span>,

        shift: <span class="number">0</span>
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-568">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-568">&#182;</a>
              </div>
              <p>Creates a <code>remove</code> type method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="keyword">function</span> <span class="params">(where, name)</span> {</span>
        list.prototype[name] = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>

            <span class="keyword">var</span> args = getArgs(arguments),
                len = where &amp;&amp; <span class="keyword">this</span>.length ? <span class="keyword">this</span>.length - <span class="number">1</span> : <span class="number">0</span>;

            <span class="keyword">var</span> res = [][name].apply(<span class="keyword">this</span>, args)</pre></div></div>
            
        </li>
        
        
        <li id="section-569">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-569">&#182;</a>
              </div>
              <p>Create a change where the args are
<code>*</code> - Change on potentially multiple properties.
<code>remove</code> - Items removed.
<code>undefined</code> - The new values (there are none).
<code>res</code> - The old, removed values (should these be unbound).
<code>len</code> - Where these items were removed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>._triggerChange(<span class="string">""</span> + len, <span class="string">"remove"</span>, <span class="literal">undefined</span>, [res])

            <span class="keyword">if</span> (res &amp;&amp; res.unbind) {
                res.unbind(<span class="string">"change"</span> + <span class="keyword">this</span>._cid)
            }
            <span class="keyword">return</span> res;
        }
    });

    can.extend(list.prototype, {

        indexOf: <span class="function"><span class="keyword">function</span> <span class="params">(item)</span> {</span>
            <span class="keyword">this</span>.attr(<span class="string">'length'</span>)
            <span class="keyword">return</span> can.inArray(item, <span class="keyword">this</span>)
        },


        join: [].join,


        reverse: [].reverse,


        slice: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">var</span> temp = Array.prototype.slice.apply(<span class="keyword">this</span>, arguments);
            <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">this</span>.constructor(temp);
        },


        concat: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">var</span> args = [];
            can.each(can.makeArray(arguments), <span class="function"><span class="keyword">function</span> <span class="params">(arg, i)</span> {</span>
                args[i] = arg <span class="keyword">instanceof</span> can.Observe.List ? arg.serialize() : arg;
            });
            <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">this</span>.constructor(Array.prototype.concat.apply(<span class="keyword">this</span>.serialize(), args));
        },


        forEach: <span class="function"><span class="keyword">function</span> <span class="params">(cb, thisarg)</span> {</span>
            can.each(<span class="keyword">this</span>, cb, thisarg || <span class="keyword">this</span>);
        },


        replace: <span class="function"><span class="keyword">function</span> <span class="params">(newList)</span> {</span>
            <span class="keyword">if</span> (can.isDeferred(newList)) {
                newList.then(can.proxy(<span class="keyword">this</span>.replace, <span class="keyword">this</span>));
            } <span class="keyword">else</span> {
                <span class="keyword">this</span>.splice.apply(<span class="keyword">this</span>, [<span class="number">0</span>, <span class="keyword">this</span>.length].concat(can.makeArray(newList || [])));
            }

            <span class="keyword">return</span> <span class="keyword">this</span>;
        }
    });

    Observe.List = list;
    Observe.setup = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        can.Construct.setup.apply(<span class="keyword">this</span>, arguments);</pre></div></div>
            
        </li>
        
        
        <li id="section-570">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-570">&#182;</a>
              </div>
              <p>I would prefer not to do it this way. It should
be using the attributes plugin to do this type of conversion.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.List = Observe.List({
            Observe: <span class="keyword">this</span>
        }, {});
    }
    <span class="keyword">return</span> Observe;
})(module[<span class="string">"can/util/jquery/jquery.js"</span>], module[<span class="string">"can/construct/construct.js"</span>]); <span class="comment">// ## can/model/model.js</span>
module[<span class="string">'can/model/model.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-571">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-571">&#182;</a>
              </div>
              <h2>model.js</h2>
<p><code>can.Model</code><br><em>A <code>can.Observe</code> that connects to a RESTful interface.</em>
Generic deferred piping function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> pipe = <span class="function"><span class="keyword">function</span> <span class="params">(def, model, func)</span> {</span>
        <span class="keyword">var</span> d = <span class="keyword">new</span> can.Deferred();
        def.then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">var</span> args = can.makeArray(arguments);
            args[<span class="number">0</span>] = model[func](args[<span class="number">0</span>]);
            d.resolveWith(d, args);
        }, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            d.rejectWith(<span class="keyword">this</span>, arguments);
        });

        <span class="keyword">if</span> (<span class="keyword">typeof</span> def.abort === <span class="string">'function'</span>) {
            d.abort = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                <span class="keyword">return</span> def.abort();
            }
        }

        <span class="keyword">return</span> d;
    },
        modelNum = <span class="number">0</span>,
        ignoreHookup = <span class="regexp">/change.observe\d+/</span>,
        getId = <span class="function"><span class="keyword">function</span> <span class="params">(inst)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-572">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-572">&#182;</a>
              </div>
              <p>Instead of using attr, use __get for performance.
Need to set reading</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            can.Observe.__reading &amp;&amp; can.Observe.__reading(inst, inst.constructor.id)
            <span class="keyword">return</span> inst.__get(inst.constructor.id);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-573">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-573">&#182;</a>
              </div>
              <p>Ajax <code>options</code> generator function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ajax = <span class="function"><span class="keyword">function</span> <span class="params">(ajaxOb, data, type, dataType, success, error)</span> {</span>

            <span class="keyword">var</span> params = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-574">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-574">&#182;</a>
              </div>
              <p>If we get a string, handle it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="keyword">typeof</span> ajaxOb == <span class="string">"string"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-575">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-575">&#182;</a>
              </div>
              <p>If there&#39;s a space, it&#39;s probably the type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> parts = ajaxOb.split(<span class="regexp">/\s+/</span>);
                params.url = parts.pop();
                <span class="keyword">if</span> (parts.length) {
                    params.type = parts.pop();
                }
            } <span class="keyword">else</span> {
                can.extend(params, ajaxOb);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-576">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-576">&#182;</a>
              </div>
              <p>If we are a non-array object, copy to a new attrs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            params.data = <span class="keyword">typeof</span> data == <span class="string">"object"</span> &amp;&amp; !can.isArray(data) ? can.extend(params.data || {}, data) : data;</pre></div></div>
            
        </li>
        
        
        <li id="section-577">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-577">&#182;</a>
              </div>
              <p>Get the url with any templated values filled out.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            params.url = can.sub(params.url, params.data, <span class="literal">true</span>);

            <span class="keyword">return</span> can.ajax(can.extend({
                type: type || <span class="string">"post"</span>,
                dataType: dataType || <span class="string">"json"</span>,
                success: success,
                error: error
            }, params));
        },
        makeRequest = <span class="function"><span class="keyword">function</span> <span class="params">(self, type, success, error, method)</span> {</span>
            <span class="keyword">var</span> args;</pre></div></div>
            
        </li>
        
        
        <li id="section-578">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-578">&#182;</a>
              </div>
              <p>if we pass an array as <code>self</code> it it means we are coming from
the queued request, and we&#39;re passing already serialized data
self&#39;s signature will be: [self, serializedData]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (can.isArray(self)) {
                args = self[<span class="number">1</span>];
                self = self[<span class="number">0</span>];
            } <span class="keyword">else</span> {
                args = self.serialize();
            }
            args = [args];
            <span class="keyword">var</span> deferred,</pre></div></div>
            
        </li>
        
        
        <li id="section-579">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-579">&#182;</a>
              </div>
              <p>The model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            model = self.constructor,
                jqXHR;</pre></div></div>
            
        </li>
        
        
        <li id="section-580">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-580">&#182;</a>
              </div>
              <p><code>destroy</code> does not need data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (type == <span class="string">'destroy'</span>) {
                args.shift();
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-581">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-581">&#182;</a>
              </div>
              <p><code>update</code> and <code>destroy</code> need the <code>id</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (type !== <span class="string">'create'</span>) {
                args.unshift(getId(self));
            }


            jqXHR = model[type].apply(model, args);

            deferred = jqXHR.pipe(<span class="function"><span class="keyword">function</span> <span class="params">(data)</span> {</span>
                self[method || type + <span class="string">"d"</span>](data, jqXHR);
                <span class="keyword">return</span> self;
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-582">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-582">&#182;</a>
              </div>
              <p>Hook up <code>abort</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (jqXHR.abort) {
                deferred.abort = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                    jqXHR.abort();
                };
            }

            deferred.then(success, error);
            <span class="keyword">return</span> deferred;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-583">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-583">&#182;</a>
              </div>
              <p>This object describes how to make an ajax request for each ajax method.<br>The available properties are:
    <code>url</code> - The default url to use as indicated as a property on the model.
    <code>type</code> - The default http request type
    <code>data</code> - A method that takes the <code>arguments</code> and returns <code>data</code> used for ajax.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ajaxMethods = {

            create: {
                url: <span class="string">"_shortName"</span>,
                type: <span class="string">"post"</span>
            },

            update: {
                data: <span class="function"><span class="keyword">function</span> <span class="params">(id, attrs)</span> {</span>
                    attrs = attrs || {};
                    <span class="keyword">var</span> identity = <span class="keyword">this</span>.id;
                    <span class="keyword">if</span> (attrs[identity] &amp;&amp; attrs[identity] !== id) {
                        attrs[<span class="string">"new"</span> + can.capitalize(id)] = attrs[identity];
                        <span class="keyword">delete</span> attrs[identity];
                    }
                    attrs[identity] = id;
                    <span class="keyword">return</span> attrs;
                },
                type: <span class="string">"put"</span>
            },

            destroy: {
                type: <span class="string">"delete"</span>,
                data: <span class="function"><span class="keyword">function</span> <span class="params">(id)</span> {</span>
                    <span class="keyword">var</span> args = {};
                    args.id = args[<span class="keyword">this</span>.id] = id;
                    <span class="keyword">return</span> args;
                }
            },

            findAll: {
                url: <span class="string">"_shortName"</span>
            },

            findOne: {}
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-584">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-584">&#182;</a>
              </div>
              <p>Makes an ajax request <code>function</code> from a string.
    <code>ajaxMethod</code> - The <code>ajaxMethod</code> object defined above.
    <code>str</code> - The string the user provided. Ex: <code>findAll: &quot;/recipes.json&quot;</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ajaxMaker = <span class="function"><span class="keyword">function</span> <span class="params">(ajaxMethod, str)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-585">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-585">&#182;</a>
              </div>
              <p>Return a <code>function</code> that serves as the ajax method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-586">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-586">&#182;</a>
              </div>
              <p>If the ajax method has it&#39;s own way of getting <code>data</code>, use that.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                data = ajaxMethod.data ? ajaxMethod.data.apply(<span class="keyword">this</span>, arguments) :</pre></div></div>
            
        </li>
        
        
        <li id="section-587">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-587">&#182;</a>
              </div>
              <p>Otherwise use the data passed in.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                data;</pre></div></div>
            
        </li>
        
        
        <li id="section-588">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-588">&#182;</a>
              </div>
              <p>Return the ajax method with <code>data</code> and the <code>type</code> provided.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">return</span> ajax(str || <span class="keyword">this</span>[ajaxMethod.url || <span class="string">"_url"</span>], data, ajaxMethod.type || <span class="string">"get"</span>)
            }
        }



        can.Model = can.Observe({
            fullName: <span class="string">"can.Model"</span>,
            setup: <span class="function"><span class="keyword">function</span> <span class="params">(base)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-589">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-589">&#182;</a>
              </div>
              <p>create store here if someone wants to use model without inheriting from it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">this</span>.store = {};
                can.Observe.setup.apply(<span class="keyword">this</span>, arguments);</pre></div></div>
            
        </li>
        
        
        <li id="section-590">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-590">&#182;</a>
              </div>
              <p>Set default list as model list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (!can.Model) {
                    <span class="keyword">return</span>;
                }
                <span class="keyword">this</span>.List = ML({
                    Observe: <span class="keyword">this</span>
                }, {});
                <span class="keyword">var</span> self = <span class="keyword">this</span>,
                    clean = can.proxy(<span class="keyword">this</span>._clean, self);</pre></div></div>
            
        </li>
        
        
        <li id="section-591">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-591">&#182;</a>
              </div>
              <p>go through ajax methods and set them up</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                can.each(ajaxMethods, <span class="function"><span class="keyword">function</span> <span class="params">(method, name)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-592">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-592">&#182;</a>
              </div>
              <p>if an ajax method is not a function, it&#39;s either
a string url like findAll: &quot;/recipes&quot; or an
ajax options object like {url: &quot;/recipes&quot;}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (!can.isFunction(self[name])) {</pre></div></div>
            
        </li>
        
        
        <li id="section-593">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-593">&#182;</a>
              </div>
              <p>use ajaxMaker to convert that into a function
that returns a deferred with the data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        self[name] = ajaxMaker(method, self[name]);
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-594">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-594">&#182;</a>
              </div>
              <p>check if there&#39;s a make function like makeFindAll
these take deferred function and can do special
behavior with it (like look up data in a store)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (self[<span class="string">"make"</span> + can.capitalize(name)]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-595">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-595">&#182;</a>
              </div>
              <p>pass the deferred method to the make method to get back
the &quot;findAll&quot; method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">var</span> newMethod = self[<span class="string">"make"</span> + can.capitalize(name)](self[name]);
                        can.Construct._overwrite(self, base, name, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-596">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-596">&#182;</a>
              </div>
              <p>increment the numer of requests</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="keyword">this</span>._reqs++;
                            <span class="keyword">var</span> def = newMethod.apply(<span class="keyword">this</span>, arguments);
                            <span class="keyword">var</span> then = def.then(clean, clean);
                            then.abort = def.abort;</pre></div></div>
            
        </li>
        
        
        <li id="section-597">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-597">&#182;</a>
              </div>
              <p>attach abort to our then and return it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="keyword">return</span> then;
                        })
                    }
                });

                <span class="keyword">if</span> (self.fullName == <span class="string">"can.Model"</span> || !self.fullName) {
                    self.fullName = <span class="string">"Model"</span> + (++modelNum);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-598">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-598">&#182;</a>
              </div>
              <p>Add ajax converters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">this</span>._reqs = <span class="number">0</span>;
                <span class="keyword">this</span>._url = <span class="keyword">this</span>._shortName + <span class="string">"/{"</span> + <span class="keyword">this</span>.id + <span class="string">"}"</span>
            },
            _ajax: ajaxMaker,
            _makeRequest: makeRequest,
            _clean: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                <span class="keyword">this</span>._reqs--;
                <span class="keyword">if</span> (!<span class="keyword">this</span>._reqs) {
                    <span class="keyword">for</span> (<span class="keyword">var</span> id <span class="keyword">in</span> <span class="keyword">this</span>.store) {
                        <span class="keyword">if</span> (!<span class="keyword">this</span>.store[id]._bindings) {
                            <span class="keyword">delete</span> <span class="keyword">this</span>.store[id];
                        }
                    }
                }
                <span class="keyword">return</span> arguments[<span class="number">0</span>];
            },

            models: <span class="function"><span class="keyword">function</span> <span class="params">(instancesRawData, oldList)</span> {</span>

                <span class="keyword">if</span> (!instancesRawData) {
                    <span class="keyword">return</span>;
                }

                <span class="keyword">if</span> (instancesRawData <span class="keyword">instanceof</span> <span class="keyword">this</span>.List) {
                    <span class="keyword">return</span> instancesRawData;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-599">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-599">&#182;</a>
              </div>
              <p>Get the list type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> self = <span class="keyword">this</span>,
                    tmp = [],
                    res = oldList <span class="keyword">instanceof</span> can.Observe.List ? oldList : <span class="keyword">new</span>(self.List || ML),</pre></div></div>
            
        </li>
        
        
        <li id="section-600">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-600">&#182;</a>
              </div>
              <p>Did we get an <code>array</code>?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    arr = can.isArray(instancesRawData),</pre></div></div>
            
        </li>
        
        
        <li id="section-601">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-601">&#182;</a>
              </div>
              <p>Did we get a model list?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    ml = (instancesRawData <span class="keyword">instanceof</span> ML),</pre></div></div>
            
        </li>
        
        
        <li id="section-602">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-602">&#182;</a>
              </div>
              <p>Get the raw <code>array</code> of objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    raw = arr ?</pre></div></div>
            
        </li>
        
        
        <li id="section-603">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-603">&#182;</a>
              </div>
              <p>If an <code>array</code>, return the <code>array</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    instancesRawData :</pre></div></div>
            
        </li>
        
        
        <li id="section-604">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-604">&#182;</a>
              </div>
              <p>Otherwise if a model list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    (ml ?</pre></div></div>
            
        </li>
        
        
        <li id="section-605">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-605">&#182;</a>
              </div>
              <p>Get the raw objects from the list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    instancesRawData.serialize() :</pre></div></div>
            
        </li>
        
        
        <li id="section-606">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-606">&#182;</a>
              </div>
              <p>Get the object&#39;s data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    instancesRawData.data),
                    i = <span class="number">0</span>;



                <span class="keyword">if</span> (res.length) {
                    res.splice(<span class="number">0</span>);
                }

                can.each(raw, <span class="function"><span class="keyword">function</span> <span class="params">(rawPart)</span> {</span>
                    tmp.push(self.model(rawPart));
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-607">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-607">&#182;</a>
              </div>
              <p>We only want one change event so push everything at once</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                res.push.apply(res, tmp);

                <span class="keyword">if</span> (!arr) { <span class="comment">// Push other stuff onto `array`.</span>
                    can.each(instancesRawData, <span class="function"><span class="keyword">function</span> <span class="params">(val, prop)</span> {</span>
                        <span class="keyword">if</span> (prop !== <span class="string">'data'</span>) {
                            res.attr(prop, val);
                        }
                    })
                }
                <span class="keyword">return</span> res;
            },

            model: <span class="function"><span class="keyword">function</span> <span class="params">(attributes)</span> {</span>
                <span class="keyword">if</span> (!attributes) {
                    <span class="keyword">return</span>;
                }
                <span class="keyword">if</span> (attributes <span class="keyword">instanceof</span> <span class="keyword">this</span>) {
                    attributes = attributes.serialize();
                }
                <span class="keyword">var</span> id = attributes[<span class="keyword">this</span>.id],
                    model = (id || id === <span class="number">0</span>) &amp;&amp; <span class="keyword">this</span>.store[id] ? <span class="keyword">this</span>.store[id].attr(attributes, <span class="keyword">this</span>.removeAttr || <span class="literal">false</span>) : <span class="keyword">new</span> <span class="keyword">this</span>(attributes);
                <span class="keyword">if</span> (<span class="keyword">this</span>._reqs) {
                    <span class="keyword">this</span>.store[attributes[<span class="keyword">this</span>.id]] = model;
                }
                <span class="keyword">return</span> model;
            }
        },

        {

            isNew: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                <span class="keyword">var</span> id = getId(<span class="keyword">this</span>);
                <span class="keyword">return</span> !(id || id === <span class="number">0</span>); <span class="comment">// If `null` or `undefined`</span>
            },

            save: <span class="function"><span class="keyword">function</span> <span class="params">(success, error)</span> {</span>
                <span class="keyword">return</span> makeRequest(<span class="keyword">this</span>, <span class="keyword">this</span>.isNew() ? <span class="string">'create'</span> : <span class="string">'update'</span>, success, error);
            },

            destroy: <span class="function"><span class="keyword">function</span> <span class="params">(success, error)</span> {</span>
                <span class="keyword">if</span> (<span class="keyword">this</span>.isNew()) {
                    <span class="keyword">var</span> self = <span class="keyword">this</span>;
                    <span class="keyword">return</span> can.Deferred().done(<span class="function"><span class="keyword">function</span> <span class="params">(data)</span> {</span>
                        self.destroyed(data)
                    }).resolve(self);
                }
                <span class="keyword">return</span> makeRequest(<span class="keyword">this</span>, <span class="string">'destroy'</span>, success, error, <span class="string">'destroyed'</span>);
            },

            bind: <span class="function"><span class="keyword">function</span> <span class="params">(eventName)</span> {</span>
                <span class="keyword">if</span> (!ignoreHookup.test(eventName)) {
                    <span class="keyword">if</span> (!<span class="keyword">this</span>._bindings) {
                        <span class="keyword">this</span>.constructor.store[<span class="keyword">this</span>.__get(<span class="keyword">this</span>.constructor.id)] = <span class="keyword">this</span>;
                        <span class="keyword">this</span>._bindings = <span class="number">0</span>;
                    }
                    <span class="keyword">this</span>._bindings++;
                }

                <span class="keyword">return</span> can.Observe.prototype.bind.apply(<span class="keyword">this</span>, arguments);
            },

            unbind: <span class="function"><span class="keyword">function</span> <span class="params">(eventName)</span> {</span>
                <span class="keyword">if</span> (!ignoreHookup.test(eventName)) {
                    <span class="keyword">this</span>._bindings--;
                    <span class="keyword">if</span> (!<span class="keyword">this</span>._bindings) {
                        <span class="keyword">delete</span> <span class="keyword">this</span>.constructor.store[getId(<span class="keyword">this</span>)];
                    }
                }
                <span class="keyword">return</span> can.Observe.prototype.unbind.apply(<span class="keyword">this</span>, arguments);
            },</pre></div></div>
            
        </li>
        
        
        <li id="section-608">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-608">&#182;</a>
              </div>
              <p>Change <code>id</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            ___set: <span class="function"><span class="keyword">function</span> <span class="params">(prop, val)</span> {</span>
                can.Observe.prototype.___set.call(<span class="keyword">this</span>, prop, val)</pre></div></div>
            
        </li>
        
        
        <li id="section-609">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-609">&#182;</a>
              </div>
              <p>If we add an <code>id</code>, move it to the store.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (prop === <span class="keyword">this</span>.constructor.id &amp;&amp; <span class="keyword">this</span>._bindings) {
                    <span class="keyword">this</span>.constructor.store[getId(<span class="keyword">this</span>)] = <span class="keyword">this</span>;
                }
            }
        });

    can.each({
        makeFindAll: <span class="string">"models"</span>,
        makeFindOne: <span class="string">"model"</span>
    }, <span class="function"><span class="keyword">function</span> <span class="params">(method, name)</span> {</span>
        can.Model[name] = <span class="function"><span class="keyword">function</span> <span class="params">(oldFind)</span> {</span>
            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(params, success, error)</span> {</span>
                <span class="keyword">var</span> def = pipe(oldFind.call(<span class="keyword">this</span>, params), <span class="keyword">this</span>, method);
                def.then(success, error);</pre></div></div>
            
        </li>
        
        
        <li id="section-610">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-610">&#182;</a>
              </div>
              <p>return the original promise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">return</span> def;
            };
        };
    });

    can.each([

    <span class="string">"created"</span>,

    <span class="string">"updated"</span>,

    <span class="string">"destroyed"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(funcName)</span> {</span>
        can.Model.prototype[funcName] = <span class="function"><span class="keyword">function</span> <span class="params">(attrs)</span> {</span>
            <span class="keyword">var</span> stub, constructor = <span class="keyword">this</span>.constructor;</pre></div></div>
            
        </li>
        
        
        <li id="section-611">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-611">&#182;</a>
              </div>
              <p>Update attributes if attributes have been passed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            stub = attrs &amp;&amp; <span class="keyword">typeof</span> attrs == <span class="string">'object'</span> &amp;&amp; <span class="keyword">this</span>.attr(attrs.attr ? attrs.attr() : attrs);</pre></div></div>
            
        </li>
        
        
        <li id="section-612">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-612">&#182;</a>
              </div>
              <p>Call event on the instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            can.trigger(<span class="keyword">this</span>, funcName);</pre></div></div>
            
        </li>
        
        
        <li id="section-613">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-613">&#182;</a>
              </div>
              <p>triggers change event that bubble&#39;s like
handler( &#39;change&#39;,&#39;1.destroyed&#39; ). This is used
to remove items on destroyed from Model Lists.
but there should be a better way.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            can.trigger(<span class="keyword">this</span>, <span class="string">"change"</span>, funcName)</pre></div></div>
            
        </li>
        
        
        <li id="section-614">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-614">&#182;</a>
              </div>
              <p>Call event on the instance&#39;s Class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            can.trigger(constructor, funcName, <span class="keyword">this</span>);
        };
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-615">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-615">&#182;</a>
              </div>
              <p>Model lists are just like <code>Observe.List</code> except that when their items are 
destroyed, it automatically gets removed from the list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> ML = can.Model.List = can.Observe.List({
        setup: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            can.Observe.List.prototype.setup.apply(<span class="keyword">this</span>, arguments);</pre></div></div>
            
        </li>
        
        
        <li id="section-616">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-616">&#182;</a>
              </div>
              <p>Send destroy events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> self = <span class="keyword">this</span>;
            <span class="keyword">this</span>.bind(<span class="string">'change'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(ev, how)</span> {</span>
                <span class="keyword">if</span> (<span class="regexp">/\w+\.destroyed/</span>.test(how)) {
                    <span class="keyword">var</span> index = self.indexOf(ev.target);
                    <span class="keyword">if</span> (index != -<span class="number">1</span>) {
                        self.splice(index, <span class="number">1</span>);
                    }
                }
            })
        }
    })

    <span class="keyword">return</span> can.Model;
})(module[<span class="string">"can/util/jquery/jquery.js"</span>], module[<span class="string">"can/observe/observe.js"</span>]); <span class="comment">// ## can/view/ejs/ejs.js</span>
module[<span class="string">'can/view/ejs/ejs.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-617">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-617">&#182;</a>
              </div>
              <h2>ejs.js</h2>
<p><code>can.EJS</code><br><em>Embedded JavaScript Templates.</em>
Helper methods.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> extend = can.extend,
        EJS = <span class="function"><span class="keyword">function</span> <span class="params">(options)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-618">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-618">&#182;</a>
              </div>
              <p>Supports calling EJS without the constructor
This returns a function that renders the template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="keyword">this</span>.constructor != EJS) {
                <span class="keyword">var</span> ejs = <span class="keyword">new</span> EJS(options);
                <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(data, helpers)</span> {</span>
                    <span class="keyword">return</span> ejs.render(data, helpers);
                };
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-619">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-619">&#182;</a>
              </div>
              <p>If we get a <code>function</code> directly, it probably is coming from
a <code>steal</code>-packaged view.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) {
                <span class="keyword">this</span>.template = {
                    fn: options
                };
                <span class="keyword">return</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-620">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-620">&#182;</a>
              </div>
              <p>Set options on self.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            extend(<span class="keyword">this</span>, options);
            <span class="keyword">this</span>.template = <span class="keyword">this</span>.scanner.scan(<span class="keyword">this</span>.text, <span class="keyword">this</span>.name);
        };


    can.EJS = EJS;


    EJS.prototype.

    render = <span class="function"><span class="keyword">function</span> <span class="params">(object, extraHelpers)</span> {</span>
        object = object || {};
        <span class="keyword">return</span> <span class="keyword">this</span>.template.fn.call(object, object, <span class="keyword">new</span> EJS.Helpers(object, extraHelpers || {}));
    };

    extend(EJS.prototype, {

        scanner: <span class="keyword">new</span> can.view.Scanner({

            tokens: [
                [<span class="string">"templateLeft"</span>, <span class="string">"&lt;%%"</span>], <span class="comment">// Template</span>
                [<span class="string">"templateRight"</span>, <span class="string">"%&gt;"</span>], <span class="comment">// Right Template</span>
                [<span class="string">"returnLeft"</span>, <span class="string">"&lt;%=="</span>], <span class="comment">// Return Unescaped</span>
                [<span class="string">"escapeLeft"</span>, <span class="string">"&lt;%="</span>], <span class="comment">// Return Escaped</span>
                [<span class="string">"commentLeft"</span>, <span class="string">"&lt;%#"</span>], <span class="comment">// Comment</span>
                [<span class="string">"left"</span>, <span class="string">"&lt;%"</span>], <span class="comment">// Run --- this is hack for now</span>
                [<span class="string">"right"</span>, <span class="string">"%&gt;"</span>], <span class="comment">// Right -&gt; All have same FOR Mustache ...</span>
                [<span class="string">"returnRight"</span>, <span class="string">"%&gt;"</span>]
            ]
        })
    });


    EJS.Helpers = <span class="function"><span class="keyword">function</span> <span class="params">(data, extras)</span> {</span>
        <span class="keyword">this</span>._data = data;
        <span class="keyword">this</span>._extras = extras;
        extend(<span class="keyword">this</span>, extras);
    };

    EJS.Helpers.prototype = {</pre></div></div>
            
        </li>
        
        
        <li id="section-621">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-621">&#182;</a>
              </div>
              <p>TODO Deprecated!!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        list: <span class="function"><span class="keyword">function</span> <span class="params">(list, cb)</span> {</span>
            can.each(list, <span class="function"><span class="keyword">function</span> <span class="params">(item, i)</span> {</span>
                cb(item, i, list)
            })
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-622">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-622">&#182;</a>
              </div>
              <p>Options for <code>steal</code>&#39;s build.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    can.view.register({
        suffix: <span class="string">"ejs"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-623">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-623">&#182;</a>
              </div>
              <p>returns a <code>function</code> that renders the view.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        script: <span class="function"><span class="keyword">function</span> <span class="params">(id, src)</span> {</span>
            <span class="keyword">return</span> <span class="string">"can.EJS(function(_CONTEXT,_VIEW) { "</span> + <span class="keyword">new</span> EJS({
                text: src,
                name: id
            }).template.out + <span class="string">" })"</span>;
        },
        renderer: <span class="function"><span class="keyword">function</span> <span class="params">(id, text)</span> {</span>
            <span class="keyword">return</span> EJS({
                text: text,
                name: id
            });
        }
    });

    <span class="keyword">return</span> can;
})(module[<span class="string">"can/util/jquery/jquery.js"</span>], module[<span class="string">"can/view/view.js"</span>], module[<span class="string">"can/util/string/string.js"</span>], module[<span class="string">"can/observe/compute/compute.js"</span>], module[<span class="string">"can/view/scanner.js"</span>], module[<span class="string">"can/view/render.js"</span>]); <span class="comment">// ## can/observe/attributes/attributes.js</span>
module[<span class="string">'can/observe/attributes/attributes.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can, Observe)</span> {</span>

    can.each([can.Observe, can.Model], <span class="function"><span class="keyword">function</span> <span class="params">(clss)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-624">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-624">&#182;</a>
              </div>
              <p>in some cases model might not be defined quite yet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (clss === <span class="literal">undefined</span>) {
            <span class="keyword">return</span>;
        }
        <span class="keyword">var</span> isObject = <span class="function"><span class="keyword">function</span> <span class="params">(obj)</span> {</span>
            <span class="keyword">return</span> <span class="keyword">typeof</span> obj === <span class="string">'object'</span> &amp;&amp; obj !== <span class="literal">null</span> &amp;&amp; obj;
        };

        can.extend(clss, {

            attributes: {},


            convert: {
                <span class="string">"date"</span>: <span class="function"><span class="keyword">function</span> <span class="params">(str)</span> {</span>
                    <span class="keyword">var</span> type = <span class="keyword">typeof</span> str;
                    <span class="keyword">if</span> (type === <span class="string">"string"</span>) {
                        <span class="keyword">return</span> isNaN(Date.parse(str)) ? <span class="literal">null</span> : Date.parse(str)
                    } <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'number'</span>) {
                        <span class="keyword">return</span> <span class="keyword">new</span> Date(str)
                    } <span class="keyword">else</span> {
                        <span class="keyword">return</span> str
                    }
                },
                <span class="string">"number"</span>: <span class="function"><span class="keyword">function</span> <span class="params">(val)</span> {</span>
                    <span class="keyword">return</span> parseFloat(val);
                },
                <span class="string">"boolean"</span>: <span class="function"><span class="keyword">function</span> <span class="params">(val)</span> {</span>
                    <span class="keyword">if</span> (val === <span class="string">'false'</span> || val === <span class="string">'0'</span> || !val) {
                        <span class="keyword">return</span> <span class="literal">false</span>;
                    }
                    <span class="keyword">return</span> <span class="literal">true</span>;
                },
                <span class="string">"default"</span>: <span class="function"><span class="keyword">function</span> <span class="params">(val, oldVal, error, type)</span> {</span>
                    <span class="keyword">var</span> construct = can.getObject(type),
                        context = window,
                        realType;</pre></div></div>
            
        </li>
        
        
        <li id="section-625">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-625">&#182;</a>
              </div>
              <p>if type has a . we need to look it up</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (type.indexOf(<span class="string">"."</span>) &gt;= <span class="number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-626">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-626">&#182;</a>
              </div>
              <p>get everything before the last .</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        realType = type.substring(<span class="number">0</span>, type.lastIndexOf(<span class="string">"."</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-627">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-627">&#182;</a>
              </div>
              <p>get the object before the last .</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        context = can.getObject(realType);
                    }
                    <span class="keyword">return</span> <span class="keyword">typeof</span> construct == <span class="string">"function"</span> ? construct.call(context, val, oldVal) : val;
                }
            },

            serialize: {
                <span class="string">"default"</span>: <span class="function"><span class="keyword">function</span> <span class="params">(val, type)</span> {</span>
                    <span class="keyword">return</span> isObject(val) &amp;&amp; val.serialize ? val.serialize() : val;
                },
                <span class="string">"date"</span>: <span class="function"><span class="keyword">function</span> <span class="params">(val)</span> {</span>
                    <span class="keyword">return</span> val &amp;&amp; val.getTime()
                }
            }
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-628">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-628">&#182;</a>
              </div>
              <p>overwrite setup to do this stuff</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> oldSetup = clss.setup;


        clss.setup = <span class="function"><span class="keyword">function</span> <span class="params">(superClass, stat, proto)</span> {</span>
            <span class="keyword">var</span> self = <span class="keyword">this</span>;
            oldSetup.call(self, superClass, stat, proto);

            can.each([<span class="string">"attributes"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> {</span>
                <span class="keyword">if</span> (!self[name] || superClass[name] === self[name]) {
                    self[name] = {};
                }
            });

            can.each([<span class="string">"convert"</span>, <span class="string">"serialize"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> {</span>
                <span class="keyword">if</span> (superClass[name] != self[name]) {
                    self[name] = can.extend({}, superClass[name], self[name]);
                }
            });
        };
    });

    <span class="keyword">var</span> oldSetup = can.Observe.prototype.setup;

    can.Observe.prototype.setup = <span class="function"><span class="keyword">function</span> <span class="params">(obj)</span> {</span>

        <span class="keyword">var</span> diff = {};

        oldSetup.call(<span class="keyword">this</span>, obj);

        can.each(<span class="keyword">this</span>.constructor.defaults, <span class="function"><span class="keyword">function</span> <span class="params">(value, key)</span> {</span>
            <span class="keyword">if</span> (!<span class="keyword">this</span>.hasOwnProperty(key)) {
                diff[key] = value;
            }
        }, <span class="keyword">this</span>);

        <span class="keyword">this</span>._init = <span class="number">1</span>;
        <span class="keyword">this</span>.attr(diff);
        <span class="keyword">delete</span> <span class="keyword">this</span>._init;
    };

    can.Observe.prototype.__convert = <span class="function"><span class="keyword">function</span> <span class="params">(prop, value)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-629">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-629">&#182;</a>
              </div>
              <p>check if there is a</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> Class = <span class="keyword">this</span>.constructor,
            oldVal = <span class="keyword">this</span>.attr(prop),
            type, converter;

        <span class="keyword">if</span> (Class.attributes) {</pre></div></div>
            
        </li>
        
        
        <li id="section-630">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-630">&#182;</a>
              </div>
              <p>the type of the attribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            type = Class.attributes[prop];
            converter = Class.convert[type] || Class.convert[<span class="string">'default'</span>];
        }

        <span class="keyword">return</span> value === <span class="literal">null</span> || !type ?</pre></div></div>
            
        </li>
        
        
        <li id="section-631">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-631">&#182;</a>
              </div>
              <p>just use the value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        value :</pre></div></div>
            
        </li>
        
        
        <li id="section-632">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-632">&#182;</a>
              </div>
              <p>otherwise, pass to the converter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        converter.call(Class, value, oldVal, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>}, type);
    };

    can.Observe.prototype.serialize = <span class="function"><span class="keyword">function</span> <span class="params">(attrName)</span> {</span>
        <span class="keyword">var</span> where = {},
            Class = <span class="keyword">this</span>.constructor,
            attrs = {};

        <span class="keyword">if</span> (attrName != <span class="literal">undefined</span>) {
            attrs[attrName] = <span class="keyword">this</span>[attrName];
        } <span class="keyword">else</span> {
            attrs = <span class="keyword">this</span>.__get();
        }

        can.each(attrs, <span class="function"><span class="keyword">function</span> <span class="params">(val, name)</span> {</span>
            <span class="keyword">var</span> type, converter;

            type = Class.attributes ? Class.attributes[name] : <span class="number">0</span>;
            converter = Class.serialize ? Class.serialize[type] : <span class="number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-633">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-633">&#182;</a>
              </div>
              <p>if the value is an object, and has a attrs or serialize function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            where[name] = val &amp;&amp; <span class="keyword">typeof</span> val.serialize == <span class="string">'function'</span> ?</pre></div></div>
            
        </li>
        
        
        <li id="section-634">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-634">&#182;</a>
              </div>
              <p>call attrs or serialize to get the original data back</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            val.serialize() :</pre></div></div>
            
        </li>
        
        
        <li id="section-635">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-635">&#182;</a>
              </div>
              <p>otherwise if we have  a converter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            converter ?</pre></div></div>
            
        </li>
        
        
        <li id="section-636">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-636">&#182;</a>
              </div>
              <p>use the converter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            converter(val, type) :</pre></div></div>
            
        </li>
        
        
        <li id="section-637">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-637">&#182;</a>
              </div>
              <p>or return the val</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            val
        });

        <span class="keyword">return</span> attrName != <span class="literal">undefined</span> ? where[attrName] : where;
    };
    <span class="keyword">return</span> can.Observe;
})(module[<span class="string">"can/util/jquery/jquery.js"</span>], module[<span class="string">"can/observe/observe.js"</span>]); <span class="comment">// ## can/observe/delegate/delegate.js</span>
module[<span class="string">'can/observe/delegate/delegate.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-638">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-638">&#182;</a>
              </div>
              <p><em>* - &#39;this&#39; will be the deepest item changed
</em> - &#39;this&#39; will be any changes within <em>, but </em> will be the 
    this returned
tells if the parts part of a delegate matches the broken up props of the event
gives the prop to use as &#39;this&#39;
- parts - the attribute name of the delegate split in parts [&#39;foo&#39;,&#39;*&#39;]
- props - the split props of the event that happened [&#39;foo&#39;,&#39;bar&#39;,&#39;0&#39;]
- returns - the attribute to delegate too (&#39;foo.bar&#39;), or null if not a match </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> delegateMatches = <span class="function"><span class="keyword">function</span> <span class="params">(parts, props)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-639">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-639">&#182;</a>
              </div>
              <p>check props parts are the same or </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> len = parts.length,
            i = <span class="number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-640">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-640">&#182;</a>
              </div>
              <p>keeps the matched props we will use</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            matchedProps = [],
            prop;</pre></div></div>
            
        </li>
        
        
        <li id="section-641">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-641">&#182;</a>
              </div>
              <p>if the event matches</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">for</span> (i; i &lt; len; i++) {
            prop = props[i]</pre></div></div>
            
        </li>
        
        
        <li id="section-642">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-642">&#182;</a>
              </div>
              <p>if no more props (but we should be matching them)
return null</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="keyword">typeof</span> prop !== <span class="string">'string'</span>) {
                <span class="keyword">return</span> <span class="literal">null</span>;
            } <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-643">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-643">&#182;</a>
              </div>
              <p>if we have a &quot;**&quot;, match everything</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (parts[i] == <span class="string">"**"</span>) {
                <span class="keyword">return</span> props.join(<span class="string">"."</span>);
            } <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-644">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-644">&#182;</a>
              </div>
              <p>a match, but we want to delegate to &quot;*&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (parts[i] == <span class="string">"*"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-645">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-645">&#182;</a>
              </div>
              <p>only do this if there is nothing after ...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                matchedProps.push(prop);
            }
            <span class="keyword">else</span> <span class="keyword">if</span> (prop === parts[i]) {
                matchedProps.push(prop);
            } <span class="keyword">else</span> {
                <span class="keyword">return</span> <span class="literal">null</span>;
            }
        }
        <span class="keyword">return</span> matchedProps.join(<span class="string">"."</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-646">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-646">&#182;</a>
              </div>
              <p>gets a change event and tries to figure out which
delegates to call</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        delegateHandler = <span class="function"><span class="keyword">function</span> <span class="params">(event, prop, how, newVal, oldVal)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-647">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-647">&#182;</a>
              </div>
              <p>pre-split properties to save some regexp time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> props = prop.split(<span class="string">"."</span>),
                delegates = (<span class="keyword">this</span>._observe_delegates || []).slice(<span class="number">0</span>),
                delegate, attr, matchedAttr, hasMatch, valuesEqual;
            event.attr = prop;
            event.lastAttr = props[props.length - <span class="number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-648">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-648">&#182;</a>
              </div>
              <p>for each delegate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; delegate = delegates[i++];) {</pre></div></div>
            
        </li>
        
        
        <li id="section-649">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-649">&#182;</a>
              </div>
              <p>if there is a batchNum, this means that this
event is part of a series of events caused by a single 
attrs call.  We don&#39;t want to issue the same event
multiple times
setting the batchNum happens later</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> ((event.batchNum &amp;&amp; delegate.batchNum === event.batchNum) || delegate.undelegated) {
                    <span class="keyword">continue</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-650">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-650">&#182;</a>
              </div>
              <p>reset match and values tests</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                hasMatch = <span class="literal">undefined</span>;
                valuesEqual = <span class="literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-651">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-651">&#182;</a>
              </div>
              <p>yeah, all this under here has to be redone v
for each attr in a delegate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">for</span> (<span class="keyword">var</span> a = <span class="number">0</span>; a &lt; delegate.attrs.length; a++) {

                    attr = delegate.attrs[a];</pre></div></div>
            
        </li>
        
        
        <li id="section-652">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-652">&#182;</a>
              </div>
              <p>check if it is a match</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (matchedAttr = delegateMatches(attr.parts, props)) {
                        hasMatch = matchedAttr;
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-653">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-653">&#182;</a>
              </div>
              <p>if it has a value, make sure it&#39;s the right value
if it&#39;s set, we should probably check that it has a 
value no matter what</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (attr.value &amp;&amp; valuesEqual) {
                        valuesEqual = attr.value === <span class="string">""</span> + <span class="keyword">this</span>.attr(attr.attr)
                    } <span class="keyword">else</span> <span class="keyword">if</span> (valuesEqual &amp;&amp; delegate.attrs.length &gt; <span class="number">1</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-654">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-654">&#182;</a>
              </div>
              <p>if there are multiple attributes, each has to at
least have some value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        valuesEqual = <span class="keyword">this</span>.attr(attr.attr) !== <span class="literal">undefined</span>
                    }
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-655">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-655">&#182;</a>
              </div>
              <p>if there is a match and valuesEqual ... call back</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (hasMatch &amp;&amp; valuesEqual) {</pre></div></div>
            
        </li>
        
        
        <li id="section-656">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-656">&#182;</a>
              </div>
              <p>how to get to the changed property from the delegate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> from = prop.replace(hasMatch + <span class="string">"."</span>, <span class="string">""</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-657">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-657">&#182;</a>
              </div>
              <p>if this event is part of a batch, set it on the delegate
to only send one event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (event.batchNum) {
                        delegate.batchNum = event.batchNum
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-658">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-658">&#182;</a>
              </div>
              <p>if we listen to change, fire those with the same attrs
TODO: the attrs should probably be using from</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (delegate.event === <span class="string">'change'</span>) {
                        arguments[<span class="number">1</span>] = from;
                        event.curAttr = hasMatch;
                        delegate.callback.apply(<span class="keyword">this</span>.attr(hasMatch), can.makeArray(arguments));
                    } <span class="keyword">else</span> <span class="keyword">if</span> (delegate.event === how) {</pre></div></div>
            
        </li>
        
        
        <li id="section-659">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-659">&#182;</a>
              </div>
              <p>if it&#39;s a match, callback with the location of the match</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        delegate.callback.apply(<span class="keyword">this</span>.attr(hasMatch), [event, newVal, oldVal, from]);
                    } <span class="keyword">else</span> <span class="keyword">if</span> (delegate.event === <span class="string">'set'</span> &amp;&amp; how == <span class="string">'add'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-660">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-660">&#182;</a>
              </div>
              <p>if we are listening to set, we should also listen to add</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        delegate.callback.apply(<span class="keyword">this</span>.attr(hasMatch), [event, newVal, oldVal, from]);
                    }
                }

            }
        };

    can.extend(can.Observe.prototype, {

        delegate: <span class="function"><span class="keyword">function</span> <span class="params">(selector, event, handler)</span> {</span>
            selector = can.trim(selector);
            <span class="keyword">var</span> delegates = <span class="keyword">this</span>._observe_delegates || (<span class="keyword">this</span>._observe_delegates = []),
                attrs = [],
                selectorRegex = <span class="regexp">/([^\s=,]+)(?:=("[^",]*"|'[^',]*'|[^\s"',]*))?(,?)\s*/g</span>,
                matches;</pre></div></div>
            
        </li>
        
        
        <li id="section-661">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-661">&#182;</a>
              </div>
              <p>parse each property in the selector</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">while</span> (matches = selectorRegex.exec(selector)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-662">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-662">&#182;</a>
              </div>
              <p>we need to do a little doctoring to make up for the quotes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (matches[<span class="number">2</span>] &amp;&amp; $.inArray(matches[<span class="number">2</span>].substr(<span class="number">0</span>, <span class="number">1</span>), [<span class="string">'"'</span>, <span class="string">"'"</span>]) &gt;= <span class="number">0</span>) {
                    matches[<span class="number">2</span>] = matches[<span class="number">2</span>].substr(<span class="number">1</span>, -<span class="number">1</span>);
                }

                attrs.push({</pre></div></div>
            
        </li>
        
        
        <li id="section-663">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-663">&#182;</a>
              </div>
              <p>the attribute name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    attr: matches[<span class="number">1</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-664">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-664">&#182;</a>
              </div>
              <p>the attribute name, pre-split for speed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    parts: matches[<span class="number">1</span>].split(<span class="string">'.'</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-665">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-665">&#182;</a>
              </div>
              <p>the value associated with this property (if there was one given)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    value: matches[<span class="number">2</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-666">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-666">&#182;</a>
              </div>
              <p>whether this selector combines with the one after it with AND or OR</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    or: matches[<span class="number">3</span>] === <span class="string">','</span>
                });
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-667">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-667">&#182;</a>
              </div>
              <p>delegates has pre-processed info about the event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            delegates.push({</pre></div></div>
            
        </li>
        
        
        <li id="section-668">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-668">&#182;</a>
              </div>
              <p>the attrs name for unbinding</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                selector: selector,</pre></div></div>
            
        </li>
        
        
        <li id="section-669">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-669">&#182;</a>
              </div>
              <p>an object of attribute names and values {type: &#39;recipe&#39;,id: undefined}
undefined means a value was not defined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                attrs: attrs,
                callback: handler,
                event: event
            });
            <span class="keyword">if</span> (delegates.length === <span class="number">1</span>) {
                <span class="keyword">this</span>.bind(<span class="string">"change"</span>, delegateHandler)
            }
            <span class="keyword">return</span> <span class="keyword">this</span>;
        },

        undelegate: <span class="function"><span class="keyword">function</span> <span class="params">(selector, event, handler)</span> {</span>
            selector = can.trim(selector);

            <span class="keyword">var</span> i = <span class="number">0</span>,
                delegates = <span class="keyword">this</span>._observe_delegates || [],
                delegateOb;
            <span class="keyword">if</span> (selector) {
                <span class="keyword">while</span> (i &lt; delegates.length) {
                    delegateOb = delegates[i];
                    <span class="keyword">if</span> (delegateOb.callback === handler || (!handler &amp;&amp; delegateOb.selector === selector)) {
                        delegateOb.undelegated = <span class="literal">true</span>;
                        delegates.splice(i, <span class="number">1</span>)
                    } <span class="keyword">else</span> {
                        i++;
                    }
                }
            } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-670">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-670">&#182;</a>
              </div>
              <p>remove all delegates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                delegates = [];
            }
            <span class="keyword">if</span> (!delegates.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-671">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-671">&#182;</a>
              </div>
              <p>can.removeData(this, &quot;_observe_delegates&quot;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">this</span>.unbind(<span class="string">"change"</span>, delegateHandler)
            }
            <span class="keyword">return</span> <span class="keyword">this</span>;
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-672">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-672">&#182;</a>
              </div>
              <p>add helpers for testing .. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    can.Observe.prototype.delegate.matches = delegateMatches;
    <span class="keyword">return</span> can.Observe;
})(module[<span class="string">"can/util/jquery/jquery.js"</span>], module[<span class="string">"can/observe/observe.js"</span>]); <span class="comment">// ## can/observe/setter/setter.js</span>
module[<span class="string">'can/observe/setter/setter.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span>

    can.classize = <span class="function"><span class="keyword">function</span> <span class="params">(s, join)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-673">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-673">&#182;</a>
              </div>
              <p>this can be moved out ..
used for getter setter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> parts = s.split(can.undHash),
            i = <span class="number">0</span>;
        <span class="keyword">for</span> (; i &lt; parts.length; i++) {
            parts[i] = can.capitalize(parts[i]);
        }

        <span class="keyword">return</span> parts.join(join || <span class="string">''</span>);
    }

    <span class="keyword">var</span> classize = can.classize,
        proto = can.Observe.prototype,
        old = proto.__set;

    proto.__set = <span class="function"><span class="keyword">function</span> <span class="params">(prop, value, current, success, error)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-674">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-674">&#182;</a>
              </div>
              <p>check if there&#39;s a setter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> cap = classize(prop),
            setName = <span class="string">"set"</span> + cap,
            errorCallback = <span class="function"><span class="keyword">function</span> <span class="params">(errors)</span> {</span>
                <span class="keyword">var</span> stub = error &amp;&amp; error.call(self, errors);</pre></div></div>
            
        </li>
        
        
        <li id="section-675">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-675">&#182;</a>
              </div>
              <p>if &#39;setter&#39; is on the page it will trigger
the error itself and we dont want to trigger
the event twice. :)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (stub !== <span class="literal">false</span>) {
                    can.trigger(self, <span class="string">"error"</span>, [prop, errors], <span class="literal">true</span>);
                }

                <span class="keyword">return</span> <span class="literal">false</span>;
            },
            self = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-676">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-676">&#182;</a>
              </div>
              <p>if we have a setter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (<span class="keyword">this</span>[setName] &amp;&amp;</pre></div></div>
            
        </li>
        
        
        <li id="section-677">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-677">&#182;</a>
              </div>
              <p>call the setter, if returned value is undefined,
this means the setter is async so we 
do not call update property and return right away</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        (value = <span class="keyword">this</span>[setName](value, <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
            old.call(self, prop, value, current, success, errorCallback)
        }, errorCallback)) === <span class="literal">undefined</span>) {
            <span class="keyword">return</span>;
        }

        old.call(self, prop, value, current, success, errorCallback);

        <span class="keyword">return</span> <span class="keyword">this</span>;
    };
    <span class="keyword">return</span> can.Observe;
})(module[<span class="string">"can/util/jquery/jquery.js"</span>], module[<span class="string">"can/observe/attributes/attributes.js"</span>]); <span class="comment">// ## can/observe/validations/validations.js</span>
module[<span class="string">'can/observe/validations/validations.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-678">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-678">&#182;</a>
              </div>
              <p>validations object is by property.  You can have validations that
span properties, but this way we know which ones to run.
 proc should return true if there&#39;s an error or the error message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> validate = <span class="function"><span class="keyword">function</span> <span class="params">(attrNames, options, proc)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-679">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-679">&#182;</a>
              </div>
              <p>normalize argumetns</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (!proc) {
            proc = options;
            options = {};
        }

        options = options || {};
        attrNames = can.makeArray(attrNames)</pre></div></div>
            
        </li>
        
        
        <li id="section-680">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-680">&#182;</a>
              </div>
              <p>run testIf if it exists</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (options.testIf &amp;&amp; !options.testIf.call(<span class="keyword">this</span>)) {
            <span class="keyword">return</span>;
        }

        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        can.each(attrNames, <span class="function"><span class="keyword">function</span> <span class="params">(attrName)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-681">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-681">&#182;</a>
              </div>
              <p>Add a test function for each attribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (!self.validations[attrName]) {
                self.validations[attrName] = [];
            }

            self.validations[attrName].push(<span class="function"><span class="keyword">function</span> <span class="params">(newVal)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-682">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-682">&#182;</a>
              </div>
              <p>if options has a message return that, otherwise, return the error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> res = proc.call(<span class="keyword">this</span>, newVal, attrName);
                <span class="keyword">return</span> res === <span class="literal">undefined</span> ? <span class="literal">undefined</span> : (options.message || res);
            })
        });
    };

    <span class="keyword">var</span> old = can.Observe.prototype.__set;
    can.Observe.prototype.__set = <span class="function"><span class="keyword">function</span> <span class="params">(prop, value, current, success, error)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>,
            validations = self.constructor.validations,
            errorCallback = <span class="function"><span class="keyword">function</span> <span class="params">(errors)</span> {</span>
                <span class="keyword">var</span> stub = error &amp;&amp; error.call(self, errors);</pre></div></div>
            
        </li>
        
        
        <li id="section-683">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-683">&#182;</a>
              </div>
              <p>if &#39;setter&#39; is on the page it will trigger
the error itself and we dont want to trigger
the event twice. :)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (stub !== <span class="literal">false</span>) {
                    can.trigger(self, <span class="string">"error"</span>, [prop, errors], <span class="literal">true</span>);
                }

                <span class="keyword">return</span> <span class="literal">false</span>;
            };

        old.call(self, prop, value, current, success, errorCallback);

        <span class="keyword">if</span> (validations &amp;&amp; validations[prop]) {
            <span class="keyword">var</span> errors = self.errors(prop);
            errors &amp;&amp; errorCallback(errors)
        }

        <span class="keyword">return</span> <span class="keyword">this</span>;
    }

    can.each([can.Observe, can.Model], <span class="function"><span class="keyword">function</span> <span class="params">(clss)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-684">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-684">&#182;</a>
              </div>
              <p>in some cases model might not be defined quite yet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (clss === <span class="literal">undefined</span>) {
            <span class="keyword">return</span>;
        }
        <span class="keyword">var</span> oldSetup = clss.setup;

        can.extend(clss, {
            setup: <span class="function"><span class="keyword">function</span> <span class="params">(superClass)</span> {</span>
                oldSetup.apply(<span class="keyword">this</span>, arguments);
                <span class="keyword">if</span> (!<span class="keyword">this</span>.validations || superClass.validations === <span class="keyword">this</span>.validations) {
                    <span class="keyword">this</span>.validations = {};
                }
            },

            validate: validate,


            validationMessages: {
                format: <span class="string">"is invalid"</span>,
                inclusion: <span class="string">"is not a valid option (perhaps out of range)"</span>,
                lengthShort: <span class="string">"is too short"</span>,
                lengthLong: <span class="string">"is too long"</span>,
                presence: <span class="string">"can't be empty"</span>,
                range: <span class="string">"is out of range"</span>
            },


            validateFormatOf: <span class="function"><span class="keyword">function</span> <span class="params">(attrNames, regexp, options)</span> {</span>
                validate.call(<span class="keyword">this</span>, attrNames, options, <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
                    <span class="keyword">if</span> ((<span class="keyword">typeof</span> value !== <span class="string">'undefined'</span> &amp;&amp; value !== <span class="literal">null</span> &amp;&amp; value !== <span class="string">''</span>) &amp;&amp; String(value).match(regexp) == <span class="literal">null</span>) {
                        <span class="keyword">return</span> <span class="keyword">this</span>.constructor.validationMessages.format;
                    }
                });
            },


            validateInclusionOf: <span class="function"><span class="keyword">function</span> <span class="params">(attrNames, inArray, options)</span> {</span>
                validate.call(<span class="keyword">this</span>, attrNames, options, <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
                    <span class="keyword">if</span> (<span class="keyword">typeof</span> value == <span class="string">'undefined'</span>) {
                        <span class="keyword">return</span>;
                    }

                    <span class="keyword">if</span> (can.grep(inArray, <span class="function"><span class="keyword">function</span> <span class="params">(elm)</span> {</span>
                        <span class="keyword">return</span> (elm == value);
                    }).length == <span class="number">0</span>) {
                        <span class="keyword">return</span> <span class="keyword">this</span>.constructor.validationMessages.inclusion;
                    }
                });
            },


            validateLengthOf: <span class="function"><span class="keyword">function</span> <span class="params">(attrNames, min, max, options)</span> {</span>
                validate.call(<span class="keyword">this</span>, attrNames, options, <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
                    <span class="keyword">if</span> (((<span class="keyword">typeof</span> value === <span class="string">'undefined'</span> || value === <span class="literal">null</span>) &amp;&amp; min &gt; <span class="number">0</span>) || (<span class="keyword">typeof</span> value !== <span class="string">'undefined'</span> &amp;&amp; value !== <span class="literal">null</span> &amp;&amp; value.length &lt; min)) {
                        <span class="keyword">return</span> <span class="keyword">this</span>.constructor.validationMessages.lengthShort + <span class="string">" (min="</span> + min + <span class="string">")"</span>;
                    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> value != <span class="string">'undefined'</span> &amp;&amp; value !== <span class="literal">null</span> &amp;&amp; value.length &gt; max) {
                        <span class="keyword">return</span> <span class="keyword">this</span>.constructor.validationMessages.lengthLong + <span class="string">" (max="</span> + max + <span class="string">")"</span>;
                    }
                });
            },


            validatePresenceOf: <span class="function"><span class="keyword">function</span> <span class="params">(attrNames, options)</span> {</span>
                validate.call(<span class="keyword">this</span>, attrNames, options, <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
                    <span class="keyword">if</span> (<span class="keyword">typeof</span> value == <span class="string">'undefined'</span> || value === <span class="string">""</span> || value === <span class="literal">null</span>) {
                        <span class="keyword">return</span> <span class="keyword">this</span>.constructor.validationMessages.presence;
                    }
                });
            },


            validateRangeOf: <span class="function"><span class="keyword">function</span> <span class="params">(attrNames, low, hi, options)</span> {</span>
                validate.call(<span class="keyword">this</span>, attrNames, options, <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
                    <span class="keyword">if</span> (((<span class="keyword">typeof</span> value == <span class="string">'undefined'</span> || value === <span class="literal">null</span>) &amp;&amp; low &gt; <span class="number">0</span>) || (<span class="keyword">typeof</span> value !== <span class="string">'undefined'</span> &amp;&amp; value !== <span class="literal">null</span> &amp;&amp; (value &lt; low || value &gt; hi))) {
                        <span class="keyword">return</span> <span class="keyword">this</span>.constructor.validationMessages.range + <span class="string">" ["</span> + low + <span class="string">","</span> + hi + <span class="string">"]"</span>;
                    }
                });
            }
        });
    });

    can.extend(can.Observe.prototype, {

        errors: <span class="function"><span class="keyword">function</span> <span class="params">(attrs, newVal)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-685">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-685">&#182;</a>
              </div>
              <p>convert attrs to an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (attrs) {
                attrs = can.isArray(attrs) ? attrs : [attrs];
            }

            <span class="keyword">var</span> errors = {},
                self = <span class="keyword">this</span>,
                attr,</pre></div></div>
            
        </li>
        
        
        <li id="section-686">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-686">&#182;</a>
              </div>
              <p>helper function that adds error messages to errors object
attr - the name of the attribute
funcs - the validation functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                addErrors = <span class="function"><span class="keyword">function</span> <span class="params">(attr, funcs)</span> {</span>
                    can.each(funcs, <span class="function"><span class="keyword">function</span> <span class="params">(func)</span> {</span>
                        <span class="keyword">var</span> res = func.call(self, isTest ? (self.__convert ? self.__convert(attr, newVal) : newVal) : self[attr]);
                        <span class="keyword">if</span> (res) {
                            <span class="keyword">if</span> (!errors[attr]) {
                                errors[attr] = [];
                            }
                            errors[attr].push(res);
                        }

                    });
                },
                validations = <span class="keyword">this</span>.constructor.validations,
                isTest = attrs &amp;&amp; attrs.length === <span class="number">1</span> &amp;&amp; arguments.length === <span class="number">2</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-687">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-687">&#182;</a>
              </div>
              <p>go through each attribute or validation and
add any errors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            can.each(attrs || validations || {}, <span class="function"><span class="keyword">function</span> <span class="params">(funcs, attr)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-688">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-688">&#182;</a>
              </div>
              <p>if we are iterating through an array, use funcs
as the attr name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (<span class="keyword">typeof</span> attr == <span class="string">'number'</span>) {
                    attr = funcs;
                    funcs = validations[attr];
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-689">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-689">&#182;</a>
              </div>
              <p>add errors to the</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                addErrors(attr, funcs || []);
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-690">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-690">&#182;</a>
              </div>
              <p>return errors as long as we have one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> can.isEmptyObject(errors) ? <span class="literal">null</span> : isTest ? errors[attrs[<span class="number">0</span>]] : errors;
        }
    });
    <span class="keyword">return</span> can.Observe;
})(module[<span class="string">"can/util/jquery/jquery.js"</span>], module[<span class="string">"can/observe/attributes/attributes.js"</span>]); <span class="comment">// ## can/util/string/deparam/deparam.js</span>
module[<span class="string">'can/util/string/deparam/deparam.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-691">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-691">&#182;</a>
              </div>
              <h2>deparam.js</h2>
<p><code>can.deparam</code><br><em>Takes a string of name value pairs and returns a Object literal that represents those params.</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> digitTest = <span class="regexp">/^\d+$/</span>,
        keyBreaker = <span class="regexp">/([^\[\]]+)|(\[\])/g</span>,
        paramTest = <span class="regexp">/([^?#]*)(#.*)?$/</span>,
        prep = <span class="function"><span class="keyword">function</span> <span class="params">(str)</span> {</span>
            <span class="keyword">return</span> decodeURIComponent(str.replace(<span class="regexp">/\+/g</span>, <span class="string">" "</span>));
        };


    can.extend(can, {

        deparam: <span class="function"><span class="keyword">function</span> <span class="params">(params)</span> {</span>

            <span class="keyword">var</span> data = {},
                pairs, lastPart;

            <span class="keyword">if</span> (params &amp;&amp; paramTest.test(params)) {

                pairs = params.split(<span class="string">'&amp;'</span>),

                can.each(pairs, <span class="function"><span class="keyword">function</span> <span class="params">(pair)</span> {</span>

                    <span class="keyword">var</span> parts = pair.split(<span class="string">'='</span>),
                        key = prep(parts.shift()),
                        value = prep(parts.join(<span class="string">"="</span>)),
                        current = data;

                    <span class="keyword">if</span> (key) {
                        parts = key.match(keyBreaker);

                        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>, l = parts.length - <span class="number">1</span>; j &lt; l; j++) {
                            <span class="keyword">if</span> (!current[parts[j]]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-692">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-692">&#182;</a>
              </div>
              <p>If what we are pointing to looks like an <code>array</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                current[parts[j]] = digitTest.test(parts[j + <span class="number">1</span>]) || parts[j + <span class="number">1</span>] == <span class="string">"[]"</span> ? [] : {};
                            }
                            current = current[parts[j]];
                        }
                        lastPart = parts.pop();
                        <span class="keyword">if</span> (lastPart == <span class="string">"[]"</span>) {
                            current.push(value);
                        } <span class="keyword">else</span> {
                            current[lastPart] = value;
                        }
                    }
                });
            }
            <span class="keyword">return</span> data;
        }
    });
    <span class="keyword">return</span> can;
})(module[<span class="string">"can/util/jquery/jquery.js"</span>], module[<span class="string">"can/util/string/string.js"</span>]); <span class="comment">// ## can/route/route.js</span>
module[<span class="string">'can/route/route.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-693">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-693">&#182;</a>
              </div>
              <h2>route.js</h2>
<p><code>can.route</code><br><em>Helps manage browser history (and client state) by synchronizing the 
<code>window.location.hash</code> with a <code>can.Observe</code>.</em><br>Helper methods used for matching routes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span></pre></div></div>
            
        </li>
        
        
        <li id="section-694">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-694">&#182;</a>
              </div>
              <p><code>RegExp</code> used to match route variables of the type &#39;:name&#39;.
Any word character or a period is matched.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    matcher = <span class="regexp">/\:([\w\.]+)/g</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-695">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-695">&#182;</a>
              </div>
              <p>Regular expression for identifying &amp;key=value lists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        paramsMatcher = <span class="regexp">/^(?:&amp;[^=]+=[^&amp;]*)+/</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-696">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-696">&#182;</a>
              </div>
              <p>Converts a JS Object into a list of parameters that can be 
inserted into an html element tag.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        makeProps = <span class="function"><span class="keyword">function</span> <span class="params">(props)</span> {</span>
            <span class="keyword">var</span> tags = [];
            can.each(props, <span class="function"><span class="keyword">function</span> <span class="params">(val, name)</span> {</span>
                tags.push((name === <span class="string">'className'</span> ? <span class="string">'class'</span> : name) + <span class="string">'="'</span> + (name === <span class="string">"href"</span> ? val : can.esc(val)) + <span class="string">'"'</span>);
            });
            <span class="keyword">return</span> tags.join(<span class="string">" "</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-697">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-697">&#182;</a>
              </div>
              <p>Checks if a route matches the data provided. If any route variable
is not present in the data, the route does not match. If all route
variables are present in the data, the number of matches is returned 
to allow discerning between general and more specific routes. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        matchesData = <span class="function"><span class="keyword">function</span> <span class="params">(route, data)</span> {</span>
            <span class="keyword">var</span> count = <span class="number">0</span>,
                i = <span class="number">0</span>,
                defaults = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-698">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-698">&#182;</a>
              </div>
              <p>look at default values, if they match ...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">for</span> (<span class="keyword">var</span> name <span class="keyword">in</span> route.defaults) {
                <span class="keyword">if</span> (route.defaults[name] === data[name]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-699">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-699">&#182;</a>
              </div>
              <p>mark as matched</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    defaults[name] = <span class="number">1</span>;
                    count++;
                }
            }
            <span class="keyword">for</span> (; i &lt; route.names.length; i++) {
                <span class="keyword">if</span> (!data.hasOwnProperty(route.names[i])) {
                    <span class="keyword">return</span> -<span class="number">1</span>;
                }
                <span class="keyword">if</span> (!defaults[route.names[i]]) {
                    count++;
                }

            }

            <span class="keyword">return</span> count;
        },
        onready = !<span class="number">0</span>,
        location = window.location,
        wrapQuote = <span class="function"><span class="keyword">function</span> <span class="params">(str)</span> {</span>
            <span class="keyword">return</span> (str + <span class="string">''</span>).replace(<span class="regexp">/([.?*+\^$\[\]\\(){}|\-])/g</span>, <span class="string">"\\$1"</span>);
        },
        each = can.each,
        extend = can.extend;

    can.route = <span class="function"><span class="keyword">function</span> <span class="params">(url, defaults)</span> {</span>
        defaults = defaults || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-700">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-700">&#182;</a>
              </div>
              <p>Extract the variable names and replace with <code>RegExp</code> that will match
an atual URL with values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> names = [],
            test = url.replace(matcher, <span class="function"><span class="keyword">function</span> <span class="params">(whole, name, i)</span> {</span>
                names.push(name);
                <span class="keyword">var</span> next = <span class="string">"\\"</span> + (url.substr(i + whole.length, <span class="number">1</span>) || can.route._querySeparator);</pre></div></div>
            
        </li>
        
        
        <li id="section-701">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-701">&#182;</a>
              </div>
              <p>a name without a default value HAS to have a value
a name that has a default value can be empty
The <code>\\</code> is for string-escaping giving single <code>\</code> for <code>RegExp</code> escaping.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">return</span> <span class="string">"([^"</span> + next + <span class="string">"]"</span> + (defaults[name] ? <span class="string">"*"</span> : <span class="string">"+"</span>) + <span class="string">")"</span>;
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-702">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-702">&#182;</a>
              </div>
              <p>Add route in a form that can be easily figured out.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        can.route.routes[url] = {</pre></div></div>
            
        </li>
        
        
        <li id="section-703">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-703">&#182;</a>
              </div>
              <p>A regular expression that will match the route when variable values 
are present; i.e. for <code>:page/:type</code> the <code>RegExp</code> is <code>/([\w\.]*)/([\w\.]*)/</code> which
will match for any value of <code>:page</code> and <code>:type</code> (word chars or period).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            test: <span class="keyword">new</span> RegExp(<span class="string">"^"</span> + test + <span class="string">"($|"</span> + wrapQuote(can.route._querySeparator) + <span class="string">")"</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-704">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-704">&#182;</a>
              </div>
              <p>The original URL, same as the index for this entry in routes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            route: url,</pre></div></div>
            
        </li>
        
        
        <li id="section-705">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-705">&#182;</a>
              </div>
              <p>An <code>array</code> of all the variable names in this route.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            names: names,</pre></div></div>
            
        </li>
        
        
        <li id="section-706">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-706">&#182;</a>
              </div>
              <p>Default values provided for the variables.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            defaults: defaults,</pre></div></div>
            
        </li>
        
        
        <li id="section-707">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-707">&#182;</a>
              </div>
              <p>The number of parts in the URL separated by <code>/</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            length: url.split(<span class="string">'/'</span>).length
        };
        <span class="keyword">return</span> can.route;
    };

    extend(can.route, {

        _querySeparator: <span class="string">'&amp;'</span>,
        _paramsMatcher: paramsMatcher,


        param: <span class="function"><span class="keyword">function</span> <span class="params">(data, _setRoute)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-708">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-708">&#182;</a>
              </div>
              <p>Check if the provided data keys match the names in any routes;
Get the one with the most matches.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> route,</pre></div></div>
            
        </li>
        
        
        <li id="section-709">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-709">&#182;</a>
              </div>
              <p>Need to have at least 1 match.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            matches = <span class="number">0</span>,
                matchCount, routeName = data.route,
                propCount = <span class="number">0</span>;

            <span class="keyword">delete</span> data.route;

            each(data, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                propCount++;
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-710">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-710">&#182;</a>
              </div>
              <p>Otherwise find route.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            each(can.route.routes, <span class="function"><span class="keyword">function</span> <span class="params">(temp, name)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-711">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-711">&#182;</a>
              </div>
              <p>best route is the first with all defaults matching</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                matchCount = matchesData(temp, data);
                <span class="keyword">if</span> (matchCount &gt; matches) {
                    route = temp;
                    matches = matchCount;
                }
                <span class="keyword">if</span> (matchCount &gt;= propCount) {
                    <span class="keyword">return</span> <span class="literal">false</span>;
                }
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-712">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-712">&#182;</a>
              </div>
              <p>If we have a route name in our <code>can.route</code> data, and it&#39;s
just as good as what currently matches, use that</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (can.route.routes[routeName] &amp;&amp; matchesData(can.route.routes[routeName], data) === matches) {
                route = can.route.routes[routeName];
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-713">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-713">&#182;</a>
              </div>
              <p>If this is match...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (route) {
                <span class="keyword">var</span> cpy = extend({}, data),</pre></div></div>
            
        </li>
        
        
        <li id="section-714">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-714">&#182;</a>
              </div>
              <p>Create the url by replacing the var names with the provided data.
If the default value is found an empty string is inserted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    res = route.route.replace(matcher, <span class="function"><span class="keyword">function</span> <span class="params">(whole, name)</span> {</span>
                        <span class="keyword">delete</span> cpy[name];
                        <span class="keyword">return</span> data[name] === route.defaults[name] ? <span class="string">""</span> : encodeURIComponent(data[name]);
                    }),
                    after;</pre></div></div>
            
        </li>
        
        
        <li id="section-715">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-715">&#182;</a>
              </div>
              <p>Remove matching default values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                each(route.defaults, <span class="function"><span class="keyword">function</span> <span class="params">(val, name)</span> {</span>
                    <span class="keyword">if</span> (cpy[name] === val) {
                        <span class="keyword">delete</span> cpy[name];
                    }
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-716">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-716">&#182;</a>
              </div>
              <p>The remaining elements of data are added as 
<code>&amp;amp;</code> separated parameters to the url.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                after = can.param(cpy);</pre></div></div>
            
        </li>
        
        
        <li id="section-717">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-717">&#182;</a>
              </div>
              <p>if we are paraming for setting the hash
we also want to make sure the route value is updated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (_setRoute) {
                    can.route.attr(<span class="string">'route'</span>, route.route);
                }
                <span class="keyword">return</span> res + (after ? can.route._querySeparator + after : <span class="string">""</span>);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-718">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-718">&#182;</a>
              </div>
              <p>If no route was found, there is no hash URL, only paramters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> can.isEmptyObject(data) ? <span class="string">""</span> : can.route._querySeparator + can.param(data);
        },

        deparam: <span class="function"><span class="keyword">function</span> <span class="params">(url)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-719">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-719">&#182;</a>
              </div>
              <p>See if the url matches any routes by testing it against the <code>route.test</code> <code>RegExp</code>.
By comparing the URL length the most specialized route that matches is used.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> route = {
                length: -<span class="number">1</span>
            };
            each(can.route.routes, <span class="function"><span class="keyword">function</span> <span class="params">(temp, name)</span> {</span>
                <span class="keyword">if</span> (temp.test.test(url) &amp;&amp; temp.length &gt; route.length) {
                    route = temp;
                }
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-720">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-720">&#182;</a>
              </div>
              <p>If a route was matched.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (route.length &gt; -<span class="number">1</span>) {

                <span class="keyword">var</span> <span class="comment">// Since `RegExp` backreferences are used in `route.test` (parens)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-721">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-721">&#182;</a>
              </div>
              <p>the parts will contain the full matched string and each variable (back-referenced) value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                parts = url.match(route.test),</pre></div></div>
            
        </li>
        
        
        <li id="section-722">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-722">&#182;</a>
              </div>
              <p>Start will contain the full matched string; parts contain the variable values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    start = parts.shift(),</pre></div></div>
            
        </li>
        
        
        <li id="section-723">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-723">&#182;</a>
              </div>
              <p>The remainder will be the <code>&amp;amp;key=value</code> list at the end of the URL.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    remainder = url.substr(start.length - (parts[parts.length - <span class="number">1</span>] === can.route._querySeparator ? <span class="number">1</span> : <span class="number">0</span>)),</pre></div></div>
            
        </li>
        
        
        <li id="section-724">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-724">&#182;</a>
              </div>
              <p>If there is a remainder and it contains a <code>&amp;amp;key=value</code> list deparam it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    obj = (remainder &amp;&amp; can.route._paramsMatcher.test(remainder)) ? can.deparam(remainder.slice(<span class="number">1</span>)) : {};</pre></div></div>
            
        </li>
        
        
        <li id="section-725">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-725">&#182;</a>
              </div>
              <p>Add the default values for this route.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                obj = extend(<span class="literal">true</span>, {}, route.defaults, obj);</pre></div></div>
            
        </li>
        
        
        <li id="section-726">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-726">&#182;</a>
              </div>
              <p>Overwrite each of the default values in <code>obj</code> with those in 
parts if that part is not empty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                each(parts, <span class="function"><span class="keyword">function</span> <span class="params">(part, i)</span> {</span>
                    <span class="keyword">if</span> (part &amp;&amp; part !== can.route._querySeparator) {
                        obj[route.names[i]] = decodeURIComponent(part);
                    }
                });
                obj.route = route.route;
                <span class="keyword">return</span> obj;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-727">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-727">&#182;</a>
              </div>
              <p>If no route was matched, it is parsed as a <code>&amp;amp;key=value</code> list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (url.charAt(<span class="number">0</span>) !== can.route._querySeparator) {
                url = can.route._querySeparator + url;
            }
            <span class="keyword">return</span> can.route._paramsMatcher.test(url) ? can.deparam(url.slice(<span class="number">1</span>)) : {};
        },

        data: <span class="keyword">new</span> can.Observe({}),

        routes: {},

        ready: <span class="function"><span class="keyword">function</span> <span class="params">(val)</span> {</span>
            <span class="keyword">if</span> (val === <span class="literal">false</span>) {
                onready = val;
            }
            <span class="keyword">if</span> (val === <span class="literal">true</span> || onready === <span class="literal">true</span>) {
                can.route._setup();
                setState();
            }
            <span class="keyword">return</span> can.route;
        },

        url: <span class="function"><span class="keyword">function</span> <span class="params">(options, merge)</span> {</span>
            <span class="keyword">if</span> (merge) {
                options = extend({}, curParams, options)
            }
            <span class="keyword">return</span> <span class="string">"#!"</span> + can.route.param(options);
        },

        link: <span class="function"><span class="keyword">function</span> <span class="params">(name, options, props, merge)</span> {</span>
            <span class="keyword">return</span> <span class="string">"&lt;a "</span> + makeProps(
            extend({
                href: can.route.url(options, merge)
            }, props)) + <span class="string">"&gt;"</span> + name + <span class="string">"&lt;/a&gt;"</span>;
        },

        current: <span class="function"><span class="keyword">function</span> <span class="params">(options)</span> {</span>
            <span class="keyword">return</span> location.hash == <span class="string">"#!"</span> + can.route.param(options)
        },
        _setup: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-728">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-728">&#182;</a>
              </div>
              <p>If the hash changes, update the <code>can.route.data</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            can.bind.call(window, <span class="string">'hashchange'</span>, setState);
        },
        _getHash: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">return</span> location.href.split(<span class="regexp">/#!?/</span>)[<span class="number">1</span>] || <span class="string">""</span>;
        },
        _setHash: <span class="function"><span class="keyword">function</span> <span class="params">(serialized)</span> {</span>
            <span class="keyword">var</span> path = (can.route.param(serialized, <span class="literal">true</span>));
            location.hash = <span class="string">"#!"</span> + path;
            <span class="keyword">return</span> path;
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-729">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-729">&#182;</a>
              </div>
              <p>The functions in the following list applied to <code>can.route</code> (e.g. <code>can.route.attr(&#39;...&#39;)</code>) will
instead act on the <code>can.route.data</code> observe.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    each([<span class="string">'bind'</span>, <span class="string">'unbind'</span>, <span class="string">'delegate'</span>, <span class="string">'undelegate'</span>, <span class="string">'attr'</span>, <span class="string">'removeAttr'</span>], <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> {</span>
        can.route[name] = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">return</span> can.route.data[name].apply(can.route.data, arguments)
        }
    })

    <span class="keyword">var</span> <span class="comment">// A ~~throttled~~ debounced function called multiple times will only fire once the</span></pre></div></div>
            
        </li>
        
        
        <li id="section-730">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-730">&#182;</a>
              </div>
              <p>timer runs down. Each call resets the timer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    timer,</pre></div></div>
            
        </li>
        
        
        <li id="section-731">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-731">&#182;</a>
              </div>
              <p>Intermediate storage for <code>can.route.data</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    curParams,</pre></div></div>
            
        </li>
        
        
        <li id="section-732">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-732">&#182;</a>
              </div>
              <p>Deparameterizes the portion of the hash of interest and assign the
values to the <code>can.route.data</code> removing existing values no longer in the hash.
setState is called typically by hashchange which fires asynchronously
So it&#39;s possible that someone started changing the data before the 
hashchange event fired.  For this reason, it will not set the route data
if the data is changing or the hash already matches the hash that was set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setState = can.route.setState = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">var</span> hash = can.route._getHash();
        curParams = can.route.deparam(hash);</pre></div></div>
            
        </li>
        
        
        <li id="section-733">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-733">&#182;</a>
              </div>
              <p>if the hash data is currently changing, or
the hash is what we set it to anyway, do NOT change the hash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (!changingData || hash !== lastHash) {
            can.route.attr(curParams, <span class="literal">true</span>);
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-734">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-734">&#182;</a>
              </div>
              <p>The last hash caused by a data change</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        lastHash,</pre></div></div>
            
        </li>
        
        
        <li id="section-735">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-735">&#182;</a>
              </div>
              <p>Are data changes pending that haven&#39;t yet updated the hash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        changingData;</pre></div></div>
            
        </li>
        
        
        <li id="section-736">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-736">&#182;</a>
              </div>
              <p>If the <code>can.route.data</code> changes, update the hash.
Using <code>.serialize()</code> retrieves the raw data contained in the <code>observable</code>.
This function is <del>throttled</del> debounced so it only updates once even if multiple values changed.
This might be able to use batchNum and avoid this.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    can.route.bind(<span class="string">"change"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(ev, attr)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-737">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-737">&#182;</a>
              </div>
              <p>indicate that data is changing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        changingData = <span class="number">1</span>;
        clearTimeout(timer);
        timer = setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-738">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-738">&#182;</a>
              </div>
              <p>indicate that the hash is set to look like the data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            changingData = <span class="number">0</span>;
            <span class="keyword">var</span> serialized = can.route.data.serialize();

            lastHash = can.route._setHash(serialized);
        }, <span class="number">1</span>);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-739">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-739">&#182;</a>
              </div>
              <p><code>onready</code> event...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    can.bind.call(document, <span class="string">"ready"</span>, can.route.ready);</pre></div></div>
            
        </li>
        
        
        <li id="section-740">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-740">&#182;</a>
              </div>
              <p>Libraries other than jQuery don&#39;t execute the document <code>ready</code> listener
if we are already DOM ready</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> ((document.readyState === <span class="string">'complete'</span> || document.readyState === <span class="string">"interactive"</span>) &amp;&amp; onready) {
        can.route.ready();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-741">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-741">&#182;</a>
              </div>
              <p>extend route to have a similar property 
that is often checked in mustache to determine
an object&#39;s observability</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    can.route.constructor.canMakeObserve = can.Observe.canMakeObserve;

    <span class="keyword">return</span> can.route;
})(module[<span class="string">"can/util/jquery/jquery.js"</span>], module[<span class="string">"can/observe/observe.js"</span>], module[<span class="string">"can/util/string/deparam/deparam.js"</span>]); <span class="comment">// ## can/util/object/object.js</span>
module[<span class="string">'can/util/object/object.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span>

    <span class="keyword">var</span> isArray = can.isArray,</pre></div></div>
            
        </li>
        
        
        <li id="section-742">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-742">&#182;</a>
              </div>
              <p>essentially returns an object that has all the must have comparisons ...
must haves, do not return true when provided undefined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        cleanSet = <span class="function"><span class="keyword">function</span> <span class="params">(obj, compares)</span> {</span>
            <span class="keyword">var</span> copy = can.extend({}, obj);
            <span class="keyword">for</span> (<span class="keyword">var</span> prop <span class="keyword">in</span> copy) {
                <span class="keyword">var</span> compare = compares[prop] === <span class="literal">undefined</span> ? compares[<span class="string">"*"</span>] : compares[prop];
                <span class="keyword">if</span> (same(copy[prop], <span class="literal">undefined</span>, compare)) {
                    <span class="keyword">delete</span> copy[prop]
                }
            }
            <span class="keyword">return</span> copy;
        },
        propCount = <span class="function"><span class="keyword">function</span> <span class="params">(obj)</span> {</span>
            <span class="keyword">var</span> count = <span class="number">0</span>;
            <span class="keyword">for</span> (<span class="keyword">var</span> prop <span class="keyword">in</span> obj) count++;
            <span class="keyword">return</span> count;
        };

    can.Object = {};

    <span class="keyword">var</span> same = can.Object.same = <span class="function"><span class="keyword">function</span> <span class="params">(a, b, compares, aParent, bParent, deep)</span> {</span>
        <span class="keyword">var</span> aType = <span class="keyword">typeof</span> a,
            aArray = isArray(a),
            comparesType = <span class="keyword">typeof</span> compares,
            compare;

        <span class="keyword">if</span> (comparesType == <span class="string">'string'</span> || compares === <span class="literal">null</span>) {
            compares = compareMethods[compares];
            comparesType = <span class="string">'function'</span>
        }
        <span class="keyword">if</span> (comparesType == <span class="string">'function'</span>) {
            <span class="keyword">return</span> compares(a, b, aParent, bParent)
        }
        compares = compares || {};

        <span class="keyword">if</span> (a <span class="keyword">instanceof</span> Date) {
            <span class="keyword">return</span> a === b;
        }
        <span class="keyword">if</span> (deep === -<span class="number">1</span>) {
            <span class="keyword">return</span> aType === <span class="string">'object'</span> || a === b;
        }
        <span class="keyword">if</span> (aType !== <span class="keyword">typeof</span> b || aArray !== isArray(b)) {
            <span class="keyword">return</span> <span class="literal">false</span>;
        }
        <span class="keyword">if</span> (a === b) {
            <span class="keyword">return</span> <span class="literal">true</span>;
        }
        <span class="keyword">if</span> (aArray) {
            <span class="keyword">if</span> (a.length !== b.length) {
                <span class="keyword">return</span> <span class="literal">false</span>;
            }
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; a.length; i++) {
                compare = compares[i] === <span class="literal">undefined</span> ? compares[<span class="string">"*"</span>] : compares[i]
                <span class="keyword">if</span> (!same(a[i], b[i], a, b, compare)) {
                    <span class="keyword">return</span> <span class="literal">false</span>;
                }
            };
            <span class="keyword">return</span> <span class="literal">true</span>;
        } <span class="keyword">else</span> <span class="keyword">if</span> (aType === <span class="string">"object"</span> || aType === <span class="string">'function'</span>) {
            <span class="keyword">var</span> bCopy = can.extend({}, b);
            <span class="keyword">for</span> (<span class="keyword">var</span> prop <span class="keyword">in</span> a) {
                compare = compares[prop] === <span class="literal">undefined</span> ? compares[<span class="string">"*"</span>] : compares[prop];
                <span class="keyword">if</span> (!same(a[prop], b[prop], compare, a, b, deep === <span class="literal">false</span> ? -<span class="number">1</span> : <span class="literal">undefined</span>)) {
                    <span class="keyword">return</span> <span class="literal">false</span>;
                }
                <span class="keyword">delete</span> bCopy[prop];
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-743">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-743">&#182;</a>
              </div>
              <p>go through bCopy props ... if there is no compare .. return false</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">for</span> (prop <span class="keyword">in</span> bCopy) {
                <span class="keyword">if</span> (compares[prop] === <span class="literal">undefined</span> || !same(<span class="literal">undefined</span>, b[prop], compares[prop], a, b, deep === <span class="literal">false</span> ? -<span class="number">1</span> : <span class="literal">undefined</span>)) {
                    <span class="keyword">return</span> <span class="literal">false</span>;
                }
            }
            <span class="keyword">return</span> <span class="literal">true</span>;
        }
        <span class="keyword">return</span> <span class="literal">false</span>;
    };

    can.Object.subsets = <span class="function"><span class="keyword">function</span> <span class="params">(checkSet, sets, compares)</span> {</span>
        <span class="keyword">var</span> len = sets.length,
            subsets = [],
            checkPropCount = propCount(checkSet),
            setLength;

        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-744">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-744">&#182;</a>
              </div>
              <p>check this subset</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> set = sets[i];
            <span class="keyword">if</span> (can.Object.subset(checkSet, set, compares)) {
                subsets.push(set)
            }
        }
        <span class="keyword">return</span> subsets;
    };

    can.Object.subset = <span class="function"><span class="keyword">function</span> <span class="params">(subset, set, compares)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-745">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-745">&#182;</a>
              </div>
              <p>go through set {type: &#39;folder&#39;} and make sure every property
is in subset {type: &#39;folder&#39;, parentId :5}
then make sure that set has fewer properties
make sure we are only checking &#39;important&#39; properties
in subset (ones that have to have a value)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> setPropCount = <span class="number">0</span>,
            compares = compares || {};

        <span class="keyword">for</span> (<span class="keyword">var</span> prop <span class="keyword">in</span> set) {

            <span class="keyword">if</span> (!same(subset[prop], set[prop], compares[prop], subset, set)) {
                <span class="keyword">return</span> <span class="literal">false</span>;
            }
        }
        <span class="keyword">return</span> <span class="literal">true</span>;
    }

    <span class="keyword">var</span> compareMethods = {
        <span class="string">"null"</span>: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">return</span> <span class="literal">true</span>;
        },
        i: <span class="function"><span class="keyword">function</span> <span class="params">(a, b)</span> {</span>
            <span class="keyword">return</span> (<span class="string">""</span> + a).toLowerCase() == (<span class="string">""</span> + b).toLowerCase()
        }
    }

    <span class="keyword">return</span> can.Object;

})(module[<span class="string">"can/util/jquery/jquery.js"</span>]); <span class="comment">// ## can/observe/backup/backup.js</span>
module[<span class="string">'can/observe/backup/backup.js'</span>] = (<span class="function"><span class="keyword">function</span> <span class="params">(can)</span> {</span>
    <span class="keyword">var</span> flatProps = <span class="function"><span class="keyword">function</span> <span class="params">(a)</span> {</span>
        <span class="keyword">var</span> obj = {};
        <span class="keyword">for</span> (<span class="keyword">var</span> prop <span class="keyword">in</span> a) {
            <span class="keyword">if</span> (<span class="keyword">typeof</span> a[prop] !== <span class="string">'object'</span> || a[prop] === <span class="literal">null</span> || a[prop] <span class="keyword">instanceof</span> Date) {
                obj[prop] = a[prop]
            }
        }
        <span class="keyword">return</span> obj;
    };

    can.extend(can.Observe.prototype, {


        backup: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">this</span>._backupStore = <span class="keyword">this</span>._attrs();
            <span class="keyword">return</span> <span class="keyword">this</span>;
        },


        isDirty: <span class="function"><span class="keyword">function</span> <span class="params">(checkAssociations)</span> {</span>
            <span class="keyword">return</span> <span class="keyword">this</span>._backupStore &amp;&amp; !can.Object.same(<span class="keyword">this</span>._attrs(), <span class="keyword">this</span>._backupStore, <span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">undefined</span>, !! checkAssociations);
        },


        restore: <span class="function"><span class="keyword">function</span> <span class="params">(restoreAssociations)</span> {</span>
            <span class="keyword">var</span> props = restoreAssociations ? <span class="keyword">this</span>._backupStore : flatProps(<span class="keyword">this</span>._backupStore)

            <span class="keyword">if</span> (<span class="keyword">this</span>.isDirty(restoreAssociations)) {
                <span class="keyword">this</span>._attrs(props);
            }

            <span class="keyword">return</span> <span class="keyword">this</span>;
        }

    })

    <span class="keyword">return</span> can.Observe;
})(module[<span class="string">"can/util/jquery/jquery.js"</span>], module[<span class="string">"can/observe/observe.js"</span>], module[<span class="string">"can/util/object/object.js"</span>]);

window.define = module._define;

window.module = module._orig;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
